<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tabela PSE</title>
<link rel="stylesheet" href="estatisticas.css">
<style>
  /* Add any specific styles for pseverdados.html here if needed */
  .btn-save, .btn-clear {
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    margin-left: 5px;
  }
  .btn-save { background: #2980b9; color: #fff; }
  .btn-save:hover { background: #3498db; }
  .btn-clear { background: #e74c3c; color: #fff; }
  .btn-clear:hover { background: #c0392b; }
  .pse-input {
    width: 60px;
    padding: 4px;
    border: 1px solid #ccc;
    border-radius: 3px;
    text-align: center;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Tabela de Dados PSE</h1>

  <div class="responsive">
    <table id="pseTable" class="part-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module" src="firebase-data.js"></script>
<script>
import {
  FB_PATHS_GAME,
  initializeFirebase,
  setFirebaseData,
  getFirebaseData,
  onFirebaseDataChange,
  getActiveGameId,
  setActiveGameId
} from './firebase-data.js';

const pseDescriptions = {
  1:'Muito leve', 2:'Leve', 3:'Leve', 4:'Moderado', 5:'Moderado', 6:'Moderado',
  7:'Vigoroso', 8:'Vigoroso', 9:'Muito dif√≠cil', 10:'Esfor√ßo m√°ximo'
};

const pseColors = {
  1:'#6699FF', 2:'#ADD8E6', 3:'#ADD8E6', 4:'#4CAF50', 5:'#4CAF50', 6:'#4CAF50',
  7:'#FFD700', 8:'#FFD700', 9:'#FFA500', 10:'#FF0000'
};

const pseEmojis = {
  1:'üò¥', 2:'üôÇ', 3:'üôÇ', 4:'üòê', 5:'üòê', 6:'üòê',
  7:'üòÖ', 8:'üòÖ', 9:'üò´', 10:'üíÄ'
};

function getPseColor(value) {
  return pseColors[value] || '#ffffff';
}

async function loadTable() {
  const activeGame = getActiveGameId();
  if (!activeGame) {
    console.warn("No active game to load PSE data for.");
    return;
  }

  const savedPSEData = await getFirebaseData(FB_PATHS_GAME.pseData);
  const pseData = savedPSEData ? savedPSEData.entries || [] : [];
  const table = document.getElementById("pseTable");

  if(!pseData.length){
    table.innerHTML = "<thead><tr><th>Atleta</th><th>PSE</th><th>Data/Hora</th><th>A√ß√µes</th></tr></thead><tbody><tr><td colspan='4'>Nenhum dado registado para este jogo.</td></tr></tbody>";
    return;
  }

  pseData.sort((a,b)=>a.name.localeCompare(b.name));

  let thead = `<tr>
    <th>Atleta</th>
    <th>PSE</th>
    <th>Data/Hora</th>
    <th>A√ß√µes</th>
  </tr>`;

  let tbody = pseData.map((item, index)=>{
    const date = new Date(item.datetime);
    const color = getPseColor(item.pse);
    const emoji = pseEmojis[item.pse];
    return `<tr>
      <td>${item.name}</td>
      <td class="emoji" id="pse-${index}" style="background:${color}">${emoji} ${item.pse}</td>
      <td>${date.toLocaleString('pt-BR', { dateStyle:'short', timeStyle:'short' })}</td>
      <td>
        <button class="btn-save" id="btn-${index}" onclick="editEntry(${index})">Editar</button>
        <button class="btn-clear" onclick="deleteEntry(${index})">Apagar</button>
      </td>
    </tr>`;
  }).join('');

  table.querySelector('thead').innerHTML = thead;
  table.querySelector('tbody').innerHTML = tbody;
}

async function editEntry(index) {
  const activeGame = getActiveGameId();
  if (!activeGame) {
    alert("Nenhum jogo ativo. Por favor, selecione ou crie um jogo em 'Configurar Jogo'.");
    return;
  }

  const savedPSEData = await getFirebaseData(FB_PATHS_GAME.pseData);
  const pseData = savedPSEData ? savedPSEData.entries || [] : [];
  const cell = document.getElementById(`pse-${index}`);
  const btn = document.getElementById(`btn-${index}`);

  const currentValue = pseData[index].pse;
  cell.innerHTML = `<input type="number" min="1" max="10" value="${currentValue}" class="pse-input" style="width:50px;text-align:center;">`;
  const input = cell.querySelector('input');
  input.focus();

  btn.textContent = "Salvar";
  btn.onclick = () => saveEntry(index, input.value);

  input.addEventListener('keydown', (e) => {
    if(e.key === "Enter") saveEntry(index, input.value);
    if(e.key === "Escape") loadTable();
  });
}

async function saveEntry(index, value) {
  const activeGame = getActiveGameId();
  if (!activeGame) {
    alert("Nenhum jogo ativo. Por favor, selecione ou crie um jogo em 'Configurar Jogo'.");
    return;
  }

  const savedPSEData = await getFirebaseData(FB_PATHS_GAME.pseData);
  const pseData = savedPSEData ? savedPSEData.entries || [] : [];
  const val = parseInt(value);
  if(isNaN(val) || val < 1 || val > 10) { alert("Valor inv√°lido!"); return; }
  pseData[index].pse = val;
  await setFirebaseData(FB_PATHS_GAME.pseData, { entries: pseData });
  loadTable();
}

async function deleteEntry(index) {
  const activeGame = getActiveGameId();
  if (!activeGame) {
    alert("Nenhum jogo ativo. Por favor, selecione ou crie um jogo em 'Configurar Jogo'.");
    return;
  }

  if(!confirm("Apagar este registo?")) return;
  const savedPSEData = await getFirebaseData(FB_PATHS_GAME.pseData);
  const pseData = savedPSEData ? savedPSEData.entries || [] : [];
  pseData.splice(index,1);
  await setFirebaseData(FB_PATHS_GAME.pseData, { entries: pseData });
  loadTable();
}

// Initializer
document.addEventListener('DOMContentLoaded', async () => {
  await initializeFirebase(); // Ensures auth & migration

  const activeGame = getActiveGameId();
  if (!activeGame) {
    alert("Nenhum jogo ativo. Por favor, selecione ou crie um jogo em 'Configurar Jogo'.");
    window.location.href = 'configjogoequipa.html';
    return;
  }
  loadTable();
});

// Real-time listener
onFirebaseDataChange(FB_PATHS_GAME.pseData, loadTable);
</script>

<footer>¬© 2025 Team Pro Stats ¬∑ Powered by RP Technology</footer>
</body>
</html>