<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tabela PSE</title>
<style>
  /* ... (your existing styles) ... */
</style>
</head>
<body>

<div class="container">
  <h1>Tabela de Dados PSE</h1>

  <div class="responsive">
    <table id="pseTable" class="part-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module" src="firebase-data.js"></script>
<script>
const pseDescriptions = {
  1:'Muito leve', 2:'Leve', 3:'Leve', 4:'Moderado', 5:'Moderado', 6:'Moderado',
  7:'Vigoroso', 8:'Vigoroso', 9:'Muito difÃ­cil', 10:'EsforÃ§o mÃ¡ximo'
};

const pseColors = {
  1:'#6699FF', 2:'#ADD8E6', 3:'#ADD8E6', 4:'#4CAF50', 5:'#4CAF50', 6:'#4CAF50',
  7:'#FFD700', 8:'#FFD700', 9:'#FFA500', 10:'#FF0000'
};

const pseEmojis = {
  1:'ğŸ˜´', 2:'ğŸ™‚', 3:'ğŸ™‚', 4:'ğŸ˜', 5:'ğŸ˜', 6:'ğŸ˜',
  7:'ğŸ˜…', 8:'ğŸ˜…', 9:'ğŸ˜«', 10:'ğŸ’€'
};

function getPseColor(value) {
  return pseColors[value] || '#ffffff';
}

async function loadTable() {
  const savedPSEData = await getFirebaseData(FB_PATHS.pseData); // Get from Firebase
  const pseData = savedPSEData ? savedPSEData.entries || [] : [];
  const table = document.getElementById("pseTable");

  if(!pseData.length){
    table.innerHTML = "<thead><tr><th>Atleta</th><th>PSE</th><th>Data/Hora</th><th>AÃ§Ãµes</th></tr></thead><tbody><tr><td colspan='4'>Nenhum dado registado.</td></tr></tbody>";
    return;
  }

  pseData.sort((a,b)=>a.name.localeCompare(b.name));

  let thead = `<tr>
    <th>Atleta</th>
    <th>PSE</th>
    <th>Data/Hora</th>
    <th>AÃ§Ãµes</th>
  </tr>`;

  let tbody = pseData.map((item, index)=>{
    const date = new Date(item.datetime);
    const color = getPseColor(item.pse);
    const emoji = pseEmojis[item.pse];
    return `<tr>
      <td>${item.name}</td>
      <td class="emoji" id="pse-${index}" style="background:${color}">${emoji} ${item.pse}</td>
      <td>${date.toLocaleString('pt-BR', { dateStyle:'short', timeStyle:'short' })}</td>
      <td>
        <button class="btn-save" id="btn-${index}" onclick="editEntry(${index})">Editar</button>
        <button class="btn-clear" onclick="deleteEntry(${index})">Apagar</button>
      </td>
    </tr>`;
  }).join('');

  table.querySelector('thead').innerHTML = thead;
  table.querySelector('tbody').innerHTML = tbody;
}

async function editEntry(index) {
  const savedPSEData = await getFirebaseData(FB_PATHS.pseData);
  const pseData = savedPSEData ? savedPSEData.entries || [] : [];
  const cell = document.getElementById(`pse-${index}`);
  const btn = document.getElementById(`btn-${index}`);

  const currentValue = pseData[index].pse;
  cell.innerHTML = `<input type="number" min="1" max="10" value="${currentValue}" class="pse-input" style="width:50px;text-align:center;">`;
  const input = cell.querySelector('input');
  input.focus();

  btn.textContent = "Salvar";
  btn.onclick = () => saveEntry(index, input.value);

  input.addEventListener('keydown', (e) => {
    if(e.key === "Enter") saveEntry(index, input.value);
    if(e.key === "Escape") loadTable();
  });
}

async function saveEntry(index, value) {
  const savedPSEData = await getFirebaseData(FB_PATHS.pseData);
  const pseData = savedPSEData ? savedPSEData.entries || [] : [];
  const val = parseInt(value);
  if(isNaN(val) || val < 1 || val > 10) { alert("Valor invÃ¡lido!"); return; }
  pseData[index].pse = val;
  // pseData[index].desc = pseDescriptions[val]; // optional, kept internally
  await setFirebaseData(FB_PATHS.pseData, { entries: pseData }); // Save to Firebase
  loadTable();
}

async function deleteEntry(index) {
  if(!confirm("Apagar este registo?")) return;
  const savedPSEData = await getFirebaseData(FB_PATHS.pseData);
  const pseData = savedPSEData ? savedPSEData.entries || [] : [];
  pseData.splice(index,1);
  await setFirebaseData(FB_PATHS.pseData, { entries: pseData }); // Save to Firebase
  loadTable();
}

// Initial load and real-time listener
window.addEventListener('load', loadTable);
onFirebaseDataChange(FB_PATHS.pseData, loadTable);

</script>

<footer>Â© 2025 Team Pro Stats Â· Powered by RP Technology</footer>
</body>
</html>