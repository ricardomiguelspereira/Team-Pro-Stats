<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Detalhes Estatísticas por Jogador</title>
<link rel="stylesheet" href="estatisticas.css">
<style>
  /* Add any specific styles for displayestatisticas.html here if needed */
</style>
</head>
<body>

<div class="container">
  <h1>Detalhes Estatísticas por Jogador</h1>

  <div class="tabs">
    <button id="totaisStats" class="nav-btn">Totais Equipa</button>
    <button id="backStats" class="nav-btn">Estatísticas Principais</button>
    <button id="extraTime" class="nav-btn">Estatísticas Prolongamento</button>
  </div>

  <div class="responsive">
    <h3>Jogadores de Campo - 1ª Parte (Jogo Normal)</h3>
    <table id="campo_main1" class="part-table"><thead></thead><tbody></tbody></table>
  </div>

  <div class="responsive">
    <h3>Jogadores de Campo - 2ª Parte (Jogo Normal)</h3>
    <table id="campo_main2" class="part-table"><thead></thead><tbody></tbody></table>
  </div>

  <div class="responsive">
    <h3>Guarda-Redes - 1ª Parte (Jogo Normal)</h3>
    <table id="gr_main1" class="part-table"><thead></thead><tbody></tbody></table>
  </div>

  <div class="responsive">
    <h3>Guarda-Redes - 2ª Parte (Jogo Normal)</h3>
    <table id="gr_main2" class="part-table"><thead></thead><tbody></tbody></table>
  </div>

  <div class="responsive">
    <h3>Jogadores de Campo - 1ª Parte (Prolongamento)</h3>
    <table id="campo_extra1" class="part-table"><thead></thead><tbody></tbody></table>
  </div>

  <div class="responsive">
    <h3>Jogadores de Campo - 2ª Parte (Prolongamento)</h3>
    <table id="campo_extra2" class="part-table"><thead></thead><tbody></tbody></table>
  </div>

  <div class="responsive">
    <h3>Guarda-Redes - 1ª Parte (Prolongamento)</h3>
    <table id="gr_extra1" class="part-table"><thead></thead><tbody></tbody></table>
  </div>

  <div class="responsive">
    <h3>Guarda-Redes - 2ª Parte (Prolongamento)</h3>
    <table id="gr_extra2" class="part-table"><thead></thead><tbody></tbody></table>
  </div>
</div>

<script type="module" src="firebase-data.js"></script>
<script src="estatisticas.js"></script> <!-- This file is still used for shared constants and init logic -->
<script>
import {
  FB_PATHS_GLOBAL,
  FB_PATHS_GAME,
  initializeFirebase,
  getFirebaseData,
  onFirebaseDataChange,
  getActiveGameId,
  setActiveGameId
} from './firebase-data.js';

const STORAGE_KEY_ET = FB_PATHS_GAME.estatisticasExtraTime; // From extra-time.html

// Navigation buttons
document.getElementById('backStats').addEventListener('click', () => {
  window.location.href = 'estatisticas.html';
});
document.getElementById('totaisStats').addEventListener('click', () => {
  window.location.href = 'totais.html';
});
document.getElementById('extraTime').addEventListener('click', () => {
  window.location.href = 'extra-time.html';
});

// Build table header dynamically using shared constants from estatisticas.js
function buildTableHeader(tableId, keys, labels) {
  const table = document.getElementById(tableId);
  const thead = table.querySelector("thead");
  let header = "<tr><th>#</th><th>Nome</th>";
  keys.forEach(key => {
    header += `<th>${labels[key]}</th>`;
  });
  header += "</tr>";
  thead.innerHTML = header;
}

// Fill table rows with data
function fillTable(tableId, playerArray, statArray, keys, timePeriod, half) {
  const tbody = document.getElementById(tableId).querySelector("tbody");
  tbody.innerHTML = "";
  if (!playerArray || playerArray.length === 0) return;

  const suffix = timePeriod === 'main' ? half : 'ET' + half;

  // Ensure statArray matches playerArray length (pad with empty objects)
  const paddedStats = Array(playerArray.length).fill().map((_, i) => statArray[i] || {});

  playerArray.forEach((player, idx) => {
    const playerStats = paddedStats[idx];
    let row = `<tr><td>${player.id}</td><td>${player.name || ''}</td>`;
    keys.forEach(statKey => {
      const key = statKey + suffix;
      const value = playerStats[key] !== undefined ? playerStats[key] : (player[key] !== undefined ? player[key] : 0);
      row += `<td>${value}</td>`;
    });
    row += "</tr>";
  });
}

async function loadStats() {
  const activeGame = getActiveGameId();
  if (!activeGame) {
    alert("Nenhum jogo ativo. Por favor, selecione ou crie um jogo em 'Configurar Jogo'.");
    window.location.href = 'configjogoequipa.html';
    return;
  }

  // Initialize from estatisticas.js to populate playersCampo, playersGR, and statsData
  // Note: 'init()' from estatisticas.js now uses FB_PATHS_GAME for statsData
  if (typeof init === 'function') await init();

  // Load extra time data from Firebase for the active game
  const extraData = await getFirebaseData(STORAGE_KEY_ET) || {};
  const extraCampo = extraData.campo || [];
  const extraGR = extraData.gr || [];

  // playersCampo and playersGR are already filtered by estatisticas: true in estatisticas.js
  const campoPlayers = window.playersCampo || []; // Access global from estatisticas.js
  const grPlayers = window.playersGR || []; // Access global from estatisticas.js

  // Build headers using shared constants from estatisticas.js
  buildTableHeader("campo_main1", window.STAT_KEYS_CAMPO, window.LABELS);
  buildTableHeader("campo_main2", window.STAT_KEYS_CAMPO, window.LABELS);
  buildTableHeader("gr_main1", window.STAT_KEYS_GR, window.LABELS);
  buildTableHeader("gr_main2", window.STAT_KEYS_GR, window.LABELS);
  buildTableHeader("campo_extra1", window.STAT_KEYS_CAMPO, window.LABELS);
  buildTableHeader("campo_extra2", window.STAT_KEYS_CAMPO, window.LABELS);
  buildTableHeader("gr_extra1", window.STAT_KEYS_GR, window.LABELS);
  buildTableHeader("gr_extra2", window.STAT_KEYS_GR, window.LABELS);

  // Fill main time tables: use playersCampo/GR for both players and stats (they contain the normal time values)
  fillTable("campo_main1", campoPlayers, campoPlayers, window.STAT_KEYS_CAMPO, 'main', '1');
  fillTable("campo_main2", campoPlayers, campoPlayers, window.STAT_KEYS_CAMPO, 'main', '2');
  fillTable("gr_main1", grPlayers, grPlayers, window.STAT_KEYS_GR, 'main', '1');
  fillTable("gr_main2", grPlayers, grPlayers, window.STAT_KEYS_GR, 'main', '2');

  // Fill extra time tables: use playersCampo/GR for names/numbers, extraCampo/extraGR for stats (by index)
  fillTable("campo_extra1", campoPlayers, extraCampo, window.STAT_KEYS_CAMPO, 'extra', '1');
  fillTable("campo_extra2", campoPlayers, extraCampo, window.STAT_KEYS_CAMPO, 'extra', '2');
  fillTable("gr_extra1", grPlayers, extraGR, window.STAT_KEYS_GR, 'extra', '1');
  fillTable("gr_extra2", grPlayers, extraGR, window.STAT_KEYS_GR, 'extra', '2');
}

// Initializer
document.addEventListener('DOMContentLoaded', async () => {
  await initializeFirebase(); // Ensures auth & migration
  await loadStats();
});

// On storage change: reload from estatisticas.js logic, then stats (mirrors estatisticas.js storage listener)
onFirebaseDataChange(FB_PATHS_GLOBAL.fieldPlayers, loadStats);
onFirebaseDataChange(FB_PATHS_GLOBAL.goalKeepers, loadStats);
onFirebaseDataChange(FB_PATHS_GAME.estatisticasValores, loadStats);
onFirebaseDataChange(STORAGE_KEY_ET, loadStats);
</script>

<footer>© 2025 Team Pro Stats · Powered by RP Technology</footer>
</body>
</html>