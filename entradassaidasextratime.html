<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entradas / Saídas Prolongamento</title>
<link rel="stylesheet" href="estatisticas.css" />
<style>
  /* ... (your existing styles) ... */
</style>
</head>
<body>

<div class="header-container">
  <h2>Entradas / Saídas Prolongamento</h2>
</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="inOutPart1" type="button">1ª Parte</button>
  <button class="tab-btn" data-tab="inOutPart2" type="button">2ª Parte</button>
  <button id="openExtraTime" class="nav-btn" type="button">Estatísticas Prolongamento</button>
</div>

<div id="inOutPart1" class="tab-content active">
  <div id="scrollContainer1" class="responsive-inout">
    <table id="tableInOut1" class="part-table-inout">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="inOutPart2" class="tab-content">
  <div id="scrollContainer2" class="responsive-inout">
    <table id="tableInOut2" class="part-table-inout">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="lastSaved" style="font-size:10px;margin-top:10px;text-align:center;"></div>
<div class="notification" id="notification"></div>

<script type="module" src="firebase-data.js"></script>
<script>
const fixedIntervals = ["5","4'30","4","3'30","3","2'30","2","1'30","1","30"];
const STORAGE_KEY_EXTRA = FB_PATHS.estatisticasSeparadasExtra; // Use Firebase path
const SCROLL_KEY_PREFIX = 'scrollPos_extra_'; // Still using localStorage for UI state

// Init extra data storage (now handled by Firebase, but ensure structure)
// Removed localStorage.setItem for initial structure, Firebase will create on first save.

// ---------- Fetch players in real-time ----------
async function getPlayers(){
  const fieldPlayersData = await getFirebaseData(FB_PATHS.fieldPlayers);
  const goalKeepersData = await getFirebaseData(FB_PATHS.goalKeepers);

  const fieldPlayers = fieldPlayersData ? fieldPlayersData.players : [];
  const goalKeepers = goalKeepersData ? goalKeepersData.players : [];

  const fieldWithStats = fieldPlayers.filter(p=>p.estatisticas);
  const goalWithStats = goalKeepers.filter(p=>p.estatisticas);
  return [...fieldWithStats, ...goalWithStats].map(p=>({id:p.numero,name:p.nome}));
}

// ---------- Render ----------
async function renderInOut(){
  const allPlayers = await getPlayers();
  const extraData = await getFirebaseData(STORAGE_KEY_EXTRA) || {inOut:{}, lastSaved:''}; // Get from Firebase

  function buildTableHeader(table, intervals){
    const theadTr = table.querySelector('thead tr');
    theadTr.innerHTML = '<th>#</th><th>Nome</th>';
    intervals.forEach(iv=>{ const th=document.createElement('th'); th.textContent=iv; theadTr.appendChild(th); });
  }

  function makeCellInteractive(td,key){
    let isScrolling = false;
    let startX;
    td.addEventListener('touchstart', e => { startX = e.touches[0].clientX; isScrolling = false; }, {passive:true});
    td.addEventListener('touchmove', e => { if(Math.abs(e.touches[0].clientX - startX) > 5) isScrolling = true; }, {passive:true});
    td.addEventListener('click', toggleState);
    td.addEventListener('touchend', e => { if(!isScrolling) toggleState(e); });

    async function toggleState(e){ // Make event listener async
      e.preventDefault();
      let state = td.dataset.state||'';
      if(state==='') state='E'; else if(state==='E') state='S'; else state='';
      td.dataset.state = state;
      td.textContent = state;
      td.style.backgroundColor = state==='E'?'green':state==='S'?'orange':'';
      td.style.color = state?'white':'';
      extraData.inOut[key] = state;
      extraData.lastSaved = new Date().toLocaleString();
      await setFirebaseData(STORAGE_KEY_EXTRA, extraData); // Save to Firebase
      document.getElementById('lastSaved').textContent = `Última gravação: ${extraData.lastSaved}`;
    }
  }

  function buildTableBody(table, intervals, partPrefix){
    const tbody = table.querySelector('tbody'); tbody.innerHTML='';
    allPlayers.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML=`<td>${p.id||''}</td><td>${p.name||''}</td>`;
      intervals.forEach(iv=>{
        const td=document.createElement('td');
        const key=`tableInOut${partPrefix}_${p.id}_${iv}`;
        td.dataset.state = extraData.inOut[key] || '';
        td.textContent = td.dataset.state;
        if(td.dataset.state==='E'){ td.style.backgroundColor='green'; td.style.color='white'; }
        else if(td.dataset.state==='S'){ td.style.backgroundColor='orange'; td.style.color='white'; }
        makeCellInteractive(td,key);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  buildTableHeader(document.getElementById('tableInOut1'), fixedIntervals);
  buildTableBody(document.getElementById('tableInOut1'), fixedIntervals, '1');
  buildTableHeader(document.getElementById('tableInOut2'), fixedIntervals);
  buildTableBody(document.getElementById('tableInOut2'), fixedIntervals, '2');

  // Restore scroll
  document.getElementById('scrollContainer1').scrollLeft = localStorage.getItem(SCROLL_KEY_PREFIX+'1') || 0;
  document.getElementById('scrollContainer2').scrollLeft = localStorage.getItem(SCROLL_KEY_PREFIX+'2') || 0;
  document.getElementById('lastSaved').textContent = extraData.lastSaved ? `Última gravação: ${extraData.lastSaved}` : '';
  document.getElementById('notification').textContent='';
}

// Save scroll positions
['scrollContainer1','scrollContainer2'].forEach(id=>{
  const container = document.getElementById(id);
  container.addEventListener('scroll', e=>{
    localStorage.setItem(SCROLL_KEY_PREFIX+id.slice(-1), e.target.scrollLeft); // Still using localStorage for UI state
  });
});

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
    localStorage.setItem('activeInOutTab_extra', btn.dataset.tab); // Still using localStorage for UI state
  });
});

// Open extra-time page
document.getElementById('openExtraTime').addEventListener('click',()=>{
  const currentTab = document.querySelector('.tab-btn.active').dataset.tab;
  localStorage.setItem('activeInOutTab_extra', currentTab); // Still using localStorage for UI state
  window.location.href='extra-time.html';
});

// Real-time sync when names or numbers update
onFirebaseDataChange(FB_PATHS.fieldPlayers, renderInOut);
onFirebaseDataChange(FB_PATHS.goalKeepers, renderInOut);
onFirebaseDataChange(STORAGE_KEY_EXTRA, renderInOut); // Listen for changes to extra-time in/out data

// Initial render
window.addEventListener('load', async ()=>{
  const savedTab = localStorage.getItem('activeInOutTab_extra'); // Still using localStorage for UI state
  if(savedTab){
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    const btn = document.querySelector(`.tab-btn[data-tab="${savedTab}"]`);
    if(btn){ btn.classList.add('active'); document.getElementById(savedTab).classList.add('active'); }
  }
  await renderInOut();
});
</script>

<footer>© 2025 Team Pro Stats · Powered by RP Technology</footer>
</body>
</html>