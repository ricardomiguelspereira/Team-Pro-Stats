<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estatísticas | Prolongamento</title>
<style>
body { font-family:"Segoe UI", Tahoma, sans-serif; background:#e0e0e0; color:#333; margin:0; padding:20px; }
h2 { margin-bottom:15px; }
h3#titleCampo { color:#2980b9; margin-top:25px; margin-bottom:10px; }
h3#titleGR { color:#27ae60; margin-top:25px; margin-bottom:10px; }
.tabs { display:flex; gap:10px; align-items:center; margin-bottom:20px; }
.tab-btn { padding:10px 16px; border:none; border-radius:8px; background:#e0e0e0; cursor:pointer; font-weight:500; transition:0.3s; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.tab-btn:hover { background:#d5d5d5; }
.tab-btn.active { background:#27ae60; color:#fff; box-shadow:0 3px 6px rgba(0,0,0,0.2);}
.nav-btn { background:#2980b9; color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:500; transition:0.3s; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.nav-btn:hover { background:#3498db;}
.tab-content { display:none; }
.tab-content.active { display:block; }
.part-table { border-collapse:collapse; width:100%; margin-bottom:25px; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.1); table-layout:auto;}
.part-table th { background:#2980b9; color:#fff; font-size:13px; padding:8px; white-space:nowrap;}
.part-table td { border:1px solid #eee; padding:6px; font-size:12px; text-align:center; white-space:nowrap; height:36px;}
.part-table tr:nth-child(even) { background:#f9f9f9;}
.fixed-col { position:sticky; background:#fff; z-index:2; }
.part-table th:first-child, .part-table td:first-child { left:0; width:40px; }
.part-table th:nth-child(2), .part-table td:nth-child(2) { left:40px; width:150px; text-align:left; padding-left:6px;}
.responsive { margin-bottom:30px; padding:10px; background:#fdfdfd; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.05);}
.button-group { display:flex; justify-content:center; align-items:center; gap:4px;}
.inc, .dec { width:28px; height:28px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; transition:0.3s;}
.inc { background:#27ae60; color:#fff;}
.dec { background:#e74c3c; color:#fff;}
.inc:hover { background:#219150;}
.dec:hover { background:#c0392b;}
.inc.disabled, .dec.disabled { background:#aaa; cursor:not-allowed;}
.valueInput { width:40px; height:28px; border:1px solid #ccc; border-radius:6px; text-align:center; font-size:12px; background:#f9f9f9;}
.notification { position:fixed; top:20px; right:20px; background:#27ae60; color:#fff; padding:12px 18px; border-radius:8px; box-shadow:0 3px 6px rgba(0,0,0,0.2); opacity:0; pointer-events:none; transition:opacity 0.4s; z-index:200;}
.notification.show { opacity:1;}
footer { width:100%; text-align:center; padding:12px 0; font-size:0.8em; color:#666;}
</style>
</head>
<body>

<h2>Estatísticas | Prolongamento</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="partET1">1ª Parte</button>
  <button class="tab-btn" data-tab="partET2">2ª Parte</button>
  <button id="openInOutExtraTime" class="nav-btn">Entradas / Saídas Prolongamento</button>
</div>

<div id="partET1" class="tab-content active">
  <div class="responsive">
    <table id="tableCampoET1" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>GR / Postes</th>
          <th>Interceptados</th>
          <th>Fora</th>
          <th>Golos</th>
          <th>Passes Errados</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGRET1" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Defesas</th>
          <th>Interceptados</th>
          <th>Golos Sofridos</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="partET2" class="tab-content">
  <div class="responsive">
    <table id="tableCampoET2" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>GR / Postes</th>
          <th>Interceptados</th>
          <th>Fora</th>
          <th>Golos</th>
          <th>Passes Errados</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGRET2" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Defesas</th>
          <th>Interceptados</th>
          <th>Golos Sofridos</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="lastSavedET" style="font-size:10px;margin-top:10px;"></div>
<div class="notification" id="notificationET"></div>

<script>
// ---------- Config ----------
const STORAGE_KEY_ET = 'estatisticas_extra_time';
const DEBOUNCE_MS = 500;
const STAT_KEYS_CAMPO = ['rem','stopped','fora','goals','wrongPasses','fouls'];
const STAT_KEYS_GR = ['grOnNet','grStopped','grGoals','fouls'];

let playersCampoET=[], playersGRET=[], autoSaveTimerET;

// ---------- Helpers ----------
function createPlayerET(id, keys){ const p={id,name:''}; keys.forEach(k=>{p[k+'ET1']=0; p[k+'ET2']=0;}); return p;}
function initPlayersET(){ 
  playersCampoET = Array.from({length:8},(_,i)=>createPlayerET(i+1,STAT_KEYS_CAMPO)); 
  playersGRET = Array.from({length:2},(_,i)=>createPlayerET(i+9,STAT_KEYS_GR)); 
}
function allNamesFilledET(){ return [...playersCampoET,...playersGRET].every(p=>p.name && p.name.trim() !== ''); }
function isElementET(id){ return document.getElementById(id)!=null; }

// ---------- Load Main Names Real-Time ----------
function loadMainNamesRealtime(){
  const fieldPlayers = JSON.parse(localStorage.getItem("fieldPlayers")) || [];
  const goalKeepers = JSON.parse(localStorage.getItem("goalKeepers")) || [];

  const fieldWithStats = fieldPlayers.filter(p=>p.estatisticas);
  const goalWithStats = goalKeepers.filter(p=>p.estatisticas);

  fieldWithStats.forEach((p,i)=>{ 
    if(i<playersCampoET.length){ 
      playersCampoET[i].name=p.nome||''; 
      playersCampoET[i].id=p.numero||playersCampoET[i].id;
    } 
  });
  goalWithStats.forEach((p,i)=>{ 
    if(i<playersGRET.length){ 
      playersGRET[i].name=p.nome||''; 
      playersGRET[i].id=p.numero||playersGRET[i].id;
    } 
  });
}

// ---------- Save / AutoSave ----------
function saveToLocalET(){ 
  localStorage.setItem(STORAGE_KEY_ET, JSON.stringify({campo:playersCampoET,gr:playersGRET})); 
  document.getElementById('lastSavedET').textContent='Última gravação ET: '+new Date().toLocaleString('pt-PT'); 
  showNotificationET('Guardado ET!'); 
}
function scheduleAutoSaveET(){ 
  clearTimeout(autoSaveTimerET); 
  autoSaveTimerET=setTimeout(saveToLocalET,DEBOUNCE_MS);
}
function loadFromLocalET(){ 
  const saved=localStorage.getItem(STORAGE_KEY_ET); 
  if(saved){ 
    try{ 
      const data=JSON.parse(saved); 
      playersCampoET=data.campo||playersCampoET; 
      playersGRET=data.gr||playersGRET;
    }catch(e){console.warn('Erro parse ET',e);}
  }
}

// ---------- Notification ----------
function showNotificationET(msg){ 
  const notif=document.getElementById('notificationET'); 
  if(!notif) return; 
  notif.textContent=msg; 
  notif.classList.add('show'); 
  setTimeout(()=>notif.classList.remove('show'),1500);
}

// ---------- Increment/Decrement ----------
document.addEventListener('click', e=>{
  if(!e.target.classList.contains('inc') && !e.target.classList.contains('dec')) return;
  if(!allNamesFilledET()){ showNotificationET('Preencha e guarde todos os nomes antes de alterar estatísticas ET'); return; }
  const delta=e.target.classList.contains('inc')?1:-1;
  const id=parseInt(e.target.dataset.id), stat=e.target.dataset.stat, type=e.target.dataset.type;
  const arr=type.includes('CampoET')?playersCampoET:playersGRET;
  const player=arr.find(p=>p.id===id); if(!player) return;
  player[stat]=Math.max(0,player[stat]+delta);
  const input=document.querySelector(`.valueInput[data-id='${id}'][data-stat='${stat}']`);
  if(input){ input.value=player[stat]; input.classList.add('updated'); setTimeout(()=>input.classList.remove('updated'),300);}
  scheduleAutoSaveET();
});

// ---------- Render ----------
function renderPlayers(arr,containerId,part,keys){
  if(!isElementET(containerId)) return;
  const tbody=document.getElementById(containerId).querySelector('tbody'); tbody.innerHTML='';
  const partKey=part==='ET1'?'ET1':'ET2';
  arr.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="fixed-col">${p.id}</td>
      <td class="fixed-col">${p.name}</td>
      ${keys.map(k=>`<td><div class="button-group">
      <button class="dec" data-id="${p.id}" data-stat="${k+partKey}" data-type="${containerId}">-</button>
      <input type="text" class="valueInput" data-id="${p.id}" data-stat="${k+partKey}" value="${p[k+partKey]}" readonly>
      <button class="inc" data-id="${p.id}" data-stat="${k+partKey}" data-type="${containerId}">+</button>
      </div></td>`).join('')}`;
    tbody.appendChild(tr);
  });
}
function renderAllET(part){ 
  renderPlayers(playersCampoET, part==='ET1'?'tableCampoET1':'tableCampoET2', part, STAT_KEYS_CAMPO); 
  renderPlayers(playersGRET, part==='ET1'?'tableGRET1':'tableGRET2', part, STAT_KEYS_GR); 
}

// ---------- Tabs ----------
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
    btn.classList.add('active'); 
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); 
    document.getElementById(btn.dataset.tab).classList.add('active'); 
  });
});

// ---------- Real-Time Sync ----------
function startRealtimeSync(){ 
  setInterval(()=>{
    const oldCampo = JSON.stringify(playersCampoET);
    const oldGR = JSON.stringify(playersGRET);
    loadMainNamesRealtime();
    if(JSON.stringify(playersCampoET)!==oldCampo || JSON.stringify(playersGRET)!==oldGR){
      renderAllET('ET1'); renderAllET('ET2');
    }
  },500);
}

// ---------- Init ----------
initPlayersET();
loadFromLocalET();
renderAllET('ET1'); renderAllET('ET2');
startRealtimeSync();

// ---------- Open Entradas / Saídas ----------
document.getElementById('openInOutExtraTime').addEventListener('click',()=>{
  window.location.href = 'entradassaidasextratime.html';
});

</script>

<footer>Prolongamento | Estatísticas &copy; 2025</footer>
</body>
</html>
