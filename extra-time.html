<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estatísticas | Prolongamento</title>
<link rel="stylesheet" href="estatisticas.css">
<style>
/* Add any specific styles for extra-time.html here if needed */
</style>
</head>
<body>

<h2>Estatísticas | Prolongamento</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="partET1">1ª Parte</button>
  <button class="tab-btn" data-tab="partET2">2ª Parte</button>
  <button id="openInOutExtraTime" class="nav-btn">Entradas / Saídas Prolongamento</button>
  <button id="backToMainStats" class="nav-btn">Estatísticas Principais</button>
</div>

<div id="partET1" class="tab-content active">
  <div class="responsive">
    <table id="tableCampoET1" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Remates</th>
          <th>Interceptados</th>
          <th>Fora</th>
          <th>Golos</th>
          <th>Passes Errados</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGRET1" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Defesas</th>
          <th>Interceptados</th>
          <th>Golos Sofridos</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="partET2" class="tab-content">
  <div class="responsive">
    <table id="tableCampoET2" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Remates</th>
          <th>Interceptados</th>
          <th>Fora</th>
          <th>Golos</th>
          <th>Passes Errados</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGRET2" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Defesas</th>
          <th>Interceptados</th>
          <th>Golos Sofridos</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="lastSavedET" style="font-size:10px;margin-top:10px;"></div>
<div class="notification" id="notificationET"></div>

<script type="module" src="firebase-data.js"></script>
<script>
// ---------- Config ----------
const STORAGE_KEY_ET = FB_PATHS_GAME.estatisticasExtraTime; // Use game-specific path
const DEBOUNCE_MS = 500;
const STAT_KEYS_CAMPO = ['rem','interceptados','fora','golos','passesErrados','faltas']; // Changed 'grPostes' to 'rem' for consistency
const STAT_KEYS_GR = ['defesas','interceptados','golosSofridos','faltas'];

let playersCampoET=[], playersGRET=[], autoSaveTimerET;

// ---------- Helpers ----------
function createPlayerET(id, keys){ const p={id,name:''}; keys.forEach(k=>{p[k+'ET1']=0; p[k+'ET2']=0;}); return p;}
function initPlayersET(){
  playersCampoET = [];
  playersGRET = [];
}
function allNamesFilledET(){ return [...playersCampoET,...playersGRET].every(p=>p.name && p.name.trim() !== ''); }
function isElementET(id){ return document.getElementById(id)!=null; }

// ---------- Load Main Names Real-Time ----------
async function loadMainNamesRealtime(){
  const fieldPlayersData = await getFirebaseData(FB_PATHS_GLOBAL.fieldPlayers);
  const goalKeepersData = await getFirebaseData(FB_PATHS_GLOBAL.goalKeepers);

  const fieldPlayers = fieldPlayersData ? fieldPlayersData.players : [];
  const goalKeepers = goalKeepersData ? goalKeepersData.players : [];

  const fieldWithStats = fieldPlayers.filter(p=>p.estatisticas);
  const goalWithStats = goalKeepers.filter(p=>p.estatisticas);

  // Update existing players and add new ones
  const updatePlayerList = (currentList, sourceList, statKeys) => {
    const newList = [];
    sourceList.forEach(p => {
      let existingPlayer = currentList.find(etp => etp.id === p.numero);
      if (existingPlayer) {
        existingPlayer.name = p.nome || '';
        newList.push(existingPlayer);
      } else {
        const newPlayer = createPlayerET(p.numero, statKeys);
        newPlayer.name = p.nome || '';
        newList.push(newPlayer);
      }
    });
    return newList.sort((a,b) => a.id - b.id);
  };

  playersCampoET = updatePlayerList(playersCampoET, fieldWithStats, STAT_KEYS_CAMPO);
  playersGRET = updatePlayerList(playersGRET, goalWithStats, STAT_KEYS_GR);
}

// ---------- Save / AutoSave ----------
async function saveToLocalET(){
  const activeGame = getActiveGameId();
  if (!activeGame) {
    showNotificationET('❌ Nenhum jogo ativo para guardar. Selecione ou crie um jogo.', true);
    return;
  }
  await setFirebaseData(STORAGE_KEY_ET, {campo:playersCampoET,gr:playersGRET});
  document.getElementById('lastSavedET').textContent='Última gravação ET: '+new Date().toLocaleString('pt-PT');
  showNotificationET('Guardado ET!');
}
function scheduleAutoSaveET(){
  clearTimeout(autoSaveTimerET);
  autoSaveTimerET=setTimeout(saveToLocalET,DEBOUNCE_MS);
}
async function loadFromLocalET(){
  const activeGame = getActiveGameId();
  if (!activeGame) {
    console.warn("No active game to load extra time stats for.");
    return;
  }
  const saved = await getFirebaseData(STORAGE_KEY_ET);
  if(saved){
    try{
      playersCampoET=saved.campo||[];
      playersGRET=saved.gr||[];
    }catch(e){console.warn('Erro parse ET',e);}
  }
}

// ---------- Notification ----------
function showNotificationET(msg, isError = false){
  const notif=document.getElementById('notificationET');
  if(!notif) return;
  notif.textContent=msg;
  notif.className = isError ? 'notification error show' : 'notification show';
  setTimeout(()=>notif.classList.remove('show'),1500);
}

// ---------- Increment/Decrement ----------
document.addEventListener('click', e=>{
  if(!e.target.classList.contains('inc') && !e.target.classList.contains('dec')) return;
  const activeGame = getActiveGameId();
  if (!activeGame) {
    showNotificationET('❌ Nenhum jogo ativo. Selecione ou crie um jogo.', true);
    return;
  }
  if(!allNamesFilledET()){ showNotificationET('Preencha e guarde todos os nomes antes de alterar estatísticas ET'); return; }
  const delta=e.target.classList.contains('inc')?1:-1;
  const id=parseInt(e.target.dataset.id), stat=e.target.dataset.stat, type=e.target.dataset.type;
  const arr=type.includes('CampoET')?playersCampoET:playersGRET;
  const player=arr.find(p=>p.id===id); if(!player) return;
  player[stat]=Math.max(0,player[stat]+delta);
  const input=document.querySelector(`.valueInput[data-id='${id}'][data-stat='${stat}']`);
  if(input){ input.value=player[stat]; input.classList.add('updated'); setTimeout(()=>input.classList.remove('updated'),300);}
  scheduleAutoSaveET();
});

// ---------- Render ----------
function renderPlayers(arr,containerId,part,keys){
  if(!isElementET(containerId)) return;
  const tbody=document.getElementById(containerId).querySelector('tbody'); tbody.innerHTML='';
  const partKey=part==='ET1'?'ET1':'ET2';
  arr.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="fixed-col">${p.id}</td>
      <td class="fixed-col">${p.name}</td>
      ${keys.map(k=>`<td><div class="button-group">
      <button class="dec" data-id="${p.id}" data-stat="${k+partKey}" data-type="${containerId}">-</button>
      <input type="text" class="valueInput" data-id="${p.id}" data-stat="${k+partKey}" value="${p[k+partKey]}" readonly>
      <button class="inc" data-id="${p.id}" data-stat="${k+partKey}" data-type="${containerId}">+</button>
      </div></td>`).join('')}`;
    tbody.appendChild(tr);
  });
}
function renderAllET(part){
  renderPlayers(playersCampoET, part==='ET1'?'tableCampoET1':'tableCampoET2', part, STAT_KEYS_CAMPO);
  renderPlayers(playersGRET, part==='ET1'?'tableGRET1':'tableGRET2', part, STAT_KEYS_GR);
}

// ---------- Tabs ----------
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
    localStorage.setItem('activeExtraTimeTab', btn.dataset.tab);
  });
});

// ---------- Real-Time Sync ----------
// Listen for changes to main player config and extra-time stats
onFirebaseDataChange(FB_PATHS_GLOBAL.fieldPlayers, async () => {
  await loadMainNamesRealtime();
  renderAllET('ET1'); renderAllET('ET2');
});
onFirebaseDataChange(FB_PATHS_GLOBAL.goalKeepers, async () => {
  await loadMainNamesRealtime();
  renderAllET('ET1'); renderAllET('ET2');
});
onFirebaseDataChange(STORAGE_KEY_ET, async (data) => {
  if (data) {
    playersCampoET = data.campo || [];
    playersGRET = data.gr || [];
    await loadMainNamesRealtime(); // Update names from main config
    renderAllET('ET1'); renderAllET('ET2');
  }
});


// ---------- Init ----------
async function initExtraTime() {
  await initializeFirebase(); // Ensures auth & migration

  const activeGame = getActiveGameId();
  if (!activeGame) {
    alert("Nenhum jogo ativo. Por favor, selecione ou crie um jogo em 'Configurar Jogo'.");
    window.location.href = 'configjogoequipa.html';
    return;
  }

  initPlayersET(); // Initialize empty arrays
  await loadFromLocalET(); // Load existing ET stats for the active game
  await loadMainNamesRealtime(); // Populate names from main config
  renderAllET('ET1');
  renderAllET('ET2');
}
initExtraTime();

// Restore active tab on load
window.addEventListener('load', () => {
  const savedTab = localStorage.getItem('activeExtraTimeTab');
  if (savedTab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    const btn = document.querySelector(`[data-tab="${savedTab}"]`);
    if (btn) {
      btn.classList.add('active');
      document.getElementById(savedTab).classList.add('active');
    }
  }
});

// ---------- Open Entradas / Saídas ----------
document.getElementById('openInOutExtraTime').addEventListener('click',()=>{
  window.location.href = 'entradassaidasextratime.html';
});

document.getElementById('backToMainStats').addEventListener('click',()=>{
  window.location.href = 'estatisticas.html';
});

</script>

<footer>Prolongamento | Estatísticas &copy; 2025</footer>
</body>
</html>