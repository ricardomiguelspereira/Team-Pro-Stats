<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estatísticas | Prolongamento</title>
<style>
/* ... (your existing styles) ... */
</style>
</head>
<body>

<h2>Estatísticas | Prolongamento</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="partET1">1ª Parte</button>
  <button class="tab-btn" data-tab="partET2">2ª Parte</button>
  <button id="openInOutExtraTime" class="nav-btn">Entradas / Saídas Prolongamento</button>
</div>

<div id="partET1" class="tab-content active">
  <div class="responsive">
    <table id="tableCampoET1" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>GR / Postes</th>
          <th>Interceptados</th>
          <th>Fora</th>
          <th>Golos</th>
          <th>Passes Errados</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGRET1" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Defesas</th>
          <th>Interceptados</th>
          <th>Golos Sofridos</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="partET2" class="tab-content">
  <div class="responsive">
    <table id="tableCampoET2" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>GR / Postes</th>
          <th>Interceptados</th>
          <th>Fora</th>
          <th>Golos</th>
          <th>Passes Errados</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGRET2" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Defesas</th>
          <th>Interceptados</th>
          <th>Golos Sofridos</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="lastSavedET" style="font-size:10px;margin-top:10px;"></div>
<div class="notification" id="notificationET"></div>

<script type="module" src="firebase-data.js"></script>
<script>
// ---------- Config ----------
const STORAGE_KEY_ET = FB_PATHS.estatisticasExtraTime; // Use Firebase path
const DEBOUNCE_MS = 500;
const STAT_KEYS_CAMPO = ['rem','stopped','fora','goals','wrongPasses','fouls'];
const STAT_KEYS_GR = ['grOnNet','grStopped','grGoals','fouls'];

let playersCampoET=[], playersGRET=[], autoSaveTimerET;

// ---------- Helpers ----------
function createPlayerET(id, keys){ const p={id,name:''}; keys.forEach(k=>{p[k+'ET1']=0; p[k+'ET2']=0;}); return p;}
function initPlayersET(){ 
  // Initialize with empty arrays, data will be loaded from Firebase
  playersCampoET = []; 
  playersGRET = []; 
}
function allNamesFilledET(){ return [...playersCampoET,...playersGRET].every(p=>p.name && p.name.trim() !== ''); }
function isElementET(id){ return document.getElementById(id)!=null; }

// ---------- Load Main Names Real-Time ----------
async function loadMainNamesRealtime(){
  const fieldPlayersData = await getFirebaseData(FB_PATHS.fieldPlayers);
  const goalKeepersData = await getFirebaseData(FB_PATHS.goalKeepers);

  const fieldPlayers = fieldPlayersData ? fieldPlayersData.players : [];
  const goalKeepers = goalKeepersData ? goalKeepersData.players : [];

  const fieldWithStats = fieldPlayers.filter(p=>p.estatisticas);
  const goalWithStats = goalKeepers.filter(p=>p.estatisticas);

  // Ensure playersCampoET and playersGRET are populated with correct structure
  // If they are empty, initialize them based on fieldWithStats/goalWithStats
  if (playersCampoET.length === 0 && fieldWithStats.length > 0) {
    playersCampoET = fieldWithStats.map(p => createPlayerET(p.numero, STAT_KEYS_CAMPO));
  }
  if (playersGRET.length === 0 && goalWithStats.length > 0) {
    playersGRET = goalWithStats.map(p => createPlayerET(p.numero, STAT_KEYS_GR));
  }

  fieldWithStats.forEach((p,i)=>{ 
    const existingPlayer = playersCampoET.find(etp => etp.id === p.numero);
    if(existingPlayer){
      existingPlayer.name = p.nome || '';
    } else {
      // Add new player if they don't exist in ET stats yet
      playersCampoET.push(createPlayerET(p.numero, STAT_KEYS_CAMPO));
      playersCampoET.sort((a,b) => a.id - b.id); // Keep sorted
    }
  });
  goalWithStats.forEach((p,i)=>{ 
    const existingPlayer = playersGRET.find(etp => etp.id === p.numero);
    if(existingPlayer){
      existingPlayer.name = p.nome || '';
    } else {
      // Add new player if they don't exist in ET stats yet
      playersGRET.push(createPlayerET(p.numero, STAT_KEYS_GR));
      playersGRET.sort((a,b) => a.id - b.id); // Keep sorted
    }
  });

  // Remove players from ET stats if they are no longer in main config
  playersCampoET = playersCampoET.filter(etp => fieldWithStats.some(p => p.numero === etp.id));
  playersGRET = playersGRET.filter(etp => goalWithStats.some(p => p.numero === etp.id));
}

// ---------- Save / AutoSave ----------
async function saveToLocalET(){ 
  await setFirebaseData(STORAGE_KEY_ET, {campo:playersCampoET,gr:playersGRET}); 
  document.getElementById('lastSavedET').textContent='Última gravação ET: '+new Date().toLocaleString('pt-PT'); 
  showNotificationET('Guardado ET!'); 
}
function scheduleAutoSaveET(){ 
  clearTimeout(autoSaveTimerET); 
  autoSaveTimerET=setTimeout(saveToLocalET,DEBOUNCE_MS);
}
async function loadFromLocalET(){ 
  const saved = await getFirebaseData(STORAGE_KEY_ET); 
  if(saved){ 
    try{ 
      playersCampoET=saved.campo||playersCampoET; 
      playersGRET=saved.gr||playersGRET;
    }catch(e){console.warn('Erro parse ET',e);}
  }
}

// ---------- Notification ----------
function showNotificationET(msg){ 
  const notif=document.getElementById('notificationET'); 
  if(!notif) return; 
  notif.textContent=msg; 
  notif.classList.add('show'); 
  setTimeout(()=>notif.classList.remove('show'),1500);
}

// ---------- Increment/Decrement ----------
document.addEventListener('click', e=>{
  if(!e.target.classList.contains('inc') && !e.target.classList.contains('dec')) return;
  if(!allNamesFilledET()){ showNotificationET('Preencha e guarde todos os nomes antes de alterar estatísticas ET'); return; }
  const delta=e.target.classList.contains('inc')?1:-1;
  const id=parseInt(e.target.dataset.id), stat=e.target.dataset.stat, type=e.target.dataset.type;
  const arr=type.includes('CampoET')?playersCampoET:playersGRET;
  const player=arr.find(p=>p.id===id); if(!player) return;
  player[stat]=Math.max(0,player[stat]+delta);
  const input=document.querySelector(`.valueInput[data-id='${id}'][data-stat='${stat}']`);
  if(input){ input.value=player[stat]; input.classList.add('updated'); setTimeout(()=>input.classList.remove('updated'),300);}
  scheduleAutoSaveET();
});

// ---------- Render ----------
function renderPlayers(arr,containerId,part,keys){
  if(!isElementET(containerId)) return;
  const tbody=document.getElementById(containerId).querySelector('tbody'); tbody.innerHTML='';
  const partKey=part==='ET1'?'ET1':'ET2';
  arr.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="fixed-col">${p.id}</td>
      <td class="fixed-col">${p.name}</td>
      ${keys.map(k=>`<td><div class="button-group">
      <button class="dec" data-id="${p.id}" data-stat="${k+partKey}" data-type="${containerId}">-</button>
      <input type="text" class="valueInput" data-id="${p.id}" data-stat="${k+partKey}" value="${p[k+partKey]}" readonly>
      <button class="inc" data-id="${p.id}" data-stat="${k+partKey}" data-type="${containerId}">+</button>
      </div></td>`).join('')}`;
    tbody.appendChild(tr);
  });
}
function renderAllET(part){ 
  renderPlayers(playersCampoET, part==='ET1'?'tableCampoET1':'tableCampoET2', part, STAT_KEYS_CAMPO); 
  renderPlayers(playersGRET, part==='ET1'?'tableGRET1':'tableGRET2', part, STAT_KEYS_GR); 
}

// ---------- Tabs ----------
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
    btn.classList.add('active'); 
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); 
    document.getElementById(btn.dataset.tab).classList.add('active'); 
    localStorage.setItem('activeExtraTimeTab', btn.dataset.tab); // Still using localStorage for UI state
  });
});

// ---------- Real-Time Sync ----------
// Listen for changes to main player config and extra-time stats
onFirebaseDataChange(FB_PATHS.fieldPlayers, async () => {
  await loadMainNamesRealtime();
  renderAllET('ET1'); renderAllET('ET2');
});
onFirebaseDataChange(FB_PATHS.goalKeepers, async () => {
  await loadMainNamesRealtime();
  renderAllET('ET1'); renderAllET('ET2');
});
onFirebaseDataChange(STORAGE_KEY_ET, async (data) => {
  if (data) {
    playersCampoET = data.campo || [];
    playersGRET = data.gr || [];
    await loadMainNamesRealtime(); // Update names from main config
    renderAllET('ET1'); renderAllET('ET2');
  }
});


// ---------- Init ----------
async function initExtraTime() {
  initPlayersET(); // Initialize empty arrays
  await loadFromLocalET(); // Load existing ET stats
  await loadMainNamesRealtime(); // Populate names from main config
  renderAllET('ET1'); 
  renderAllET('ET2');
}
initExtraTime();

// Restore active tab on load
window.addEventListener('load', () => {
  const savedTab = localStorage.getItem('activeExtraTimeTab'); // Still using localStorage for UI state
  if (savedTab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    const btn = document.querySelector(`[data-tab="${savedTab}"]`);
    if (btn) {
      btn.classList.add('active');
      document.getElementById(savedTab).classList.add('active');
    }
  }
});

// ---------- Open Entradas / Saídas ----------
document.getElementById('openInOutExtraTime').addEventListener('click',()=>{
  window.location.href = 'entradassaidasextratime.html';
});

</script>

<footer>Prolongamento | Estatísticas &copy; 2025</footer>
</body>
</html>