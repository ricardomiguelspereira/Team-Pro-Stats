<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estatísticas do Jogo</title>
<style>
body { font-family:"Segoe UI",Tahoma,sans-serif; background:#f4f4f4; margin:0; padding:20px; color:#333; }
.container { max-width:1200px; margin:0 auto; background:#fff; padding:25px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1);}
h2 { text-align:center; color:#2980b9; }
.section { margin-bottom:25px; }
.button-group { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
button { padding:10px 20px; font-size:16px; border:none; border-radius:5px; cursor:pointer; color:#fff; }
.btn-stat { background:#2980b9; } .btn-stat:hover { background:#3498db; }
#gameInfo { background:#f0f8ff; padding:15px; border-radius:5px; }
.responsive { overflow-x:auto; margin-top:10px; }
.part-table { border-collapse:collapse; width:100%; }
.part-table th, .part-table td { border:1px solid #ccc; padding:8px; text-align:center; }
.fixed-col { position:sticky; left:0; background:#f9f9f9; z-index:1; }
#gameList { margin-top:15px; }
.game-item { display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:8px 12px; border-radius:5px; margin-bottom:5px; }
.game-item button { margin-left:5px; padding:5px 10px; font-size:14px; border-radius:3px; cursor:pointer; }
.notification { display:none; position:fixed; right:12px; top:12px; background:#e0ffe0; padding:8px 12px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
.notification.error { background:#ffdede; }
</style>
</head>
<body>
<div class="container">
  <h2>Estatísticas do Jogo</h2>

  <!-- Active Game Info -->
  <div id="gameInfo" class="section">
    <strong>Jogo Ativo:</strong>
    <div id="activeGameDetails">Carregando informações do jogo...</div>
  </div>

  <!-- Buttons -->
  <div class="button-group section">
    <button class="btn-stat" id="backConfigBtn">Configurar Jogo</button>
    <button class="btn-stat" id="newGameBtn" style="background:#27ae60">Novo Jogo</button>
    <button class="btn-stat" id="listGamesBtn" style="background:#2980b9">Listar Jogos</button>
  </div>

  <!-- Saved games -->
  <div class="section" id="gameListContainer" style="display:none;">
    <h3>Jogos Salvos</h3>
    <div id="gameList">Carregando...</div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script type="module">
import { 
  initializeFirebase, 
  getAllGameIds, 
  setActiveGameId, 
  deleteGameById, 
  getGameData, 
  createNewGame 
} from './firebase-data.js';

const activeGameDetails = document.getElementById("activeGameDetails");
const gameListContainer = document.getElementById("gameListContainer");
const gameListEl = document.getElementById("gameList");
const notificationEl = document.getElementById("notification");

function showNotification(msg, isError=false){
  notificationEl.textContent = msg;
  notificationEl.className = isError ? "notification error" : "notification";
  notificationEl.style.display = "block";
  setTimeout(()=> notificationEl.style.display="none", 2000);
}

// Display saved games
async function listSavedGames(){
  gameListContainer.style.display = "block";
  gameListEl.innerHTML = "Carregando...";
  try{
    const games = await getAllGameIds();
    if(!games.length) { gameListEl.innerHTML = "Nenhum jogo encontrado."; return; }

    gameListEl.innerHTML = "";
    games.forEach(g => {
      const div = document.createElement("div");
      div.className = "game-item";
      div.innerHTML = `
        <div><strong>${g.data.adversario || "Sem Adversário"}</strong> (${g.data.competicao || "N/A"}) - ${g.data.data || "N/A"}</div>
        <div>
          <button class="load-btn" data-id="${g.id}" style="background:#27ae60">Carregar</button>
          <button class="delete-btn" data-id="${g.id}" style="background:#e74c3c">Eliminar</button>
        </div>
      `;
      gameListEl.appendChild(div);
    });

    document.querySelectorAll(".load-btn").forEach(b => b.onclick = async e => {
      const id = e.target.dataset.id;
      await setActiveGameId(id);
      loadActiveGame();
      showNotification("Jogo carregado");
    });

    document.querySelectorAll(".delete-btn").forEach(b => b.onclick = async e => {
      const id = e.target.dataset.id;
      if(confirm("Eliminar este jogo?")) {
        await deleteGameById(id);
        showNotification("Jogo eliminado");
        listSavedGames();
      }
    });

  } catch(e) {
    console.error(e);
    showNotification("Erro ao listar jogos", true);
  }
}

// Load active game details
async function loadActiveGame(){
  const gameData = await getGameData();
  if(!gameData) {
    activeGameDetails.innerHTML = "Nenhum jogo ativo.";
    return;
  }
  activeGameDetails.innerHTML = `
    <div><strong>Escalão:</strong> ${gameData.escalao || "-"}</div>
    <div><strong>Competição:</strong> ${gameData.competicao || "-"}</div>
    <div><strong>Fase:</strong> ${gameData.fase || "-"}</div>
    <div><strong>Grupo:</strong> ${gameData.grupo || "-"}</div>
    <div><strong>Jornada:</strong> ${gameData.jornada || "-"}</div>
    <div><strong>Data / Hora:</strong> ${gameData.data || "-"} ${gameData.hora || "-"}</div>
    <div><strong>Local:</strong> ${gameData.local || "-"}</div>
    <div><strong>Adversário:</strong> ${gameData.adversario || "-"}</div>
  `;
}

// Button events
document.getElementById("listGamesBtn").onclick = listSavedGames;
document.getElementById("newGameBtn").onclick = async () => {
  await createNewGame();
  await loadActiveGame();
  listSavedGames();
};
document.getElementById("backConfigBtn").onclick = () => {
  window.location.href = "configjogoequipa.html";
};

// Init
await initializeFirebase();
await loadActiveGame();
await listSavedGames();
</script>
</body>
</html>
