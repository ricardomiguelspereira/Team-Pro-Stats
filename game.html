<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estatísticas do Jogo</title>
<style>
body { font-family:"Segoe UI",Tahoma,sans-serif; background:#f4f4f4; margin:0; padding:20px; color:#333; }
.container { max-width:1200px; margin:0 auto; background:#fff; padding:25px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1);}
h2 { text-align:center; color:#2980b9; }
.section { margin-bottom:25px; }
.button-group { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
button { padding:10px 20px; font-size:16px; border:none; border-radius:5px; cursor:pointer; color:#fff; }
.btn-stat { background:#2980b9; } .btn-stat:hover { background:#3498db; }
#gameInfo { background:#f0f8ff; padding:15px; border-radius:5px; }
#gameList { margin-top:15px; }
.game-item { display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:8px 12px; border-radius:5px; margin-bottom:5px; }
.game-item button { margin-left:5px; padding:5px 10px; font-size:14px; border-radius:3px; }
.notification { display:none; position:fixed; right:12px; top:12px; background:#e0ffe0; padding:8px 12px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
.notification.error { background:#ffdede; }
</style>
</head>
<body>
<div class="container">
  <h2>Estatísticas do Jogo</h2>

  <!-- Active Game Info -->
  <div id="gameInfo" class="section">
    <strong>Jogo Ativo:</strong>
    <div id="activeGameDetails">Carregando informações do jogo...</div>
  </div>

  <!-- Buttons -->
  <div class="button-group section">
    <button style="background:#27ae60" id="newGameBtn">Novo Jogo</button>
    <button style="background:#2980b9" id="listGamesBtn">Listar Jogos</button>
  </div>

  <!-- Saved games -->
  <div class="section" id="gameListContainer" style="display:none;">
    <h3>Jogos Salvos</h3>
    <div id="gameList">Carregando...</div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script type="module">
import { 
  ensureAuth, getActiveGameId, setActiveGameId, 
  getAllGames, deleteGame, createNewGame, loadGameData, saveGameData, onGamesSnapshot 
} from './firebase-data.js';

const activeGameDetails = document.getElementById("activeGameDetails");
const gameListEl = document.getElementById("gameList");
const gameListContainer = document.getElementById("gameListContainer");
const notificationEl = document.getElementById("notification");

// Notification helper
function notify(msg, error=false){
  notificationEl.textContent = msg;
  notificationEl.className = error ? "notification error" : "notification";
  notificationEl.style.display="block";
  setTimeout(()=>notificationEl.style.display="none",2000);
}

// Render list of games
async function renderGames(){
  gameListEl.innerHTML="Carregando...";
  try{
    const games = await getAllGames();
    gameListEl.innerHTML="";
    if(games.length===0){ gameListEl.innerHTML="Nenhum jogo encontrado."; return; }

    games.forEach(g=>{
      const div = document.createElement("div");
      div.className = "game-item";
      div.innerHTML = `<div><strong>${g.data.adversario||'Sem Adversário'}</strong> (${g.data.competicao||'N/A'}) - ${g.data.data||'N/A'}</div>`;
      const btnLoad = document.createElement("button"); btnLoad.textContent="Carregar"; btnLoad.style.background="#27ae60";
      btnLoad.onclick = ()=>loadGame(g.id);
      const btnDel = document.createElement("button"); btnDel.textContent="Eliminar"; btnDel.style.background="#e74c3c";
      btnDel.onclick = async ()=>{
        if(confirm("Eliminar este jogo?")){ await deleteGame(g.id); notify("Jogo eliminado"); renderGames(); }
      };
      div.appendChild(btnLoad);
      div.appendChild(btnDel);
      gameListEl.appendChild(div);
    });
  }catch(e){ console.error(e); notify("Erro ao listar jogos", true); }
}

// Load a game and display info
async function loadGame(id){
  setActiveGameId(id);
  const data = await loadGameData(id);
  activeGameDetails.innerHTML=`<div><strong>Adversário:</strong> ${data.adversario||'-'}</div>
    <div><strong>Competição:</strong> ${data.competicao||'-'}</div>
    <div><strong>Data:</strong> ${data.data||'-'}</div>`;
  notify("Jogo carregado");
  renderGames();
}

// Buttons
document.getElementById("newGameBtn").onclick = async ()=>{
  const newId = await createNewGame();
  await loadGame(newId);
  gameListContainer.style.display="block";
};

document.getElementById("listGamesBtn").onclick = ()=>{ gameListContainer.style.display="block"; renderGames(); };

// Init
async function init(){
  await ensureAuth();
  const activeGameId = getActiveGameId();
  if(activeGameId) loadGame(activeGameId);

  // Real-time updates
  onGamesSnapshot(renderGames);
}

init();
</script>
</body>
</html>
