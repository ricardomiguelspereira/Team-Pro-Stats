<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estatísticas</title>
<link rel="stylesheet" href="estatisticas.css">
<style>
  body { font-family: sans-serif; margin: 0; padding: 16px; }
  h2 { margin-bottom: 10px; }
  .tabs { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 4px; }
  .tab-btn, .nav-btn {
    padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer;
    background: #ddd;
  }
  .tab-btn.active { background: #0077ff; color: #fff; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
  th.fixed-col, td.fixed-col { position: sticky; left: 0; background: #fafafa; }
  .notification {
    display:none; position:fixed; right:12px; top:12px;
    background:#e0ffe0; padding:8px 12px; border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
  }
  .notification.error { background:#ffdede; }
  footer { width:100%; text-align:center; padding:12px 0; font-size:0.8em; color:#666; }
</style>
</head>
<body>

<h2>Estatísticas</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="part1">1ª Parte</button>
  <button class="tab-btn" data-tab="part2">2ª Parte</button>
  <button id="openInOut" class="nav-btn">Entradas / Saídas</button>
  <button id="openExtraTime" class="nav-btn">Prolongamento</button>
</div>

<!-- Parte 1 -->
<div id="part1" class="tab-content active">
  <table id="tableCampo1" class="part-table">
    <thead>
      <tr>
        <th class="fixed-col">#</th>
        <th class="fixed-col">Nome</th>
        <th>GR / Postes</th>
        <th>Interceptados</th>
        <th>Fora</th>
        <th>Golos</th>
        <th>Passes Errados</th>
        <th>Faltas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <table id="tableGR1" class="part-table">
    <thead>
      <tr>
        <th class="fixed-col">#</th>
        <th class="fixed-col">Nome</th>
        <th>Defesas</th>
        <th>Interceptados</th>
        <th>Golos Sofridos</th>
        <th>Faltas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Parte 2 -->
<div id="part2" class="tab-content" style="display:none">
  <table id="tableCampo2" class="part-table">
    <thead>
      <tr>
        <th class="fixed-col">#</th>
        <th class="fixed-col">Nome</th>
        <th>GR / Postes</th>
        <th>Interceptados</th>
        <th>Fora</th>
        <th>Golos</th>
        <th>Passes Errados</th>
        <th>Faltas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <table id="tableGR2" class="part-table">
    <thead>
      <tr>
        <th class="fixed-col">#</th>
        <th class="fixed-col">Nome</th>
        <th>Defesas</th>
        <th>Interceptados</th>
        <th>Golos Sofridos</th>
        <th>Faltas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="lastSaved" style="font-size:10px;margin-top:10px;"></div>
<div id="notification" class="notification"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, collection, getDocs, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

/* ---------- Firebase Config ---------- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY_HERE",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ---------- Global State ---------- */
let userId = null;
let activeGameId = null;
let fieldPlayers = [];
let goalKeepers = [];
let statsParte1 = { campo: {}, gr: {} };
let statsParte2 = { campo: {}, gr: {} };

const campoStats = ['grPostes', 'interceptados', 'fora', 'golos', 'passesErrados', 'faltas'];
const grStats = ['defesas', 'interceptados', 'golosSofridos', 'faltas'];

/* ---------- UI Helpers ---------- */
function showNotification(msg, error = false) {
  const el = document.getElementById("notification");
  el.textContent = msg;
  el.className = error ? "notification error" : "notification";
  el.style.display = "block";
  setTimeout(() => (el.style.display = "none"), 2000);
}

function updateLastSaved() {
  document.getElementById("lastSaved").textContent =
    "Última atualização: " + new Date().toLocaleTimeString("pt-PT");
}

function renderTable(tableId, players, statsMap, statKeys) {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = "";
  players.forEach(p => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td class="fixed-col">${p.numero}</td>
      <td class="fixed-col">${p.nome}</td>
      ${statKeys
        .map(
          k => `<td><input type="number" min="0" value="${
            statsMap?.[p.numero]?.[k] ?? 0
          }" onchange="updateStat('${p.numero}','${tableId}','${k}',this.value)"></td>`
        )
        .join("")}
    `;
  });
}

window.updateStat = function (num, tableId, stat, value) {
  const part = tableId.includes("1") ? "1" : "2";
  const cat = tableId.includes("Campo") ? "campo" : "gr";
  const stats = part === "1" ? statsParte1 : statsParte2;
  if (!stats[cat][num]) stats[cat][num] = {};
  stats[cat][num][stat] = parseInt(value) || 0;
  updateLastSaved();
  showNotification(`Guardado: #${num} ${stat}`);
};

function render() {
  renderTable("tableCampo1", fieldPlayers, statsParte1.campo, campoStats);
  renderTable("tableGR1", goalKeepers, statsParte1.gr, grStats);
  renderTable("tableCampo2", fieldPlayers, statsParte2.campo, campoStats);
  renderTable("tableGR2", goalKeepers, statsParte2.gr, grStats);
}

/* ---------- Load Players ---------- */
async function loadPlayers() {
  if (!userId || !activeGameId) return;
  const colRef = collection(db, "users", userId, "games", activeGameId, "players");
  const snapshot = await getDocs(colRef);

  let players = [];
  if (!snapshot.empty) {
    snapshot.forEach(d => players.push(d.data()));
  } else {
    // fallback to old format
    const gameRef = doc(db, "users", userId, "games", activeGameId);
    const snap = await getDoc(gameRef);
    if (snap.exists() && snap.data().players) {
      players = Object.values(snap.data().players);
    }
  }

  fieldPlayers = players
    .filter(p => p.estatisticas && !p.gr)
    .sort((a, b) => a.numero - b.numero);
  goalKeepers = players
    .filter(p => p.estatisticas && p.gr)
    .sort((a, b) => a.numero - b.numero);

  render();
}

/* ---------- Tabs ---------- */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => (c.style.display = "none"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).style.display = "block";
    render();
  });
});

document.getElementById("openInOut").addEventListener("click", () => {
  window.location.href = "entradassaidas.html";
});
document.getElementById("openExtraTime").addEventListener("click", () => {
  window.location.href = "extra-time.html";
});

/* ---------- Auth + Init ---------- */
onAuthStateChanged(auth, async user => {
  if (user) {
    userId = user.uid;
  } else {
    const res = await signInAnonymously(auth);
    userId = res.user.uid;
  }

  activeGameId = localStorage.getItem("activeGameId");
  if (!activeGameId) {
    alert("Nenhum jogo ativo. Selecione ou crie um jogo em 'Configurar Jogo'.");
    window.location.href = "configjogoequipa.html";
    return;
  }

  await loadPlayers();
  render();
});
</script>

<footer>© 2025 Team Pro Stats · Powered by RP Technology</footer>
</body>
</html>
