<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estatísticas</title>
<style>
body{font-family:sans-serif; padding:20px; background:#f4f4f4;}
h2{text-align:center;}
footer { width:100%; text-align:center; padding:12px 0; font-size:0.8em; color:#666; margin-top:20px; }
.notification { display:none; position:fixed; right:12px; top:12px; background:#e0ffe0; padding:8px 12px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
.notification.error { background:#ffdede; }
.tabs { display:flex; justify-content:center; gap:6px; margin-bottom:12px; }
.tab-btn { padding:6px 12px; cursor:pointer; border:none; border-radius:4px; background:#2980b9; color:white; }
.tab-btn.active{ background:#1c5980; }
.tab-content{ display:none; }
.tab-content.active{ display:block; }
.responsive{ overflow-x:auto; margin-bottom:16px; }
table{border-collapse:collapse; width:100%; background:white;}
th,td{border:1px solid #ccc; padding:6px; text-align:center;}
.fixed-col{text-align:left;}
.stat-controls{display:flex; justify-content:center; align-items:center;}
.stat-controls button{width:24px; height:24px; padding:0; font-weight:bold; border:none; background:#2980b9; color:white; border-radius:4px; cursor:pointer; line-height:1;}
.stat-controls button:hover{background:#1c5980;}
.stat-controls input[type=number]{width:40px; text-align:center; margin:0 2px; border:1px solid #ccc; border-radius:4px; height:24px;}
#loading{display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:1.2em; padding:20px; background:white; border:1px solid #ccc; border-radius:6px; margin-bottom:12px;}
</style>
</head>
<body>

<h2>Estatísticas</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="part1">1ª Parte</button>
  <button class="tab-btn" data-tab="part2">2ª Parte</button>
</div>

<div id="loading">A carregar jogadores e estatísticas...</div>

<div id="part1" class="tab-content active">
  <div class="responsive">
    <table id="tableCampo1">
      <thead>
        <tr><th>#</th><th>Nome</th><th>GR / Postes</th><th>Interceptados</th><th>Fora</th><th>Golos</th><th>Passes Errados</th><th>Faltas</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGR1">
      <thead>
        <tr><th>#</th><th>Nome</th><th>Defesas</th><th>Interceptados</th><th>Golos Sofridos</th><th>Faltas</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="part2" class="tab-content">
  <div class="responsive">
    <table id="tableCampo2">
      <thead>
        <tr><th>#</th><th>Nome</th><th>GR / Postes</th><th>Interceptados</th><th>Fora</th><th>Golos</th><th>Passes Errados</th><th>Faltas</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGR2">
      <thead>
        <tr><th>#</th><th>Nome</th><th>Defesas</th><th>Interceptados</th><th>Golos Sofridos</th><th>Faltas</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="lastSaved" style="font-size:10px;margin-top:10px;"></div>
<div id="notification" class="notification"></div>

<script type="module">
import {
  FB_PATHS_GLOBAL,
  FB_PATHS_GAME,
  initializeFirebase,
  saveSingleStat,
  onFirebaseDataChange,
  getFirebaseData,
  getActiveGameId
} from './firebase-data.js';

let eligibleFieldPlayers = [];
let eligibleGoalKeepers = [];
let statsParte1 = { campo:{}, gr:{} };
let statsParte2 = { campo:{}, gr:{} };

let unsubPlayers = null;
let unsubStats1 = null;
let unsubStats2 = null;

const campoStats = ['rem','interceptados','fora','golos','passesErrados','faltas'];
const grStats = ['defesas','interceptados','golosSofridos','faltas'];

const notificationEl = document.getElementById('notification');
const lastSavedEl = document.getElementById('lastSaved');
const loadingEl = document.getElementById('loading');

function showNotification(msg,isError=false){
  notificationEl.textContent=msg;
  notificationEl.className=isError?'notification error':'notification';
  notificationEl.style.display='block';
  setTimeout(()=>{notificationEl.style.display='none';},2000);
}

function updateLastSaved(){
  lastSavedEl.textContent=`Última gravação: ${new Date().toLocaleTimeString('pt-PT')}`;
}

function renderTable(tableId, players, statsMap, statKeys){
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML='';
  players.forEach(player=>{
    const row = tbody.insertRow();
    row.innerHTML=`<td class="fixed-col">${player.numero}</td>
                   <td class="fixed-col">${player.nome}</td>
                   ${statKeys.map(k=>`<td>
                     <div class="stat-controls">
                       <button onclick="changeStat(this,-1)">&minus;</button>
                       <input type="number" min="0" value="${statsMap[player.numero]?.[k]||0}" 
                        data-player="${player.numero}" data-category="${tableId.includes('Campo')?'campo':'gr'}"
                        data-part="${tableId.includes('1')?'1':'2'}" data-stat="${k}">
                       <button onclick="changeStat(this,1)">+</button>
                     </div>
                   </td>`).join('')}`;
  });
}

window.changeStat=async function(btn,delta){
  const input=btn.parentElement.querySelector('input');
  let val=parseInt(input.value)||0;
  val+=delta;
  if(val<0) val=0;
  input.value=val;
  const playerNum=input.dataset.player;
  const category=input.dataset.category;
  const part=input.dataset.part;
  const statKey=input.dataset.stat;
  const stats=part==='1'?statsParte1:statsParte2;
  if(!stats[category]) stats[category]={};
  if(!stats[category][playerNum]) stats[category][playerNum]={};
  stats[category][playerNum][statKey]=val;
  try{
    await saveSingleStat(part,category,playerNum,statKey,val);
    updateLastSaved();
    showNotification(`Guardado: ${statKey} (${val}) — #${playerNum}`);
  }catch(err){
    console.error(err);
    showNotification('Erro ao guardar (ver console)',true);
  }
};

function render(){
  renderTable('tableCampo1',eligibleFieldPlayers,statsParte1.campo||{},campoStats);
  renderTable('tableGR1',eligibleGoalKeepers,statsParte1.gr||{},grStats);
  renderTable('tableCampo2',eligibleFieldPlayers,statsParte2.campo||{},campoStats);
  renderTable('tableGR2',eligibleGoalKeepers,statsParte2.gr||{},grStats);
  loadingEl.style.display='none'; // hide spinner after rendering
}

async function setupFirebaseListeners(){
  if(unsubPlayers) unsubPlayers();
  unsubPlayers=await onFirebaseDataChange(FB_PATHS_GLOBAL.fieldPlayers,async (fieldData)=>{
    const fields=(fieldData?.players)||[];
    const goalData=await getFirebaseData(FB_PATHS_GLOBAL.goalKeepers);
    const gks=(goalData?.players)||[];
    eligibleFieldPlayers=fields.filter(p=>p.estatisticas===true && !p.gr).sort((a,b)=>a.numero-b.numero);
    eligibleGoalKeepers=[
      ...gks.filter(p=>p.estatisticas===true),
      ...fields.filter(p=>p.gr===true && p.estatisticas===true)
    ].sort((a,b)=>a.numero-b.numero);
    render();
  });

  if(unsubStats1) unsubStats1();
  unsubStats1=await onFirebaseDataChange(FB_PATHS_GAME.estatisticasParte1,(data)=>{
    statsParte1=data||{campo:{},gr:{}};
    render();
  });

  if(unsubStats2) unsubStats2();
  unsubStats2=await onFirebaseDataChange(FB_PATHS_GAME.estatisticasParte2,(data)=>{
    statsParte2=data||{campo:{},gr:{}};
    render();
  });
}

document.addEventListener('DOMContentLoaded',async ()=>{
  await initializeFirebase();
  const activeGame=getActiveGameId();
  if(!activeGame){ alert("Nenhum jogo ativo."); window.location.href='configjogoequipa.html'; return;}
  const s1=await getFirebaseData(FB_PATHS_GAME.estatisticasParte1);
  const s2=await getFirebaseData(FB_PATHS_GAME.estatisticasParte2);
  statsParte1=s1||{campo:{},gr:{}};
  statsParte2=s2||{campo:{},gr:{}};
  await setupFirebaseListeners();
  render();
});

window.addEventListener('beforeunload',()=>{
  if(typeof unsubPlayers==='function') unsubPlayers();
  if(typeof unsubStats1==='function') unsubStats1();
  if(typeof unsubStats2==='function') unsubStats2();
});
</script>

<script>
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});
</script>

<footer>© 2025 Team Pro Stats · Powered by RP Technology</footer>
</body>
</html>
