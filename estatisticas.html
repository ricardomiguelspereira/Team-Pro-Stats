<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estatísticas</title>
<link rel="stylesheet" href="estatisticas.css">
<style>
  footer {
    width: 100%;
    text-align: center;
    padding: 12px 0;
    font-size: 0.8em;
    color: #666;
  }
</style>
</head>
<body>

<h2>Estatísticas</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="part1">1ª Parte</button>
  <button class="tab-btn" data-tab="part2">2ª Parte</button>
  <button id="openInOut" class="nav-btn">Entradas / Saídas</button>
</div>

<!-- Parte 1 -->
<div id="part1" class="tab-content active">
  <div class="responsive">
    <table id="tableCampo1" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>GR / Postes</th>
          <th>Interceptados</th>
          <th>Fora</th>
          <th>Golos</th>
          <th>Passes Errados</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGR1" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Defesas</th>
          <th>Interceptados</th>
          <th>Golos Sofridos</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Parte 2 -->
<div id="part2" class="tab-content">
  <div class="responsive">
    <table id="tableCampo2" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>GR / Postes</th>
          <th>Interceptados</th>
          <th>Fora</th>
          <th>Golos</th>
          <th>Passes Errados</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="responsive">
    <table id="tableGR2" class="part-table">
      <thead>
        <tr>
          <th class="fixed-col">#</th>
          <th class="fixed-col">Nome</th>
          <th>Defesas</th>
          <th>Interceptados</th>
          <th>Golos Sofridos</th>
          <th>Faltas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="lastSaved" style="font-size:10px;margin-top:10px;"></div>
<div class="notification" id="notification"></div>

<!-- Firebase SDKs -->
<script type="module" src="firebase-data.js"></script>

<!-- Stats logic -->
<script type="module">
  import { 
    FB_PATHS, 
    setFirebaseData, 
    onFirebaseDataChange, 
    migrateLocalStorageToFirebase 
  } from './firebase-data.js';

  let eligibleFieldPlayers = [];
  let eligibleGoalKeepers = [];
  let statsParte1 = { campo: {}, gr: {} };
  let statsParte2 = { campo: {}, gr: {} };
  let unsubscribePlayers = null;
  let unsubscribeStats1 = null;
  let unsubscribeStats2 = null;
  let firebaseReady = false;

  const campoStats = ['grPostes', 'interceptados', 'fora', 'golos', 'passesErrados', 'faltas'];
  const grStats = ['defesas', 'interceptados', 'golosSofridos', 'faltas'];

  const notification = document.getElementById('notification');
  const lastSaved = document.getElementById('lastSaved');

  function showNotification(message, isError = false) {
    notification.textContent = message;
    notification.className = isError ? 'notification error' : 'notification success';
    notification.style.display = 'block';
    setTimeout(() => { notification.style.display = 'none'; }, 3000);
  }

  function updateLastSaved() {
    lastSaved.textContent = `Última gravação: ${new Date().toLocaleTimeString('pt-PT')}`;
  }

  function renderTable(tableId, players, stats, statKeys) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = '';
    players.forEach(player => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td class="fixed-col">${player.numero}</td>
        <td class="fixed-col">${player.nome}</td>
        ${statKeys.map(key => {
          const value = stats[player.numero]?.[key] ?? 0;
          return `<td><input type="number" min="0" value="${value}" 
                   data-player="${player.numero}" 
                   data-part="${tableId.includes('1') ? '1' : '2'}" 
                   data-category="${tableId.includes('Campo') ? 'campo' : 'gr'}" 
                   data-stat="${key}" onchange="updateStat(this)"></td>`;
        }).join('')}
      `;
    });
  }

  window.updateStat = async function(input) {
    const playerNumero = parseInt(input.dataset.player);
    const part = input.dataset.part;
    const category = input.dataset.category;
    const statKey = input.dataset.stat;
    const newValue = parseInt(input.value) || 0;

    const stats = part === '1' ? statsParte1 : statsParte2;
    if (!stats[category][playerNumero]) stats[category][playerNumero] = {};
    stats[category][playerNumero][statKey] = newValue;

    await saveStats(part);
    updateLastSaved();
  };

  async function saveStats(part) {
    if (!firebaseReady) return;
    try {
      const path = part === '1' ? FB_PATHS.estatisticasParte1 : FB_PATHS.estatisticasParte2;
      const data = part === '1' ? statsParte1 : statsParte2;
      await setFirebaseData(path, data);
      showNotification(`Estatísticas da ${part}ª parte guardadas!`);
    } catch (error) {
      console.error('Error saving stats:', error);
      showNotification('Erro ao guardar: ' + error.message, true);
    }
  }

  window.render = async function() {
    renderTable('tableCampo1', eligibleFieldPlayers, statsParte1.campo, campoStats);
    renderTable('tableGR1', eligibleGoalKeepers, statsParte1.gr, grStats);
    renderTable('tableCampo2', eligibleFieldPlayers, statsParte2.campo, campoStats);
    renderTable('tableGR2', eligibleGoalKeepers, statsParte2.gr, grStats);
  };

  function setupFirebaseListeners() {
    unsubscribePlayers = onFirebaseDataChange(FB_PATHS.fieldPlayers, (fieldData) => {
      const allField = fieldData?.players || [];
      onFirebaseDataChange(FB_PATHS.goalKeepers, (goalData) => {
        const allGR = goalData?.players || [];
        eligibleFieldPlayers = allField.filter(p => p.estatisticas && !p.gr).sort((a, b) => a.numero - b.numero);
        eligibleGoalKeepers = [...allGR, ...allField.filter(p => p.gr)]
          .filter(p => p.estatisticas)
          .sort((a, b) => a.numero - b.numero);
        render();
      });
    });

    unsubscribeStats1 = onFirebaseDataChange(FB_PATHS.estatisticasParte1, (data) => {
      statsParte1 = data || { campo: {}, gr: {} };
      if (document.getElementById('part1').classList.contains('active')) render();
    });

    unsubscribeStats2 = onFirebaseDataChange(FB_PATHS.estatisticasParte2, (data) => {
      statsParte2 = data || { campo: {}, gr: {} };
      if (document.getElementById('part2').classList.contains('active')) render();
    });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      await migrateLocalStorageToFirebase();
      setupFirebaseListeners();
      firebaseReady = true;
      await render();
    } catch (error) {
      console.error('Init error:', error);
      showNotification('Erro ao inicializar: ' + error.message, true);
      eligibleFieldPlayers = [];
      eligibleGoalKeepers = [];
      statsParte1 = { campo: {}, gr: {} };
      statsParte2 = { campo: {}, gr: {} };
      render();
    }
  });

  window.addEventListener('beforeunload', () => {
    unsubscribePlayers?.();
    unsubscribeStats1?.();
    unsubscribeStats2?.();
  });
</script>

<!-- Tabs -->
<script>
  window.addEventListener('load', async () => {
    const savedTab = localStorage.getItem('activeStatsTab');
    if (savedTab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const btn = document.querySelector(`[data-tab="${savedTab}"]`);
      if (btn) {
        btn.classList.add('active');
        document.getElementById(savedTab).classList.add('active');
      }
    }
    if (typeof render === 'function') await render();
  });

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
      localStorage.setItem('activeStatsTab', btn.dataset.tab);
      if (typeof render === 'function') render();
    });
  });

  document.getElementById('openInOut').addEventListener('click', () => {
    const currentTab = document.querySelector('.tab-btn.active').dataset.tab;
    localStorage.setItem('activeStatsTab', currentTab);
    window.location.href = 'entradassaidas.html';
  });
</script>

<footer>© 2025 Team Pro Stats · Powered by RP Technology</footer>
</body>
</html>
