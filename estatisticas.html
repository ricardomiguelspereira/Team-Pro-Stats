<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estatísticas</title>
<link rel="stylesheet" href="estatisticas.css">
<style>
  body { font-family: Arial, sans-serif; margin: 10px; }
  footer { width:100%; text-align:center; padding:12px 0; font-size:0.8em; color:#666; }
  .notification { display:none; position:fixed; right:12px; top:12px; background:#e0ffe0; padding:8px 12px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
  .notification.error { background:#ffdede; }
  table { width:100%; border-collapse:collapse; margin-bottom:20px; }
  th, td { border:1px solid #ccc; padding:4px; text-align:center; }
  th { background:#f5f5f5; }
  input[type="number"] { width:60px; text-align:center; }
  .tabs { margin-bottom:10px; }
  .tab-btn.active { background:#0099cc; color:#fff; }
  .tab-btn, .nav-btn { margin:3px; padding:6px 10px; border:none; background:#eee; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>

<h2>Estatísticas</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="part1">1ª Parte</button>
  <button class="tab-btn" data-tab="part2">2ª Parte</button>
  <button id="openInOut" class="nav-btn">Entradas / Saídas</button>
  <button id="openExtraTime" class="nav-btn">Prolongamento</button>
</div>

<!-- Parte 1 -->
<div id="part1" class="tab-content active">
  <h3>Jogadores de Campo</h3>
  <table id="tableCampo1">
    <thead>
      <tr>
        <th>#</th><th>Nome</th>
        <th>Remates</th><th>Interceptados</th><th>Fora</th>
        <th>Golos</th><th>Passes Errados</th><th>Faltas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Guarda-Redes</h3>
  <table id="tableGR1">
    <thead>
      <tr>
        <th>#</th><th>Nome</th>
        <th>Defesas</th><th>Interceptados</th><th>Golos Sofridos</th><th>Faltas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Parte 2 -->
<div id="part2" class="tab-content" style="display:none;">
  <h3>Jogadores de Campo</h3>
  <table id="tableCampo2">
    <thead>
      <tr>
        <th>#</th><th>Nome</th>
        <th>Remates</th><th>Interceptados</th><th>Fora</th>
        <th>Golos</th><th>Passes Errados</th><th>Faltas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Guarda-Redes</h3>
  <table id="tableGR2">
    <thead>
      <tr>
        <th>#</th><th>Nome</th>
        <th>Defesas</th><th>Interceptados</th><th>Golos Sofridos</th><th>Faltas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="lastSaved" style="font-size:10px;margin-top:10px;"></div>
<div id="notification" class="notification"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import {
    getFirestore, collection, onSnapshot, doc, getDoc, setDoc
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signInAnonymously
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  /* ---------- FIREBASE INIT ---------- */
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_MSG_ID",
    appId: "YOUR_APP_ID"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  /* ---------- STATE ---------- */
  let userId = null;
  let activeGameId = localStorage.getItem("activeGameId") || null;
  let fieldPlayers = [];
  let goalKeepers = [];
  let statsParte1 = { campo: {}, gr: {} };
  let statsParte2 = { campo: {}, gr: {} };

  const campoStats = ['remates','interceptados','fora','golos','passesErrados','faltas'];
  const grStats = ['defesas','interceptados','golosSofridos','faltas'];
  const notificationEl = document.getElementById('notification');
  const lastSavedEl = document.getElementById('lastSaved');

  function showNotification(msg,isError=false){
    notificationEl.textContent=msg;
    notificationEl.className=isError?'notification error':'notification';
    notificationEl.style.display='block';
    setTimeout(()=>notificationEl.style.display='none',2000);
  }
  function updateLastSaved(){
    lastSavedEl.textContent=`Última gravação: ${new Date().toLocaleTimeString('pt-PT')}`;
  }

  function renderTable(tableId, players, statsMap, keys){
    const tbody=document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML='';
    players.forEach(p=>{
      const row=tbody.insertRow();
      row.innerHTML=`
        <td>${p.numero}</td><td>${p.nome}</td>
        ${keys.map(k=>{
          const val=statsMap?.[p.numero]?.[k]??0;
          return `<td><input type="number" min="0" value="${val}"
            data-player="${p.numero}" data-part="${tableId.includes('1')?'1':'2'}"
            data-cat="${tableId.includes('Campo')?'campo':'gr'}"
            data-stat="${k}" onchange="window.updateStat(this)"></td>`;
        }).join('')}
      `;
    });
  }

  function render(){
    renderTable('tableCampo1',fieldPlayers,statsParte1.campo,campoStats);
    renderTable('tableGR1',goalKeepers,statsParte1.gr,grStats);
    renderTable('tableCampo2',fieldPlayers,statsParte2.campo,campoStats);
    renderTable('tableGR2',goalKeepers,statsParte2.gr,grStats);
  }

  window.updateStat = async function(input){
    const num=input.dataset.player;
    const part=input.dataset.part;
    const cat=input.dataset.cat;
    const stat=input.dataset.stat;
    const val=parseInt(input.value)||0;
    const stats=(part==='1')?statsParte1:statsParte2;
    if(!stats[cat])stats[cat]={};
    if(!stats[cat][num])stats[cat][num]={};
    stats[cat][num][stat]=val;
    const statsRef=doc(db,'users',userId,'games',activeGameId,`statsParte${part}`);
    await setDoc(statsRef,stats,{merge:true});
    updateLastSaved();
    showNotification(`Guardado #${num}: ${stat} ${val}`);
  }

  async function loadStats(){
    if(!userId||!activeGameId)return;
    const s1Ref=doc(db,'users',userId,'games',activeGameId,'statsParte1');
    const s2Ref=doc(db,'users',userId,'games',activeGameId,'statsParte2');
    const s1=await getDoc(s1Ref);
    const s2=await getDoc(s2Ref);
    if(s1.exists())statsParte1=s1.data();
    if(s2.exists())statsParte2=s2.data();
    render();
    onSnapshot(s1Ref,snap=>{ if(snap.exists()) { statsParte1=snap.data(); render(); } });
    onSnapshot(s2Ref,snap=>{ if(snap.exists()) { statsParte2=snap.data(); render(); } });
  }

  async function loadPlayers(){
    if(!userId||!activeGameId)return;
    const colRef=collection(db,'users',userId,'games',activeGameId,'players');
    onSnapshot(colRef,snap=>{
      const all=snap.docs.map(d=>d.data());
      fieldPlayers=all.filter(p=>p.estatisticas&&!p.gr).sort((a,b)=>a.numero-b.numero);
      goalKeepers=all.filter(p=>p.estatisticas&&p.gr).sort((a,b)=>a.numero-b.numero);
      render();
    });
  }

  onAuthStateChanged(auth,async u=>{
    if(u){userId=u.uid; await loadPlayers(); await loadStats();}
    else {await signInAnonymously(auth);}
  });
</script>

<script>
  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).style.display='block';
    });
  });
  document.getElementById('openInOut').onclick=()=>location.href='entradassaidas.html';
  document.getElementById('openExtraTime').onclick=()=>location.href='extra-time.html';
</script>

<footer>© 2025 Team Pro Stats · Powered by RP Technology</footer>
</body>
</html>
