<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestão de Jogadores</title>
<style>
/* Minimal CSS for clarity, same as before */
body{font-family:sans-serif;background:#f4f4f4;padding:20px;}
.container{background:white;padding:20px;border-radius:6px;max-width:900px;margin:0 auto;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:10px;border:1px solid #ddd;text-align:left;}
th{background:#2980b9;color:white;}
button{padding:6px 12px;margin-right:5px;border:none;border-radius:4px;cursor:pointer;}
.add-btn{background:#2980b9;color:white;}
.add-btn:hover{background:#3498db;}
.delete-btn{background:#dc3545;color:white;}
.delete-btn:hover{background:#c82333;}
.edit-btn{background:#28a745;color:white;}
.edit-btn:hover{background:#218838;}
</style>
</head>
<body>
<div class="container">
<h1>Gestão de Jogadores</h1>
<label>Nº: <input type="number" id="numero" min="1" max="99"></label>
<label>Nome: <input type="text" id="nome"></label>
<label>PSE: <input type="checkbox" id="pse"></label>
<label>Estatísticas: <input type="checkbox" id="estatisticas"></label>
<label>GR: <input type="checkbox" id="gr"></label>
<button class="add-btn" id="addPlayerBtn">Adicionar</button>

<h2>Jogadores de Campo</h2>
<table id="fieldPlayersTable">
<thead><tr><th>Nº</th><th>Nome</th><th>PSE</th><th>Estatísticas</th><th>Ações</th></tr></thead>
<tbody></tbody>
</table>

<h2>Guarda-Redes</h2>
<table id="goalKeepersTable">
<thead><tr><th>Nº</th><th>Nome</th><th>PSE</th><th>Estatísticas</th><th>Ações</th></tr></thead>
<tbody></tbody>
</table>

<button class="delete-btn" id="deleteAllBtn">Eliminar Tudo</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCD8a60aGbdXdYFKKKrV-z0mCDZx9yKWqI",
  authDomain: "team-pro-stats.firebaseapp.com",
  projectId: "team-pro-stats",
  storageBucket: "team-pro-stats.firebasestorage.app",
  messagingSenderId: "758444286089",
  appId: "1:758444286089:web:fcd8fba3a5d705de01e658",
  measurementId: "G-D1GDDBPD55"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUserId = null;
let activeGameId = localStorage.getItem("activeGameId") || null;

// Initialize Firebase Auth
await new Promise(resolve=>{
  const unsub = auth.onAuthStateChanged(async user=>{
    if(user) currentUserId = user.uid;
    else {
      const res = await signInAnonymously(auth);
      currentUserId = res.user.uid;
    }
    resolve();
    unsub();
  });
});

// Create a new game if none
if(!activeGameId){
  const newDoc = doc(db,'users',currentUserId,'games');
  activeGameId = doc(newDoc).id;
  localStorage.setItem("activeGameId",activeGameId);
  await setDoc(doc(db,'users',currentUserId,'games',activeGameId,'players'),{fieldPlayers:[],goalKeepers:[]});
}

// DOM Elements
const numeroInput = document.getElementById('numero');
const nomeInput = document.getElementById('nome');
const pseInput = document.getElementById('pse');
const estatisticasInput = document.getElementById('estatisticas');
const grInput = document.getElementById('gr');
const addBtn = document.getElementById('addPlayerBtn');
const fieldTableBody = document.querySelector('#fieldPlayersTable tbody');
const goalTableBody = document.querySelector('#goalKeepersTable tbody');
const deleteAllBtn = document.getElementById('deleteAllBtn');

let fieldPlayers=[], goalKeepers=[];

function renderTables(){
  fieldTableBody.innerHTML='';
  fieldPlayers.forEach((p,i)=>{
    const row = fieldTableBody.insertRow();
    row.innerHTML=`<td>${p.numero}</td><td>${p.nome}</td><td>${p.pse?'✔️':''}</td><td>${p.estatisticas?'✔️':''}</td>
    <td>
      <button class="edit-btn" data-index="${i}" data-table="field">Editar</button>
      <button class="delete-btn" data-index="${i}" data-table="field">Apagar</button>
    </td>`;
  });
  goalTableBody.innerHTML='';
  goalKeepers.forEach((p,i)=>{
    const row = goalTableBody.insertRow();
    row.innerHTML=`<td>${p.numero}</td><td>${p.nome}</td><td>${p.pse?'✔️':''}</td><td>${p.estatisticas?'✔️':''}</td>
    <td>
      <button class="edit-btn" data-index="${i}" data-table="goal">Editar</button>
      <button class="delete-btn" data-index="${i}" data-table="goal">Apagar</button>
    </td>`;
  });
}

// Real-time listener
const playersDoc = doc(db,'users',currentUserId,'games',activeGameId,'players');
onSnapshot(playersDoc,(snap)=>{
  if(snap.exists()){
    const data = snap.data();
    fieldPlayers = data.fieldPlayers||[];
    goalKeepers = data.goalKeepers||[];
    renderTables();
  }
});

// Add Player
addBtn.onclick = async ()=>{
  const numero=parseInt(numeroInput.value);
  const nome=nomeInput.value.trim();
  const pse=pseInput.checked;
  const estatisticas=estatisticasInput.checked;
  const gr=grInput.checked;
  if(!numero||!nome){alert('Número e Nome são obrigatórios'); return;}
  const target = gr?goalKeepers:fieldPlayers;
  if(target.some(p=>p.numero===numero)){alert('Número duplicado'); return;}
  target.push({numero,nome,pse,estatisticas});
  await setDoc(playersDoc,{fieldPlayers,goalKeepers});
  numeroInput.value=''; nomeInput.value=''; pseInput.checked=false; estatisticasInput.checked=false; grInput.checked=false;
};

// Delete or Edit
document.addEventListener('click', async e=>{
  if(e.target.matches('.delete-btn')){
    const index=parseInt(e.target.dataset.index);
    const table=e.target.dataset.table;
    if(table==='field'){ fieldPlayers.splice(index,1); }
    else{ goalKeepers.splice(index,1); }
    await setDoc(playersDoc,{fieldPlayers,goalKeepers});
  }
  if(e.target.matches('.edit-btn')){
    const index=parseInt(e.target.dataset.index);
    const table=e.target.dataset.table;
    const player = table==='field'? fieldPlayers[index]: goalKeepers[index];
    const newNumero=prompt('Novo Nº',player.numero);
    const newNome=prompt('Novo Nome',player.nome);
    if(!newNumero||!newNome) return;
    player.numero=parseInt(newNumero);
    player.nome=newNome;
    await setDoc(playersDoc,{fieldPlayers,goalKeepers});
  }
});

// Delete All
deleteAllBtn.onclick = async ()=>{
  if(confirm('Eliminar todos os jogadores?')){
    fieldPlayers=[]; goalKeepers=[];
    await setDoc(playersDoc,{fieldPlayers,goalKeepers});
  }
};
</script>
</body>
</html>
