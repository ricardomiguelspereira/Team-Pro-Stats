<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Jogadores - Team Pro Stats (Firebase)</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 6px;
      max-width: 900px;
      margin: 0 auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #2980b9;
    }
    .game-info {
      background: #e8f4fd;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-weight: bold;
    }
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 600;
    }
    input[type="number"], input[type="text"] {
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    input[type="checkbox"] {
      margin: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #2980b9;
      color: white;
    }
    button {
      padding: 6px 12px;
      margin-right: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .add-btn {
      background: #2980b9;
      color: white;
    }
    .add-btn:hover:not(:disabled) { background: #3498db; }
    .delete-btn {
      background: #dc3545;
      color: white;
    }
    .delete-btn:hover { background: #c82333; }
    .edit-btn {
      background: #28a745;
      color: white;
    }
    .edit-btn:hover { background: #218838; }
    .notification {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      display: none;
      font-weight: 600;
    }
    .notification.success {
      background: rgba(40, 167, 69, 0.1);
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .notification.error {
      background: rgba(220, 53, 69, 0.1);
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status {
      margin: 10px 0;
      padding: 8px;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
      font-size: 14px;
    }
    @media (max-width: 600px) {
      .form-row { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>⚽ Gestão de Jogadores - Team Pro Stats</h1>
    <div id="status" class="status" style="display: none;">Inicializando...</div>
    <div id="gameInfo" class="game-info" style="display: none;"></div>
    
    <div class="form-row">
      <label>Nº: <input type="number" id="numero" min="1" max="99" value=""></label>
      <label>Nome: <input type="text" id="nome" value=""></label>
      <label>PSE: <input type="checkbox" id="pse"></label>
      <label>Estatísticas: <input type="checkbox" id="estatisticas"></label>
      <label>GR: <input type="checkbox" id="gr"></label>
      <button class="add-btn" id="addPlayerBtn" disabled>Adicionar Jogador</button>
    </div>

    <div id="notification" class="notification"></div>

    <h2>Jogadores de Campo</h2>
    <table id="fieldPlayersTable">
      <thead>
        <tr><th>Nº</th><th>Nome</th><th>PSE</th><th>Estatísticas</th><th>Ações</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Guarda-Redes</h2>
    <table id="goalKeepersTable">
      <thead>
        <tr><th>Nº</th><th>Nome</th><th>PSE</th><th>Estatísticas</th><th>Ações</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="delete-btn" id="deleteAllBtn" disabled>Eliminar Todos os Jogadores</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCD8a60aGbdXdYFKKKrV-z0mCDZx9yKWqI",
      authDomain: "team-pro-stats.firebaseapp.com",
      projectId: "team-pro-stats",
      storageBucket: "team-pro-stats.firebasestorage.app",
      messagingSenderId: "758444286089",
      appId: "1:758444286089:web:fcd8fba3a5d705de01e658",
      measurementId: "G-D1GDDBPD55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser Id = null;
    let activeGameId = localStorage.getItem("activeGameId") || null;
    let fieldPlayers = [];
    let goalKeepers = [];
    let unsubscribeSnapshot = null;
    let isInitialized = false;

    const statusEl = document.getElementById('status');
    const numeroInput = document.getElementById('numero');
    const nomeInput = document.getElementById('nome');
    const pseInput = document.getElementById('pse');
    const estatisticasInput = document.getElementById('estatisticas');
    const grInput = document.getElementById('gr');
    const addBtn = document.getElementById('addPlayerBtn');
    const fieldTableBody = document.querySelector('#fieldPlayersTable tbody');
    const goalTableBody = document.querySelector('#goalKeepersTable tbody');
    const deleteAllBtn = document.getElementById('deleteAllBtn');
    const gameInfo = document.getElementById('gameInfo');
    const notification = document.getElementById('notification');

    // Show status
    function showStatus(msg) {
      statusEl.textContent = msg;
      statusEl.style.display = 'block';
      console.log('Status:', msg);
    }

    // Show notification
    function showNotification(msg, isError = false) {
      notification.textContent = msg;
      notification.className = `notification ${isError ? 'error' : 'success'}`;
      notification.style.display = 'block';
      setTimeout(() => { notification.style.display = 'none'; }, 4000);
      console.log(isError ? 'Error:' : 'Success:', msg);
    }

    // Initialize Auth
    async function initializeAuth() {
      showStatus('Inicializando autenticação...');
      return new Promise((resolve, reject) => {
        const unsub = auth.onAuthStateChanged(async (user) => {
          if (user) {
            currentUser Id = user.uid;
            console.log('Auth success, userId:', currentUser Id);
          } else {
            try {
              showStatus('Fazendo login anônimo...');
              const result = await signInAnonymously(auth);
              currentUser Id = result.user.uid;
              console.log('Anonymous auth success, userId:', currentUser Id);
            } catch (err) {
              console.error('Auth error:', err);
              showNotification('Erro na autenticação: ' + err.message, true);
              reject(err);
              return;
            }
          }
          unsub();
          resolve(currentUser Id);
        });
      });
    }

    function userPath(...parts) { 
      if (!currentUser Id) throw new Error('User  ID not set');
      return ["users", currentUser Id, ...parts]; 
    }
    function gamePath(gameId, ...parts) { 
      if (!gameId) throw new Error('Game ID not set');
      return ["users", currentUser Id, "games", gameId, ...parts]; 
    }

    // Ensure active game exists (create if not)
    async function ensureActiveGame() {
      showStatus('Verificando jogo ativo...');
      if (activeGameId) {
        try {
          const rootSnap = await getDoc(doc(db, ...userPath("games", activeGameId)));
          if (rootSnap.exists()) {
            console.log('Existing active game found:', activeGameId);
            return activeGameId;
          } else {
            console.log('Active game ID invalid, creating new');
            activeGameId = null;
          }
        } catch (err) {
          console.error('Error checking active game:', err);
          activeGameId = null;
        }
      }

      // Create new game
      try {
        showStatus('Criando novo jogo...');
        const colRef = collection(db, ...userPath("games"));
        const newDocRef = doc(colRef);
        activeGameId = newDocRef.id;
        localStorage.setItem("activeGameId", activeGameId);

        // Create root game doc
        await setDoc(newDocRef, { createdAt: serverTimestamp() });
        console.log('Root game doc created:', activeGameId);

        // Create default jogoFormData
        const defaultGame = {
          escalao: '', competicao: '', fase: '', grupo: '', jornada: '',
          data: new Date().toISOString().slice(0, 10), hora: '', local: '', adversario: 'Novo Jogo',
          active: true
        };
        await setDoc(doc(db, ...gamePath(activeGameId, "config", "jogoFormData")), defaultGame);
        console.log('Game config created');

        // Initialize empty players doc
        await setDoc(doc(db, ...gamePath(activeGameId, "players")), { fieldPlayers: [], goalKeepers: [] });
        console.log('Players doc initialized');

        showNotification('🆕 Novo jogo criado automaticamente!');
        updateGameInfo(defaultGame);
        return activeGameId;
      } catch (err) {
        console.error('Error creating game:', err);
        showNotification('Erro ao criar jogo: ' + err.message, true);
        throw err;
      }
    }

    // Update game info display
    function updateGameInfo(gameData) {
      if (gameData && gameData.adversario && gameData.data) {
        gameInfo.innerHTML = `Gerenciando jogadores para: ${gameData.adversario} em ${gameData.data} (${gameData.local || 'Local não definido'})`;
        gameInfo.style.display = 'block';
      } else {
        gameInfo.style.display = 'none';
      }
    }

    // Render tables
    function renderTables() {
      fieldTableBody.innerHTML = '';
      fieldPlayers.forEach((p, i) => {
        const row = fieldTableBody.insertRow();
        row.innerHTML = `
          <td>${p.numero}</td>
          <td>${p.nome}</td>
          <td>${p.pse ? '✔️' : ''}</td>
          <td>${p.estatisticas ? '✔️' : ''}</td>
          <td>
            <button class="edit-btn" data-index="${i}" data-table="field">Editar</button>
            <button class="delete-btn" data-index="${i}" data-table="field">Apagar</button>
          </td>
        `;
      });

      goalTableBody.innerHTML = '';
      goalKeepers.forEach((p, i) => {
        const row = goalTableBody.insertRow();
        row.innerHTML = `
          <td>${p.numero}</td>
          <td>${p.nome}</td>
          <td>${p.pse ? '✔️' : ''}</td>
          <td>${p.estatisticas ? '✔️' : ''}</td>
          <td>
            <button class="edit-btn" data-index="${i}" data-table="goal">Editar</button>
            <button class="delete-btn" data-index="${i}" data-table="goal">Apagar</button>
          </td>
        `;
      });
    }

    // Setup real-time listener
    function setupListener() {
      if (unsubscribeSnapshot) unsubscribeSnapshot();
      const playersRef = doc(db, ...gamePath(activeGameId, "players"));
      console.log('Setting up listener on:', playersRef.path);
      unsubscribeSnapshot = onSnapshot(playersRef, (snap) => {
        console.log('Snapshot received:', snap.exists() ? 'Data' : 'No data');
        if (snap.exists()) {
          const data = snap.data();
          fieldPlayers = data.fieldPlayers || [];
          goalKeepers = data.goalKeepers || [];
          renderTables();
        } else {
          console.log('Players doc not found, initializing...');
          setDoc(playersRef, { fieldPlayers: [], goalKeepers: [] });
        }
      }, (err) => {
        console.error('Snapshot error:', err);
        showNotification('Erro na sincronização: ' + err.message, true);
      });

      // Load game info
      getDoc(doc(db, ...gamePath(activeGameId, "config", "jogoFormData"))).then((snap) => {
        if (snap.exists()) {
          updateGameInfo(snap.data());
        }
      }).catch(err => console.error('Error loading game info:', err));
    }

    // Add player (guarded)
    addBtn.onclick = async () => {
      if (!isInitialized || !activeGameId || !currentUser Id) {
        showNotification('Sistema ainda inicializando ou sem jogo ativo. Aguarde...', true);
        return;
      }

      const numero = parseInt(numeroInput.value);
      const nome = nomeInput.value.trim();
      const pse = pseInput.checked;
      const estatisticas = estatisticasInput.checked;
      const isGr = grInput.checked;

      if (!numero || !nome) {
        showNotification('Número e Nome são obrigatórios!', true);
        return;
      }

      // Check duplicates
      const allPlayers = [...fieldPlayers, ...goalKeepers];
      if (allPlayers.some(p => p.numero === numero)) {
        showNotification('Número já