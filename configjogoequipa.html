<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestão de Jogos</title>
<style>
  body { font-family: "Segoe UI", Tahoma, sans-serif; background:#f4f4f4; margin:0; padding:20px; color:#333;}
  .container { max-width: 900px; margin:0 auto; background:#fff; padding:25px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1);}
  h2 { color:#2980b9; text-align:center; margin-top:0; }
  form { display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px; }
  label { display:flex; flex-direction:column; font-weight:600; }
  input, select { padding:10px; font-size:16px; border-radius:5px; border:1px solid #ccc; width:100%; }
  button { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-size:16px; font-weight:bold; margin-top:10px; transition: background 0.3s; }
  .btn-new { background:#2980b9; color:#fff; } .btn-new:hover { background:#3498db; }
  .btn-save { background:#27ae60; color:#fff; } .btn-save:hover { background:#219150; }
  .games-list { margin-top:30px; }
  .game-item { display:flex; justify-content:space-between; align-items:center; padding:10px 15px; margin-bottom:8px; background:#f9f9f9; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,.05); }
  .game-item button { padding:5px 10px; font-size:14px; border-radius:3px; border:none; cursor:pointer; }
  .btn-load { background:#2980b9; color:#fff; margin-right:5px; } .btn-load:hover { background:#3498db; }
  .btn-delete { background:#e74c3c; color:#fff; } .btn-delete:hover { background:#c0392b; }
  .no-games { text-align:center; color:#666; font-style:italic; padding:10px; }
</style>
</head>
<body>
<div class="container">
  <h2>Gestão de Jogos</h2>
  
  <div class="button-group">
    <button id="newGameBtn" class="btn-new">Novo Jogo</button>
    <button id="listGamesBtn" class="btn-new">Listar Jogos</button>
  </div>

  <form id="gameForm" autocomplete="off" style="margin-top:20px;">
    <label>Escalão
      <select name="escalao" required>
        <option value="">---</option>
        <option>SUB-13</option>
        <option>SUB-15</option>
        <option>SUB-17</option>
        <option>SUB-19</option>
        <option>SUB-23</option>
        <option>SÉNIORES</option>
      </select>
    </label>
    <label>Competição<input name="competicao" type="text" /></label>
    <label>Fase<input name="fase" type="text" /></label>
    <label>Grupo<input name="grupo" type="text" /></label>
    <label>Jornada<input name="jornada" type="text" /></label>
    <label>Data<input name="data" type="date" /></label>
    <label>Hora<input name="hora" type="time" /></label>
    <label>Local<input name="local" type="text" /></label>
    <label>Adversário<input name="adversario" type="text" /></label>
    <button id="saveGameBtn" class="btn-save" type="button">Guardar Jogo</button>
  </form>

  <div class="games-list" id="gamesListContainer">
    <div class="no-games">Nenhum jogo carregado</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, getDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCD8a60aGbdXdYFKKKrV-z0mCDZx9yKWqI",
  authDomain: "team-pro-stats.firebaseapp.com",
  projectId: "team-pro-stats",
  storageBucket: "team-pro-stats.firebasestorage.app",
  messagingSenderId: "758444286089",
  appId: "1:758444286089:web:fcd8fba3a5d705de01e658",
  measurementId: "G-D1GDDBPD55"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUserId = null;
let activeGameId = null;

const newGameBtn = document.getElementById("newGameBtn");
const listGamesBtn = document.getElementById("listGamesBtn");
const saveGameBtn = document.getElementById("saveGameBtn");
const gamesListContainer = document.getElementById("gamesListContainer");
const gameForm = document.getElementById("gameForm");

// Auth
async function ensureAuth() {
  if(currentUserId) return currentUserId;
  return new Promise((resolve,reject)=>{
    const unsub = onAuthStateChanged(auth,user=>{
      if(user){ currentUserId=user.uid; unsub(); resolve(currentUserId);}
      else {
        signInAnonymously(auth).then(cred=>{ currentUserId=cred.user.uid; unsub(); resolve(currentUserId); })
        .catch(e=>{ console.error("Auth error:",e); reject(e); });
      }
    });
  });
}

// Generate new game ID
function generateGameId() {
  return doc(collection(db, "users", currentUserId, "games")).id;
}

// Create New Game
newGameBtn.onclick = async () => {
  await ensureAuth();
  activeGameId = generateGameId();
  // Save activeGame field in Firebase
  await setDoc(doc(db,"users",currentUserId), { activeGame: activeGameId }, { merge:true });
  gameForm.reset();
  alert("Novo jogo criado. Preencha os dados e clique Guardar Jogo.");
}

// Save Game
saveGameBtn.onclick = async () => {
  if(!activeGameId) {
    alert("Crie ou carregue um jogo antes de guardar.");
    return;
  }
  await ensureAuth();
  const data = {};
  for(const el of gameForm.elements){
    if(el.name) data[el.name]=el.value;
  }
  await setDoc(doc(db, "users", currentUserId, "games", activeGameId, "config","jogoFormData"), data, {merge:true});
  // Also set activeGame in Firebase
  await setDoc(doc(db,"users",currentUserId), { activeGame: activeGameId }, { merge:true });
  alert("Jogo guardado!");
  listGames();
}

// List Games
listGamesBtn.onclick = listGames;

async function listGames() {
  await ensureAuth();
  const colRef = collection(db, "users", currentUserId, "games");
  const snaps = await getDocs(colRef);
  gamesListContainer.innerHTML="";

  if(snaps.empty){
    gamesListContainer.innerHTML='<div class="no-games">Nenhum jogo encontrado</div>';
    return;
  }

  for(const docSnap of snaps.docs){
    const id = docSnap.id;
    const dataSnap = await getDoc(doc(db,"users",currentUserId,"games",id,"config","jogoFormData"));
    const data = dataSnap.exists() ? dataSnap.data() : { adversario:"Sem Adversário", competicao:"N/A", data:"" };
    
    const div = document.createElement("div");
    div.className="game-item";
    div.innerHTML = `<div><strong>${data.adversario}</strong> (${data.competicao}) - ${data.data || "N/A"}</div>`;

    const loadBtn = document.createElement("button");
    loadBtn.textContent="Carregar";
    loadBtn.className="btn-load";
    loadBtn.onclick = async () => {
      activeGameId = id;
      // Save active game in Firebase
      await setDoc(doc(db,"users",currentUserId), { activeGame: activeGameId }, { merge:true });
      // Load the game data into form
      for(const el of gameForm.elements){
        if(el.name) el.value = data[el.name] || "";
      }
    };

    const delBtn = document.createElement("button");
    delBtn.textContent="Eliminar";
    delBtn.className="btn-delete";
    delBtn.onclick = async () => {
      if(confirm("Deseja realmente eliminar este jogo?")){
        await deleteDoc(doc(db,"users",currentUserId,"games",id));
        // If deleted active game, remove activeGame field
        if(activeGameId===id) {
          activeGameId=null;
          await setDoc(doc(db,"users",currentUserId), { activeGame: null }, { merge:true });
          gameForm.reset();
        }
        listGames();
      }
    };

    div.appendChild(loadBtn);
    div.appendChild(delBtn);
    gamesListContainer.appendChild(div);
  }
}

// Auto-load last active game from Firebase
async function loadLastActiveGame() {
  await ensureAuth();
  const userDocSnap = await getDoc(doc(db,"users",currentUserId));
  if(userDocSnap.exists()){
    const userData = userDocSnap.data();
    if(userData.activeGame){
      activeGameId = userData.activeGame;
      const snap = await getDoc(doc(db,"users",currentUserId,"games",activeGameId,"config","jogoFormData"));
      if(snap.exists()){
        const data = snap.data();
        for(const el of gameForm.elements){
          if(el.name) el.value = data[el.name] || "";
        }
      } else {
        activeGameId = null;
      }
    }
  }
}

// Initialize
ensureAuth().then(() => {
  loadLastActiveGame();
  listGames();
});
</script>
</body>
</html>
