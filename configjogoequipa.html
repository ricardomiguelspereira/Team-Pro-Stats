<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Team Pro Stats ‚Äî Gest√£o de Jogos e Jogadores</title>
<style>
:root{--primary:#0077ff;--danger:#e74c3c;--success:#28a745;--muted:#f4f7fa;--card:#fff;--border:#ddd;--text:#222;}
*{box-sizing:border-box;}
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:16px;background:var(--muted);color:var(--text);display:flex;justify-content:center;}
.wrap{width:100%;max-width:1100px;background:var(--card);border-radius:10px;box-shadow:0 6px 22px rgba(0,0,0,.08);}
header{background:var(--primary);color:#fff;text-align:center;padding:14px;font-weight:700;}
main{padding:20px;}
form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;}
label{display:block;font-weight:600;font-size:13px;}
input,select{width:100%;padding:8px;margin-top:4px;border-radius:6px;border:1px solid var(--border);}
input[readonly],select[disabled]{background:#f5f5f5;color:#777;}
.actions{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;}
button{padding:8px 12px;border-radius:6px;border:0;cursor:pointer;font-weight:600;}
button.primary{background:var(--primary);color:#fff;}
button.success{background:var(--success);color:#fff;}
button.danger{background:var(--danger);color:#fff;}
.notification{margin-top:10px;padding:10px;border-radius:8px;display:none;font-weight:600;}
#gamesList{margin-top:18px;border-top:1px solid var(--border);padding-top:10px;display:none;}
#gamesList.show{display:block;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid var(--border);padding:8px;text-align:left;font-size:13px;}
th{background:#f0f6ff;}
tr.active-row{background:#e6f7ff;}
.small-btn{padding:6px 8px;font-size:13px;border-radius:4px;border:0;cursor:pointer;margin-right:4px;}
.small-btn.load{background:var(--primary);color:#fff;}
.small-btn.delete{background:var(--danger);color:#fff;}
hr{margin:24px 0;border:none;border-top:1px solid var(--border);}
</style>
</head>
<body>
<div class="wrap">
<header>Team Pro Stats ‚Äî Gest√£o de Jogos e Jogadores</header>
<main>
<h2>Gest√£o de Jogos</h2>
<form id="jogoForm" autocomplete="off" novalidate onsubmit="return false;">
  <label>Escal√£o
    <select name="escalao" disabled>
      <option value="">-- Selecionar --</option>
      <option value="Sub-13">Sub-13</option>
      <option value="Sub-15">Sub-15</option>
      <option value="Sub-17">Sub-17</option>
      <option value="Sub-19">Sub-19</option>
      <option value="Sub-23">Sub-23</option>
      <option value="S√©niores">S√©niores</option>
    </select>
  </label>
  <label>Competi√ß√£o<input name="competicao" readonly /></label>
  <label>Fase<input name="fase" readonly /></label>
  <label>Grupo<input name="grupo" readonly /></label>
  <label>Jornada<input name="jornada" readonly /></label>
  <label>Data<input type="date" name="data" readonly /></label>
  <label>Hora<input type="time" name="hora" readonly /></label>
  <label>Local<input name="local" readonly /></label>
  <label>Advers√°rio<input name="adversario" readonly /></label>
</form>

<div class="actions">
  <button class="primary" id="newGameBtn">Novo Jogo</button>
  <button class="success" id="saveGameBtn" disabled>Salvar</button>
  <button class="primary" id="editGameBtn">Editar</button>
  <button class="primary" id="toggleGamesBtn">Mostrar/Ocultar Jogos</button>
  <button class="danger" id="deleteAllGamesBtn">Apagar Todos</button>
</div>

<div id="notification" class="notification"></div>

<div id="gamesList">
  <h3>üìã Jogos Guardados</h3>
  <table>
    <thead>
      <tr><th>Escal√£o</th><th>Competi√ß√£o</th><th>Fase</th><th>Grupo</th>
      <th>Jornada</th><th>Data/Hora</th><th>Local</th><th>Advers√°rio</th>
      <th>Ativo</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody id="gamesTableBody"></tbody>
  </table>
</div>

<hr />
<h2>Gest√£o de Jogadores</h2>
<div>
  <label>N¬∫:<input type="number" id="numero" min="1" max="99"></label>
  <label>Nome:<input type="text" id="nome"></label>
  <label>PSE:<input type="checkbox" id="pse"></label>
  <label>Estat√≠sticas:<input type="checkbox" id="estatisticas"></label>
  <label>GR:<input type="checkbox" id="gr"></label>
  <button class="primary" id="addPlayerBtn">Adicionar</button>
</div>

<h3>Jogadores de Campo</h3>
<table id="fieldPlayersTable">
  <thead><tr><th>N¬∫</th><th>Nome</th><th>PSE</th><th>Estat√≠sticas</th><th>A√ß√µes</th></tr></thead>
  <tbody></tbody>
</table>

<h3>Guarda-Redes</h3>
<table id="goalKeepersTable">
  <thead><tr><th>N¬∫</th><th>Nome</th><th>PSE</th><th>Estat√≠sticas</th><th>A√ß√µes</th></tr></thead>
  <tbody></tbody>
</table>

<button class="danger" id="deleteAllPlayersBtn">Eliminar Todos os Jogadores</button>
</main>
</div>

<script type="module">
import { db } from "./firebase-data.js";
import {
  collection, doc, getDocs, getDoc, setDoc, deleteDoc,
  query, where, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const currentUserId="user1";
let activeGameId=null;
let unsubscribePlayers=null;
let editingPlayerId=null;
let editingGame=false;

const jogoForm=document.getElementById("jogoForm");
const gamesBody=document.getElementById("gamesTableBody");
const numero=document.getElementById("numero");
const nome=document.getElementById("nome");
const pse=document.getElementById("pse");
const estatisticas=document.getElementById("estatisticas");
const gr=document.getElementById("gr");
const addBtn=document.getElementById("addPlayerBtn");
const fieldBody=document.querySelector("#fieldPlayersTable tbody");
const goalBody=document.querySelector("#goalKeepersTable tbody");

function esc(s){return s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])):'';}
function notify(msg,err=false){
  const n=document.getElementById("notification");
  n.textContent=msg;n.style.display="block";
  n.style.background=err?"#ffe8e8":"#e8f1ff";
  n.style.color=err?"#b71c1c":"#0047b3";
  setTimeout(()=>n.style.display="none",3500);
}
function getFormData(){return Object.fromEntries(new FormData(jogoForm).entries());}
function setFormData(o={}){for(const el of jogoForm.elements)if(el.name)el.value=o[el.name]||"";}
function setReadOnly(state){
  for(const el of jogoForm.elements){
    if(el.tagName==="SELECT") el.disabled=state;
    else if(el.name) el.readOnly=state;
  }
  editingGame=!state;
}
function gameDocRef(id){return doc(db,`users/${currentUserId}/games/${id}`);}
function playerCol(){return activeGameId?collection(db,`users/${currentUserId}/games/${activeGameId}/players`):null;}
function playerDoc(id){return doc(db,`users/${currentUserId}/games/${activeGameId}/players/${id}`);}

/* ---- GAMES ---- */
async function loadGamesLive(){
  onSnapshot(collection(db,`users/${currentUserId}/games`),snap=>{
    gamesBody.innerHTML="";
    if(snap.empty){
      gamesBody.innerHTML='<tr><td colspan="10" style="text-align:center">Nenhum jogo.</td></tr>';return;
    }
    snap.forEach(docSnap=>{
      const g=docSnap.data();
      const tr=document.createElement("tr");
      if(g.active)tr.classList.add("active-row");
      tr.innerHTML=`<td>${esc(g.escalao)}</td><td>${esc(g.competicao)}</td><td>${esc(g.fase)}</td><td>${esc(g.grupo)}</td>
      <td>${esc(g.jornada)}</td><td>${esc(g.data)} ${esc(g.hora)}</td><td>${esc(g.local)}</td><td>${esc(g.adversario)}</td>
      <td>${g.active?"‚úÖ":""}</td>
      <td><button class="small-btn load" data-id="${docSnap.id}">Load</button>
      <button class="small-btn delete" data-id="${docSnap.id}">Del</button></td>`;
      gamesBody.appendChild(tr);
    });
  });
}

async function loadActiveGame(){
  const q=query(collection(db,`users/${currentUserId}/games`),where("active","==",true));
  const snap=await getDocs(q);
  if(!snap.empty){
    const gdoc=snap.docs[0];
    activeGameId=gdoc.id;
    setFormData(gdoc.data());
    document.getElementById("saveGameBtn").disabled=false;
    setReadOnly(true);
    notify("‚úÖ Jogo ativo carregado");
    subscribePlayers();
  }else{setReadOnly(true);notify("‚ÑπÔ∏è Nenhum jogo ativo encontrado");}
}

/* ---- PLAYERS ---- */
function renderPlayers(tbody,arr){
  tbody.innerHTML="";
  if(!arr.length){tbody.innerHTML='<tr><td colspan="5" style="text-align:center">Sem jogadores.</td></tr>';return;}
  arr.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${p.numero}</td><td>${esc(p.nome)}</td><td>${p.pse?"‚úÖ":""}</td><td>${p.estatisticas?"üìä":""}</td>
      <td><button class="small-btn load" data-id="${p.id}">Edit</button>
      <button class="small-btn delete" data-id="${p.id}">Del</button></td>`;
    tbody.appendChild(tr);
  });
}
function subscribePlayers(){
  if(unsubscribePlayers)unsubscribePlayers();
  if(!activeGameId)return;
  unsubscribePlayers=onSnapshot(playerCol(),snap=>{
    const players=snap.docs.map(d=>d.data());
    const field=players.filter(p=>!p.gr).sort((a,b)=>a.numero-b.numero);
    const gk=players.filter(p=>p.gr).sort((a,b)=>a.numero-b.numero);
    renderPlayers(fieldBody,field);
    renderPlayers(goalBody,gk);
  });
}

/* ---- EVENTS ---- */
document.addEventListener("DOMContentLoaded",async()=>{loadGamesLive();await loadActiveGame();});

document.getElementById("editGameBtn").onclick=()=>{
  if(!activeGameId)return notify("Nenhum jogo ativo",true);
  if(editingGame){setReadOnly(true);notify("üîí Edi√ß√£o bloqueada");}
  else{setReadOnly(false);notify("‚úèÔ∏è Campos edit√°veis");}
};

document.getElementById("newGameBtn").onclick=async()=>{
  const snaps=await getDocs(collection(db,`users/${currentUserId}/games`));
  await Promise.all(snaps.docs.map(d=>setDoc(gameDocRef(d.id),{active:false},{merge:true})));
  const id=crypto.randomUUID();
  const data={escalao:"",competicao:"",fase:"",grupo:"",jornada:"",data:"",hora:"",local:"",adversario:"",active:true,createdAt:new Date().toISOString()};
  await setDoc(gameDocRef(id),data);
  activeGameId=id;setFormData(data);
  document.getElementById("saveGameBtn").disabled=false;
  setReadOnly(false);
  notify("üÜï Novo jogo criado e ativo");
  subscribePlayers();
};

document.getElementById("saveGameBtn").onclick=async()=>{
  if(!activeGameId)return notify("Nenhum jogo ativo",true);
  const d=getFormData();
  const snaps=await getDocs(collection(db,`users/${currentUserId}/games`));
  await Promise.all(snaps.docs.map(s=>setDoc(gameDocRef(s.id),s.id===activeGameId?{...d,active:true}:{active:false},{merge:true})));
  setReadOnly(true);
  notify("üíæ Jogo salvo");
};

document.getElementById("toggleGamesBtn").onclick=()=>document.getElementById("gamesList").classList.toggle("show");

document.getElementById("deleteAllGamesBtn").onclick=async()=>{
  if(!confirm("Apagar todos os jogos?"))return;
  const snaps=await getDocs(collection(db,`users/${currentUserId}/games`));
  await Promise.all(snaps.docs.map(d=>deleteDoc(gameDocRef(d.id))));
  activeGameId=null;setFormData();setReadOnly(true);
  notify("üóëÔ∏è Jogos eliminados");
};

gamesBody.addEventListener("click",async e=>{
  const id=e.target.dataset.id;if(!id)return;
  if(e.target.matches(".load")){
    const snap=await getDoc(gameDocRef(id));if(!snap.exists())return;
    activeGameId=id;setFormData(snap.data());
    document.getElementById("saveGameBtn").disabled=false;
    setReadOnly(true);
    notify("‚úÖ Jogo carregado");
    subscribePlayers();
  }else if(e.target.matches(".delete")){
    if(!confirm("Apagar jogo?"))return;
    await deleteDoc(gameDocRef(id));
    if(activeGameId===id)activeGameId=null;
    notify("üóëÔ∏è Jogo eliminado");
  }
});

/* ---- PLAYERS ---- */
addBtn.onclick=async()=>{
  if(!activeGameId)return notify("Ative um jogo primeiro",true);
  const n=numero.value.trim(),nm=nome.value.trim();
  if(!n||!nm)return notify("N√∫mero e Nome obrigat√≥rios",true);
  const data={numero:Number(n),nome:nm,pse:pse.checked,estatisticas:estatisticas.checked,gr:gr.checked};
  const id=editingPlayerId||crypto.randomUUID();
  await setDoc(playerDoc(id),{id,...data});
  numero.value="";nome.value="";pse.checked=false;estatisticas.checked=false;gr.checked=false;
  editingPlayerId=null;addBtn.textContent="Adicionar";
  notify("‚úÖ Jogador salvo");
};

[fieldBody,goalBody].forEach(t=>t.addEventListener("click",async e=>{
  if(!e.target.dataset.id)return;
  const id=e.target.dataset.id;
  if(e.target.matches(".load")){
    const snap=await getDoc(playerDoc(id));if(!snap.exists())return;
    const p=snap.data();
    numero.value=p.numero;nome.value=p.nome;pse.checked=p.pse;estatisticas.checked=p.estatisticas;gr.checked=p.gr;
    editingPlayerId=id;addBtn.textContent="Atualizar";
    notify("‚úèÔ∏è Editando jogador");
  }else if(e.target.matches(".delete")){
    if(!confirm("Apagar jogador?"))return;
    await deleteDoc(playerDoc(id));
    notify("üóëÔ∏è Jogador eliminado");
  }
}));

document.getElementById("deleteAllPlayersBtn").onclick=async()=>{
  if(!activeGameId)return notify("Nenhum jogo ativo",true);
  if(!confirm("Apagar todos os jogadores?"))return;
  const snaps=await getDocs(playerCol());
  await Promise.all(snaps.docs.map(d=>deleteDoc(playerDoc(d.id))));
  notify("üóëÔ∏è Jogadores eliminados");
};
</script>
</body>
</html>
