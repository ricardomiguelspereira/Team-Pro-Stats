<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Team Pro Stats ‚Äî Gest√£o de Jogos e Jogadores</title>
<style>
:root{
  --primary:#0077ff;
  --danger:#e74c3c;
  --success:#28a745;
  --muted:#f4f7fa;
  --card:#fff;
  --border:#ddd;
  --text:#222;
  --header-bg:#0056cc;
}
*{box-sizing:border-box;}
body{
  font-family:system-ui,Segoe UI,Roboto,Arial;
  margin:0;padding:16px;
  background:var(--muted);
  color:var(--text);
  display:flex;
  justify-content:center;
}
.wrap{
  width:100%;max-width:1100px;
  background:var(--card);
  border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,.1);
  overflow:hidden;
}
header{
  background:var(--header-bg);
  color:#fff;
  text-align:center;
  padding:16px;
  font-weight:700;
  font-size:1.4em;
}
main{padding:24px;}
form{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
}
label{display:block;font-weight:600;font-size:13px;}
input,select{
  width:100%;
  padding:8px;
  margin-top:4px;
  border-radius:6px;
  border:1px solid var(--border);
}
.actions{
  margin-top:16px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
button{
  padding:8px 14px;
  border-radius:6px;
  border:0;
  cursor:pointer;
  font-weight:600;
  transition:.2s;
}
button.primary{background:var(--primary);color:#fff;}
button.primary:hover{background:#0056cc;}
button.success{background:var(--success);color:#fff;}
button.success:hover{background:#1e7e34;}
button.danger{background:var(--danger);color:#fff;}
button.danger:hover{background:#c0392b;}
.notification{
  margin-top:12px;
  padding:12px;
  border-radius:8px;
  display:none;
  font-weight:600;
}
#gamesList{
  margin-top:20px;
  border-top:1px solid var(--border);
  padding-top:12px;
  display:none;
}
#gamesList.show{display:block;}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  border-radius:8px;
  overflow:hidden;
}
th,td{
  border:1px solid var(--border);
  padding:8px;
  text-align:left;
  font-size:13px;
}
th{background:#f0f6ff;}
tr.active-row{background:#e6f7ff;}
tr:hover{background:#f5faff;}
.small-btn{
  padding:6px 8px;
  font-size:13px;
  border-radius:4px;
  border:0;
  cursor:pointer;
  margin-right:4px;
}
.small-btn.load{background:var(--primary);color:#fff;}
.small-btn.delete{background:var(--danger);color:#fff;}
hr{margin:28px 0;border:none;border-top:1px solid var(--border);}
@media(max-width:600px){
  form{grid-template-columns:1fr;}
  th,td{font-size:12px;}
}
footer{
  text-align:center;
  padding:16px 0;
  font-size:0.9em;
  color:#666;
  margin-top:24px;
}
</style>
</head>
<body>

<div class="wrap">
<header>Team Pro Stats ‚Äî Gest√£o de Jogos e Jogadores</header>
<main>

<h2>Gest√£o de Jogos</h2>
<form id="jogoForm" autocomplete="off" novalidate onsubmit="return false;">
  <label>Escal√£o<input name="escalao"/></label>
  <label>Competi√ß√£o<input name="competicao"/></label>
  <label>Fase<input name="fase"/></label>
  <label>Grupo<input name="grupo"/></label>
  <label>Jornada<input name="jornada"/></label>
  <label>Data<input type="date" name="data"/></label>
  <label>Hora<input type="time" name="hora"/></label>
  <label>Local<input name="local"/></label>
  <label>Advers√°rio<input name="adversario"/></label>
</form>

<div class="actions">
  <button class="primary" id="newGameBtn">Novo Jogo</button>
  <button class="success" id="saveGameBtn" disabled>Salvar (Ativar)</button>
  <button class="primary" id="toggleGamesBtn">Mostrar/Ocultar Jogos</button>
  <button class="danger" id="deleteAllGamesBtn">Apagar Todos</button>
</div>

<div id="notification" class="notification"></div>

<div id="gamesList">
  <h3>üìã Jogos Guardados</h3>
  <table>
    <thead>
      <tr><th>Escal√£o</th><th>Competi√ß√£o</th><th>Fase</th><th>Grupo</th><th>Jornada</th><th>Data/Hora</th><th>Local</th><th>Advers√°rio</th><th>Ativo</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody id="gamesTableBody"></tbody>
  </table>
</div>

<hr/>

<h2>Gest√£o de Jogadores</h2>
<div>
  <label>N¬∫:<input type="number" id="numero" min="1" max="99"></label>
  <label>Nome:<input type="text" id="nome"></label>
  <label>PSE:<input type="checkbox" id="pse"></label>
  <label>Estat√≠sticas:<input type="checkbox" id="estatisticas"></label>
  <label>GR:<input type="checkbox" id="gr"></label>
  <button class="primary" id="addPlayerBtn">Adicionar</button>
</div>

<h3>Jogadores de Campo</h3>
<table id="fieldPlayersTable"><thead><tr><th>N¬∫</th><th>Nome</th><th>PSE</th><th>Estat√≠sticas</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>

<h3>Guarda-Redes</h3>
<table id="goalKeepersTable"><thead><tr><th>N¬∫</th><th>Nome</th><th>PSE</th><th>Estat√≠sticas</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>

<button class="danger" id="deleteAllPlayersBtn">Eliminar Todos os Jogadores</button>

</main>
<footer>¬© 2025 Team Pro Stats ¬∑ Powered by RP Technology</footer>
</div>

<script type="module">
import { initializeFirebase, getUserId, getActiveGameId, setActiveGameId } from './firebase-data.js';
import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

let currentUserId, activeGameId;
let unsubscribePlayers = null;
let editingPlayerId = null;

const db = getFirestore();
const jogoForm = document.getElementById('jogoForm');
const gamesBody = document.getElementById('gamesTableBody');
const numero = document.getElementById('numero');
const nome = document.getElementById('nome');
const pse = document.getElementById('pse');
const estatisticas = document.getElementById('estatisticas');
const gr = document.getElementById('gr');
const addBtn = document.getElementById('addPlayerBtn');
const fieldBody = document.querySelector('#fieldPlayersTable tbody');
const goalBody = document.querySelector('#goalKeepersTable tbody');
const delAllPlayers = document.getElementById('deleteAllPlayersBtn');
const notificationEl = document.getElementById('notification');

function esc(s){return s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])):'';}
function showNotification(msg,err=false){ notificationEl.textContent=msg; notificationEl.style.display='block'; notificationEl.style.background=err?'#ffe8e8':'#e8f1ff'; notificationEl.style.color=err?'#b71c1c':'#0047b3'; setTimeout(()=>notificationEl.style.display='none',3500);}
function getFormData(){return {escalao:jogoForm.escalao.value,competicao:jogoForm.competicao.value,fase:jogoForm.fase.value,grupo:jogoForm.grupo.value,jornada:jogoForm.jornada.value,data:jogoForm.data.value,hora:jogoForm.hora.value,local:jogoForm.local.value,adversario:jogoForm.adversario.value};}
function setFormData(o={}){for(const el of jogoForm.elements) if(el.name) el.value=o[el.name]||'';}
function playerColRef(){return activeGameId?collection(db, `users/${currentUserId}/games/${activeGameId}/players`):null;}
function gameDocRef(id){return doc(db, `users/${currentUserId}/games/${id}`);}
function playerDocRef(id){return doc(db, `users/${currentUserId}/games/${activeGameId}/players/${id}`);}

function renderPlayers(players){
  fieldBody.innerHTML=''; goalBody.innerHTML='';
  players.sort((a,b)=>a.numero-b.numero);
  const field = players.filter(p=>!p.gr); const goal = players.filter(p=>p.gr);
  field.forEach(p=>fieldBody.insertAdjacentHTML('beforeend', `<tr><td>${p.numero}</td><td>${esc(p.nome)}</td><td>${p.pse?'‚úîÔ∏è':''}</td><td>${p.estatisticas?'‚úîÔ∏è':''}</td><td><button class="small-btn load" data-id="${p.id}">Editar</button><button class="small-btn delete" data-id="${p.id}">Del</button></td></tr>`));
  goal.forEach(p=>goalBody.insertAdjacentHTML('beforeend', `<tr><td>${p.numero}</td><td>${esc(p.nome)}</td><td>${p.pse?'‚úîÔ∏è':''}</td><td>${p.estatisticas?'‚úîÔ∏è':''}</td><td><button class="small-btn load" data-id="${p.id}">Editar</button><button class="small-btn delete" data-id="${p.id}">Del</button></td></tr>`));
}

function subscribePlayers(){
  if(unsubscribePlayers) unsubscribePlayers();
  if(!activeGameId) return;
  const colRef = playerColRef();
  unsubscribePlayers = onSnapshot(colRef, snap=>{
    const players = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderPlayers(players);
  });
}

async function loadGames(){
  const snaps = await getDocs(collection(db, `users/${currentUserId}/games`));
  gamesBody.innerHTML='';
  if(snaps.empty){ gamesBody.innerHTML='<tr><td colspan="10" style="text-align:center">Nenhum jogo.</td></tr>'; return; }
  const games = snaps.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));
  games.forEach(g=>{
    const tr=document.createElement('tr'); if(g.active) tr.classList.add('active-row');
    tr.innerHTML=`<td>${esc(g.escalao)}</td><td>${esc(g.competicao)}</td><td>${esc(g.fase)}</td><td>${esc(g.grupo)}</td><td>${esc(g.jornada)}</td><td>${esc(g.data)} ${esc(g.hora)}</td><td>${esc(g.local)}</td><td>${esc(g.adversario)}</td><td>${g.active?'‚úÖ':''}</td><td><button class="small-btn load" data-id="${g.id}">Load</button><button class="small-btn delete" data-id="${g.id}">Del</button></td>`;
    gamesBody.appendChild(tr);
  });
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await initializeFirebase();
  currentUserId = getUserId();
  activeGameId = getActiveGameId();
  await loadGames();
  subscribePlayers();
});

// Player add/edit/delete
addBtn.onclick = async ()=>{
  if(!activeGameId) return showNotification("Ative um jogo primeiro", true);
  const n=numero.value, nm=nome.value.trim(); if(!n||!nm) return showNotification("N√∫mero e Nome obrigat√≥rios", true);
  const data={numero:n,nome:nm,pse:pse.checked,estatisticas:estatisticas.checked,gr:gr.checked,id:editingPlayerId||crypto.randomUUID()};
  await setDoc(playerDocRef(data.id), data);
  numero.value=""; nome.value=""; pse.checked=false; estatisticas.checked=false; gr.checked=false; editingPlayerId=null; addBtn.textContent="Adicionar";
  showNotification("‚úÖ Jogador salvo");
};

[fieldBody, goalBody].forEach(table => table.addEventListener('click', async e=>{
  if(!e.target.dataset.id) return; const id=e.target.dataset.id;
  if(e.target.matches('.load')){
    const snap = await getDoc(playerDocRef(id)); if(!snap.exists()) return;
    const p = snap.data(); numero.value=p.numero; nome.value=p.nome; pse.checked=p.pse; estatisticas.checked=p.estatisticas; gr.checked=p.gr; editingPlayerId=id; addBtn.textContent="Atualizar"; showNotification("‚úèÔ∏è Editando jogador");
  }else if(e.target.matches('.delete')){
    if(!confirm("Apagar jogador?")) return; await deleteDoc(playerDocRef(id)); showNotification("üóëÔ∏è Jogador eliminado");
  }
}));

delAllPlayers.onclick=async ()=>{ 
  if(!activeGameId) return showNotification("Nenhum jogo ativo",true);
  if(!confirm("Apagar todos os jogadores do jogo ativo?")) return;
  const snaps=await getDocs(playerColRef()); await Promise.all(snaps.docs.map(d=>deleteDoc(playerDocRef(d.id)))); showNotification("üóëÔ∏è Todos os jogadores eliminados");
};
</script>
</body>
</html>
