<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Team Pro Stats ‚Äî Gest√£o de Jogos e Estat√≠sticas</title>
<style>
:root {
  --primary:#0077ff; --success:#28a745; --danger:#e74c3c; --muted:#f4f7fa;
  --card:#fff; --border:#ddd; --text:#222;
}
*{box-sizing:border-box;}
body{margin:0; font-family:Segoe UI, Arial, sans-serif; background:var(--muted); color:var(--text);}
header{background:var(--primary); color:#fff; padding:16px; text-align:center; font-size:1.4em; font-weight:700;}
main{max-width:1200px; margin:20px auto; padding:20px; background:var(--card); border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1);}
h2{margin-top:0; text-align:center;}
form{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px;}
label{display:block; font-size:13px; font-weight:600; margin-bottom:4px;}
input,select{width:100%; padding:8px; border-radius:6px; border:1px solid var(--border);}
button{padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:600;}
button.primary{background:var(--primary); color:#fff;}
button.success{background:var(--success); color:#fff;}
button.danger{background:var(--danger); color:#fff;}
.notification{position:fixed; top:16px; right:16px; padding:12px 18px; background:#e8f1ff; color:#0047b3; font-weight:600; border-radius:8px; display:none; box-shadow:0 3px 12px rgba(0,0,0,0.2);}
.notification.error{background:#ffe8e8; color:#b71c1c;}
.table-wrap{overflow-x:auto; margin-top:12px;}
table{width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
th,td{padding:10px; border-bottom:1px solid var(--border); font-size:13px; text-align:center;}
th{background:#f0f6ff;}
tr.active-row{background:#e6f7ff;}
.small-btn{padding:4px 6px; font-size:12px; border-radius:4px; margin:2px;}
.small-btn.load{background:var(--primary); color:#fff;}
.small-btn.delete{background:var(--danger); color:#fff;}
.tabs{display:flex; justify-content:center; gap:6px; margin:20px 0;}
.tab-btn{padding:8px 16px; border:none; border-radius:6px; background:#2980b9; color:#fff; cursor:pointer; transition:0.2s; font-weight:500;}
.tab-btn.active{background:#1c5980;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.stat-controls{display:flex; justify-content:center; gap:4px;}
.stat-controls input{width:50px; text-align:center; border-radius:6px; border:1px solid #ccc;}
#loading{display:flex; justify-content:center; align-items:center; font-weight:bold; padding:20px;}
@media(max-width:600px){form{grid-template-columns:1fr;} th,td{font-size:12px;}}
</style>
</head>
<body>
<header>Team Pro Stats ‚Äî Gest√£o de Jogos e Estat√≠sticas</header>
<div class="notification" id="notification"></div>
<main>
<h2>Gest√£o de Jogos</h2>
<form id="jogoForm" autocomplete="off" novalidate>
  <label>Escal√£o<input name="escalao"/></label>
  <label>Competi√ß√£o<input name="competicao"/></label>
  <label>Fase<input name="fase"/></label>
  <label>Grupo<input name="grupo"/></label>
  <label>Jornada<input name="jornada"/></label>
  <label>Data<input type="date" name="data"/></label>
  <label>Hora<input type="time" name="hora"/></label>
  <label>Local<input name="local"/></label>
  <label>Advers√°rio<input name="adversario"/></label>
</form>
<div style="margin-top:12px;">
  <button class="primary" id="newGameBtn">Novo Jogo</button>
  <button class="success" id="saveGameBtn" disabled>Salvar (Ativar)</button>
  <button class="primary" id="toggleGamesBtn">Mostrar/Ocultar Jogos</button>
  <button class="danger" id="deleteAllGamesBtn">Apagar Todos</button>
</div>
<div id="gamesList" class="table-wrap" style="display:none;">
  <h3>üìã Jogos Guardados</h3>
  <table>
    <thead>
      <tr><th>Escal√£o</th><th>Competi√ß√£o</th><th>Fase</th><th>Grupo</th><th>Jornada</th><th>Data/Hora</th><th>Local</th><th>Advers√°rio</th><th>Ativo</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody id="gamesTableBody"></tbody>
  </table>
</div>

<hr/>
<h2>Gest√£o de Jogadores</h2>
<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:8px; align-items:end;">
  <label>N¬∫:<input type="number" id="numero" min="1" max="99"></label>
  <label>Nome:<input type="text" id="nome"></label>
  <label>PSE:<input type="checkbox" id="pse"></label>
  <label>Estat√≠sticas:<input type="checkbox" id="estatisticas"></label>
  <label>GR:<input type="checkbox" id="gr"></label>
  <button class="primary" id="addPlayerBtn">Adicionar</button>
</div>

<h3>Jogadores de Campo</h3>
<div class="table-wrap">
<table id="fieldPlayersTable"><thead><tr><th>N¬∫</th><th>Nome</th><th>PSE</th><th>Estat√≠sticas</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
</div>
<h3>Guarda-Redes</h3>
<div class="table-wrap">
<table id="goalKeepersTable"><thead><tr><th>N¬∫</th><th>Nome</th><th>PSE</th><th>Estat√≠sticas</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
</div>
<button class="danger" id="deleteAllPlayersBtn">Eliminar Todos os Jogadores</button>

<h2>Estat√≠sticas do Jogo Ativo</h2>
<div class="tabs">
  <button class="tab-btn active" data-tab="part1">1¬™ Parte</button>
  <button class="tab-btn" data-tab="part2">2¬™ Parte</button>
</div>
<div id="loading">A carregar jogadores e estat√≠sticas...</div>

<div id="part1" class="tab-content active">
  <div class="table-wrap"><table id="tableCampo1"><thead><tr><th>#</th><th>Nome</th><th>Interceptados</th><th>Fora</th><th>Golos</th><th>Passes Errados</th><th>Faltas</th></tr></thead><tbody></tbody></table></div>
  <div class="table-wrap"><table id="tableGR1"><thead><tr><th>#</th><th>Nome</th><th>Defesas</th><th>Interceptados</th><th>Golos Sofridos</th><th>Faltas</th></tr></thead><tbody></tbody></table></div>
</div>
<div id="part2" class="tab-content">
  <div class="table-wrap"><table id="tableCampo2"><thead><tr><th>#</th><th>Nome</th><th>Interceptados</th><th>Fora</th><th>Golos</th><th>Passes Errados</th><th>Faltas</th></tr></thead><tbody></tbody></table></div>
  <div class="table-wrap"><table id="tableGR2"><thead><tr><th>#</th><th>Nome</th><th>Defesas</th><th>Interceptados</th><th>Golos Sofridos</th><th>Faltas</th></tr></thead><tbody></tbody></table></div>
</div>
<div id="lastSaved" style="font-size:12px; margin-top:10px;"></div>

<script type="module">
import {
  initializeFirebase,
  getUserId,
  getActiveGameId,
  setActiveGameId,
  onFirebaseDataChange,
  saveSingleStat,
  getFirebaseData,
  FB_PATHS_GAME
} from './firebase-data.js';
import { doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

let currentUserId, activeGameId, unsubscribePlayers=null;
const jogoForm = document.getElementById('jogoForm');
const gamesBody = document.getElementById('gamesTableBody');
const numero=document.getElementById('numero'), nome=document.getElementById('nome'), pse=document.getElementById('pse'), estatisticas=document.getElementById('estatisticas'), gr=document.getElementById('gr');
const addBtn=document.getElementById('addPlayerBtn'), fieldBody=document.querySelector('#fieldPlayersTable tbody'), goalBody=document.querySelector('#goalKeepersTable tbody');
const delAllPlayers=document.getElementById('deleteAllPlayersBtn');
const notificationEl=document.getElementById('notification'), lastSavedEl=document.getElementById('lastSaved'), loadingEl=document.getElementById('loading');
let fieldPlayers=[], goalKeepers=[], statsParte1={campo:{},gr:{}}, statsParte2={campo:{},gr:{}};
const campoStats=['interceptados','fora','golos','passesErrados','faltas'], grStats=['defesas','interceptados','golosSofridos','faltas'];

function esc(s){ return s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])):''; }
function showNotification(msg,err=false){notificationEl.textContent=msg; notificationEl.className=err?'notification error':'notification'; notificationEl.style.display='block'; setTimeout(()=>notificationEl.style.display='none',2500);}
function getFormData(){const d={}; for(const el of jogoForm.elements) if(el.name)d[el.name]=el.value||''; return d;}
function setFormData(o={}){for(const el of jogoForm.elements) if(el.name)el.value=o[el.name]||'';}
function playerColRef(){if(!currentUserId||!activeGameId)return null; return `users/${currentUserId}/games/${activeGameId}/players`;}

// Render players tables
function renderPlayers(players){
  fieldBody.innerHTML=''; goalBody.innerHTML='';
  const field=players.filter(p=>!p.gr), goal=players.filter(p=>p.gr);
  field.forEach(p=>fieldBody.insertAdjacentHTML('beforeend',`<tr><td>${p.numero}</td><td>${esc(p.nome)}</td><td>${p.pse?'‚úîÔ∏è':''}</td><td>${p.estatisticas?'‚úîÔ∏è':''}</td><td><button class="small-btn load" data-id="${p.id}">Editar</button><button class="small-btn delete" data-id="${p.id}">Del</button></td></tr>`));
  goal.forEach(p=>goalBody.insertAdjacentHTML('beforeend',`<tr><td>${p.numero}</td><td>${esc(p.nome)}</td><td>${p.pse?'‚úîÔ∏è':''}</td><td>${p.estatisticas?'‚úîÔ∏è':''}</td><td><button class="small-btn load" data-id="${p.id}">Editar</button><button class="small-btn delete" data-id="${p.id}">Del</button></td></tr>`));
}
function subscribePlayers(){if(unsubscribePlayers)unsubscribePlayers(); const path=playerColRef(); if(!path) return; unsubscribePlayers=onFirebaseDataChange(path,data=>{fieldPlayers=(data||[]).filter(p=>!p.gr).sort((a,b)=>a.numero-b.numero); goalKeepers=(data||[]).filter(p=>p.gr).sort((a,b)=>a.numero-b.numero); renderStatsTables(); renderPlayers(data||[]);});}

// Render stats
function renderTable(tableId, players, statsMap, statKeys){
  const tbody=document.querySelector(`#${tableId} tbody`); tbody.innerHTML='';
  players.forEach(p=>{
    const row=tbody.insertRow(); row.dataset.player=p.numero;
    row.innerHTML=`<td>${p.numero}</td><td>${p.nome}${p.gr?' üß§':''}</td>`+statKeys.map(k=>`<td><div class="stat-controls"><button onclick="changeStat(this,-1)">‚àí</button><input type="number" min="0" value="${statsMap[p.numero]?.[k]||0}" data-player="${p.numero}" data-category="${tableId.includes('Campo')?'campo':'gr'}" data-part="${tableId.includes('1')?'1':'2'}" data-stat="${k}"><button onclick="changeStat(this,1)">+</button></div></td>`).join('');
  });
}
function renderStatsTables(){
  renderTable('tableCampo1', fieldPlayers, statsParte1.campo, campoStats);
  renderTable('tableGR1', goalKeepers, statsParte1.gr, grStats);
  renderTable('tableCampo2', fieldPlayers, statsParte2.campo, campoStats);
  renderTable('tableGR2', goalKeepers, statsParte2.gr, grStats);
  loadingEl.style.display='none';
}
window.changeStat=async function(btn,delta){
  const input=btn.parentElement.querySelector('input');
  let val=parseInt(input.value)||0; val+=delta; if(val<0)val=0; input.value=val;
  const {player,category,part,stat:statKey}=input.dataset;
  const stats=part==='1'?statsParte1:statsParte2;
  if(!stats[category]) stats[category]={}; if(!stats[category][player]) stats[category][player]={};
  stats[category][player][statKey]=val;
  try{await saveSingleStat(part,category,player,statKey,val); lastSavedEl.textContent=`√öltima grava√ß√£o: ${new Date().toLocaleTimeString('pt-PT')}`; showNotification(`Guardado: ${statKey} (${val}) ‚Äî #${player}`);}catch(e){console.error(e); showNotification('Erro ao guardar',true);}
};

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); document.getElementById(btn.dataset.tab).classList.add('active');}));

// Firebase setup
document.addEventListener('DOMContentLoaded', async ()=>{
  await initializeFirebase(); currentUserId=getUserId(); activeGameId=getActiveGameId();
  if(!currentUserId||!activeGameId){alert('Nenhum jogo ativo!'); return;}
  await loadGames();
  subscribePlayers();

  // Stats listeners
  const path1=FB_PATHS_GAME.estatisticasParte1.replace("{uid}",currentUserId).replace("{gameId}",activeGameId);
  const path2=FB_PATHS_GAME.estatisticasParte2.replace("{uid}",currentUserId).replace("{gameId}",activeGameId);
  onFirebaseDataChange(path1,data=>{statsParte1=data||{campo:{},gr:{}}; renderStatsTables();});
  onFirebaseDataChange(path2,data=>{statsParte2=data||{campo:{},gr:{}}; renderStatsTables();});
});

// GAME MANAGEMENT BUTTONS (reuse previous jogos.html logic)
async function loadGames(){
  const path=`users/${currentUserId}/games`; const snaps=await getFirebaseData(path); gamesBody.innerHTML='';
  if(!snaps.length){ gamesBody.innerHTML='<tr><td colspan="10" style="text-align:center">Nenhum jogo.</td></tr>'; return; }
  snaps.sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||'')).forEach(g=>{const tr=document.createElement('tr'); if(g.active)tr.classList.add('active-row'); tr.innerHTML=`<td>${esc(g.escalao)}</td><td>${esc(g.competicao)}</td><td>${esc(g.fase)}</td><td>${esc(g.grupo)}</td><td>${esc(g.jornada)}</td><td>${esc(g.data)} ${esc(g.hora)}</td><td>${esc(g.local)}</td><td>${esc(g.adversario)}</td><td>${g.active?'‚úÖ':''}</td><td><button class="small-btn load" data-id="${g.id}">Load</button><button class="small-btn delete" data-id="${g.id}">Del</button></td>`; gamesBody.appendChild(tr); });
}

document.getElementById('newGameBtn').onclick=async()=>{
  const path=`users/${currentUserId}/games`; const data={escalao:'',competicao:'',fase:'',grupo:'',jornada:'',data:'',hora:'',local:'',adversario:'',active:true,createdAt:new Date().toISOString()};
  const snaps=await getFirebaseData(path); await Promise.all(snaps.map(d=>setDoc(doc(`users/${currentUserId}/games`,d.id),{active:false},{merge:true})));
  const newId=crypto.randomUUID(); await setDoc(doc(`users/${currentUserId}/games`,newId),data); activeGameId=newId; setActiveGameId(newId); setFormData(data); document.getElementById('saveGameBtn').disabled=false; await loadGames(); subscribePlayers(); showNotification('üÜï Novo jogo criado e ativo');
};
document.getElementById('saveGameBtn').onclick=async()=>{if(!activeGameId){showNotification('Crie ou carregue um jogo antes',true);return;} const d=getFormData(); const path=`users/${currentUserId}/games`; const snaps=await getFirebaseData(path); await Promise.all(snaps.map(s=>setDoc(doc(`users/${currentUserId}/games`,s.id),s.id===activeGameId?{...d,active:true}:{active:false},{merge:true}))); await loadGames(); showNotification('üíæ Jogo salvo');};
document.getElementById('toggleGamesBtn').onclick=()=>document.getElementById('gamesList').classList.toggle('show');
gamesBody.addEventListener('click',async e=>{if(e.target.matches('.load')){const id=e.target.dataset.id; const snap=await getFirebaseData(`users/${currentUserId}/games/${id}`); if(!snap){showNotification('Jogo n√£o encontrado',true);return;} activeGameId=id; setActiveGameId(id); setFormData(snap); subscribePlayers(); showNotification('‚úÖ Jogo carregado');}else if(e.target.matches('.delete')){const id=e.target.dataset.id; if(confirm('Apagar jogo?')){await deleteDoc(doc(`users/${currentUserId}/games`,id)); if(activeGameId===id){activeGameId=null; setActiveGameId(null);} await loadGames(); showNotification('üóëÔ∏è Jogo eliminado');}}});
delAllPlayers.onclick=async()=>{if(!activeGameId){showNotification('Nenhum jogo ativo',true);return;} if(confirm('Apagar todos os jogadores do jogo ativo?')){const path=playerColRef(); const snaps=await getFirebaseData(path); await Promise.all((snaps||[]).map(p=>deleteDoc(doc(path,p.id)))); showNotification('üóëÔ∏è Todos os jogadores eliminados');}};
addBtn.onclick=async()=>{if(!activeGameId){showNotification('Ative um jogo primeiro',true);return;} const n=numero.value, nm=nome.value.trim(); if(!n||!nm){showNotification('N√∫mero e Nome obrigat√≥rios',true);return;} const data={numero:n,nome:nm,pse:pse.checked,estatisticas:estatisticas.checked,gr:gr.checked,id:crypto.randomUUID()}; const path=playerColRef(); await setDoc(doc(path,data.id),data); numero.value=''; nome.value=''; pse.checked=false; estatisticas.checked=false; gr.checked=false; showNotification('‚ûï Jogador adicionado');};
</script>
</main>
<footer style="text-align:center; padding:12px; color:#666; margin-top:20px;">¬© 2025 Team Pro Stats ¬∑ Powered by RP Technology</footer>
</body>
</html>
