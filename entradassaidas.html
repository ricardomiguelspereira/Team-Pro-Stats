<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entradas / Saídas</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f3f5f7;
  margin: 0;
  padding: 20px;
  color: #222;
}
h2 {
  text-align: center;
  margin-bottom: 16px;
}
.tabs {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 18px;
}
.tab-btn, .nav-btn {
  padding: 10px 18px;
  border: none;
  border-radius: 6px;
  background: #888;
  color: white;
  cursor: pointer;
  font-weight: 500;
  transition: 0.25s;
}
.tab-btn.active {
  background: #28a745;
}
.nav-btn {
  background: #0077ff;
}
.nav-btn:hover {
  background: #0047b3;
}
.responsive-inout {
  overflow-x: auto;
  margin-bottom: 20px;
}
table {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  font-size: 14px;
}
th, td {
  padding: 6px;
  text-align: center;
  border-bottom: 1px solid #eee;
}
th {
  background: #f5f7fa;
  font-weight: 600;
}
tr:hover {
  background: #f9f9f9;
}
td.clickable {
  cursor: pointer;
  transition: 0.2s;
}
td.clickable:hover {
  background: #e0f7fa;
}
#notification {
  display: none;
  position: fixed;
  top: 14px;
  right: 14px;
  background: #e8f1ff;
  color: #0047b3;
  padding: 10px 14px;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
footer {
  text-align: center;
  padding: 14px;
  font-size: 0.85em;
  color: #555;
  margin-top: 20px;
}
</style>
</head>
<body>

<h2>Entradas / Saídas</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="part1">1ª Parte</button>
  <button class="tab-btn" data-tab="part2">2ª Parte</button>
  <button id="backStats" class="nav-btn">Estatísticas</button>
</div>

<div id="part1" class="tab-content active">
  <div class="responsive-inout">
    <table id="tableInOut1">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="part2" class="tab-content">
  <div class="responsive-inout">
    <table id="tableInOut2">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="notification"></div>

<footer>© 2025 Team Pro Stats · Powered by RP Technology</footer>

<script type="module">
import {
  db, getFirebaseCollection, setFirebaseDoc, getFirebaseDoc
} from "./firebase-data.js";
import {
  collection, query, where, getDocs, doc, getDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

let userId = "user1";
let activeGameId = null;
let fieldPlayers = [];
let goalKeepers = [];
let inOutData = {};

// interval sets per "Escalão"
const intervalsDefault = ["25","24'30","24","23'30","22","21'30","21","20'30","20","19'30","19","18'30","18","17'30","17","16'30","16","15'30","15","14'30","14","13'30","13","12'30","12","11'30","11","10'30","10","9'30","9","8'30","8","7'30","7","6'30","6","5'30","5","4'30","4","3'30","3","2'30","2","1'30","1","30"];
const intervalsSub13 = ["18","17'30","17","16'30","16","15'30","15","14'30","14","13'30","13","12'30","12","11'30","11","10'30","10","9'30","9","8'30","8","7'30","7","6'30","6","5'30","5","4'30","4","3'30","3","2'30","2","1'30","1","30"];
const intervalsSub15_17 = ["20","19'30","19","18'30","18","17'30","17","16'30","16","15'30","15","14'30","14","13'30","13","12'30","12","11'30","11","10'30","10","9'30","9","8'30","8","7'30","7","6'30","6","5'30","5","4'30","4","3'30","3","2'30","2","1'30","1","30"];

function getIntervalsForLevel(level) {
  switch(level){
    case "Sub-13": return intervalsSub13;
    case "Sub-15": 
    case "Sub-17": return intervalsSub15_17;
    case "Sub-19":
    case "Sub-23":
    case "Séniores":
    default: return intervalsDefault;
  }
}

const notification = document.getElementById('notification');
function showNotification(msg, err=false){
  notification.textContent = msg;
  notification.style.background = err ? '#ffe8e8' : '#e8f1ff';
  notification.style.color = err ? '#b71c1c' : '#0047b3';
  notification.style.display = 'block';
  setTimeout(()=>notification.style.display='none',2500);
}

// get active game
async function findActiveGame(){
  const q = query(collection(db,`users/${userId}/games`), where("active","==",true));
  const snaps = await getDocs(q);
  if(!snaps.empty){
    const active = snaps.docs[0];
    activeGameId = active.id;
    await loadPlayers();
  } else {
    alert("Nenhum jogo ativo encontrado. Redirecionando...");
    window.location.href="configjogoequipa.html";
  }
}

// load players from active game
async function loadPlayers(){
  const players = await getFirebaseCollection(`users/${userId}/games/${activeGameId}/players`);
  const eligible = players.filter(p => p.estatisticas === true);
  fieldPlayers = eligible.filter(p => !p.gr).sort((a,b)=>a.numero-b.numero);
  goalKeepers = eligible.filter(p => p.gr).sort((a,b)=>a.numero-b.numero);
  await loadInOut();
}

// load In/Out data
async function loadInOut(){
  const docsSnap = await getFirebaseCollection(`users/${userId}/games/${activeGameId}/inout`);
  inOutData = {};
  docsSnap.forEach(docSnap => {
    const d = docSnap;
    inOutData[d.id] = d.data().value || '';
  });
  renderInOutTables();
}

async function getGameLevel(){
  const gameDoc = await getFirebaseDoc(`users/${userId}/games/${activeGameId}`);
  return gameDoc?.escalao || "Séniores";
}

// render tables
async function renderInOutTables(){
  const level = await getGameLevel();
  const intervals = getIntervalsForLevel(level);
  const allPlayers = [...fieldPlayers, ...goalKeepers];

  ['1','2'].forEach(part=>{
    const table = document.getElementById(`tableInOut${part}`);
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    thead.innerHTML = `<tr><th>#</th><th>Nome</th>${intervals.map(iv=>`<th>${iv}</th>`).join('')}</tr>`;
    tbody.innerHTML = '';
    allPlayers.forEach(p=>{
      const row = document.createElement('tr');
      row.innerHTML = `<td>${p.numero}</td><td>${p.nome}</td>`;
      intervals.forEach(iv=>{
        const cell = document.createElement('td');
        const key = `${part}_${p.numero}_${iv}`;
        const current = inOutData[key] || '';
        cell.textContent = current;
        cell.dataset.key = key;
        cell.classList.add('clickable');
        updateCellColor(cell, current);
        cell.addEventListener('click', async ()=>{
          let newVal = '';
          if(cell.textContent === '') newVal='E';
          else if(cell.textContent === 'E') newVal='S';
          else newVal='';
          cell.textContent = newVal;
          updateCellColor(cell, newVal);
          try {
            await setFirebaseDoc(`users/${userId}/games/${activeGameId}/inout/${key}`, { value: newVal });
            inOutData[key] = newVal;
          } catch(err){
            console.error(err);
            showNotification("Erro ao guardar alteração", true);
          }
        });
        row.appendChild(cell);
      });
      tbody.appendChild(row);
    });
  });
}

function updateCellColor(cell, val){
  if(val==='E'){cell.style.background='green';cell.style.color='white';}
  else if(val==='S'){cell.style.background='orange';cell.style.color='white';}
  else {cell.style.background='';cell.style.color='';}
}

// tabs
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
    localStorage.setItem('activeInOutTab', btn.dataset.tab);
  });
});

// back button
document.getElementById('backStats').addEventListener('click',()=>{
  window.location.href = 'estatisticas.html';
});

// initialize
document.addEventListener('DOMContentLoaded', async ()=>{
  await findActiveGame();
  const savedTab = localStorage.getItem('activeInOutTab');
  if(savedTab){
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelector(`.tab-btn[data-tab="${savedTab}"]`)?.classList.add('active');
    document.getElementById(savedTab)?.classList.add('active');
  }
});
</script>
</body>
</html>
