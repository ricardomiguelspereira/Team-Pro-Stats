<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Entradas / SaÃ­das</title>

<!-- Import Roboto font -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Roboto',sans-serif;
  background:#f3f5f7;margin:0;padding:20px;color:#222;
}
h2{text-align:center;margin-bottom:16px;}
.tabs{display:flex;justify-content:center;gap:6px;flex-wrap:wrap;margin-bottom:18px;}
.tab-btn{
  padding:10px 18px;border:none;border-radius:6px;background:#888;
  color:#fff;cursor:pointer;font-weight:500;transition:.25s;
}
.tab-btn.active{background:#28a745;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.responsive{overflow-x:auto;margin-bottom:20px;}

table{
  border-collapse:collapse;width:100%;background:#fff;
  border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,.08);
  font-size:13px;
}
th,td{
  padding:6px;text-align:center;
  border:1px solid #ccc;
  height:48px;cursor:pointer;
}
th{
  background:#3399ff;font-weight:700;color:#000;
  position:sticky;top:0;z-index:2;
  white-space:nowrap;
}
th.time-col{
  transform:rotate(-90deg);
  transform-origin:center center;
  width:32px; /* Reduced time column width */
  white-space:nowrap;
}
th:first-child,td:first-child{
  position:sticky;left:0;background:#fefefe;z-index:3;font-weight:600;
  min-width:40px;
}
th:nth-child(2),td:nth-child(2){
  position:sticky;left:60px;background:#fefefe;z-index:3;
  text-align:left;padding-left:6px;
  min-width:180px; /* Wide enough for full player names */
}

/* Alternate row colors for all cells including # and Nome */
tr:nth-child(even) td{background:#e0e0e0;}
tr:nth-child(odd) td{background:#ffffff;}

/* Header colors */
td.e-cell{background:#2ecc71;color:#000;font-weight:600;}
td.s-cell{background:#e74c3c;color:#000;font-weight:600;}
td.saving{background:#fff3cd!important;}
td.saved{background:#d4edda!important;transition:background .6s ease;}

.reset-buttons{
  display:flex;justify-content:center;flex-wrap:wrap;
  gap:10px;margin:10px 0 14px;
}
.reset-buttons button{
  padding:10px 20px;border-radius:6px;border:none;
  background:#e74c3c;color:#fff;font-weight:600;cursor:pointer;
}
.reset-buttons button:hover{background:#b71c1c;}

#notification{
  display:none;position:fixed;top:14px;right:14px;
  background:#e8f1ff;color:#0047b3;padding:10px 14px;
  border-radius:8px;font-weight:600;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);z-index:999;
}

footer{text-align:center;padding:14px;font-size:.85em;color:#555;margin-top:20px;}

@media(max-width:768px){
  table{font-size:11px;}
  th,td{min-width:28px;height:44px;}
}
</style>
</head>
<body>

<h2>Entradas / SaÃ­das</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="part1">1Âª Parte</button>
  <button class="tab-btn" data-tab="part2">2Âª Parte</button>
  <button class="tab-btn" onclick="window.location.href='estatisticas.html'">ðŸ“Š EstatÃ­sticas</button>
</div>

<div id="notification"></div>

<div id="part1" class="tab-content active">
  <div class="responsive"><table id="tableParte1"><thead></thead><tbody></tbody></table></div>
</div>

<div id="part2" class="tab-content">
  <div class="responsive"><table id="tableParte2"><thead></thead><tbody></tbody></table></div>
</div>

<div class="reset-buttons">
  <button id="resetPart1Btn">Reset 1Âª Parte</button>
  <button id="resetPart2Btn">Reset 2Âª Parte</button>
  <button id="resetAllBtn">Reset Tudo</button>
</div>

<footer>Â© 2025 Team Pro Stats Â· Entradas / SaÃ­das</footer>

<script type="module">
import { db, getFirebaseCollection, setFirebaseDoc } from "./firebase-data.js";
import { collection, query, where, getDocs, deleteField, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

let userId="user1",activeGameId=null;
let fieldPlayers=[],goalKeepers=[];
const localCache={parte1:{},parte2:{}};

// Time columns (25:00 â†’ 00:30)
const times=[];
for(let sec=25*60;sec>=30;sec-=30){
  const m=Math.floor(sec/60),s=sec%60;
  times.push(`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`);
}

const notification=document.getElementById("notification");
function notify(msg,err=false){
  notification.textContent=msg;
  notification.style.background=err?"#ffe8e8":"#e8f1ff";
  notification.style.color=err?"#b71c1c":"#0047b3";
  notification.style.display="block";
  setTimeout(()=>notification.style.display="none",2000);
}

function createHeader(){
  const cols=["#","Nome",...times];
  return "<tr>"+cols.map(c=>{
    if(c==="#"||c==="Nome") return `<th>${c}</th>`;
    return `<th class='time-col'>${c}</th>`;
  }).join("")+"</tr>";
}

function renderTable(tableId,data){
  const table=document.getElementById(tableId);
  table.querySelector("thead").innerHTML=createHeader();
  const tb=table.querySelector("tbody");
  tb.innerHTML="";
  const combined=[...fieldPlayers,...goalKeepers];
  combined.forEach((p,rowIndex)=>{
    const row=document.createElement("tr");
    let cells=`<td>${p.numero}</td><td>${p.nome}${p.gr?" (GR)":""}</td>`;
    times.forEach(t=>{
      const val=data[p.numero]?.[t]||"";
      const cls=val==="E"?"e-cell":val==="S"?"s-cell":"";
      cells+=`<td class="${cls}" data-player="${p.numero}" data-time="${t}" data-part="${tableId.includes("1")?"parte1":"parte2"}">${val}</td>`;
    });
    row.innerHTML=cells;
    tb.appendChild(row);
  });
}

async function saveCell(part,player,time,val,td){
  try{
    td.classList.add("saving");
    localCache[part][player]=localCache[part][player]||{};
    if(val==="") delete localCache[part][player][time];
    else localCache[part][player][time]=val;
    const path=`users/${userId}/games/${activeGameId}/entradasSaidas/${part}`;
    await setFirebaseDoc(path,{[player]:{[time]:val===""?deleteField():val}});
    td.classList.remove("saving");
    td.classList.add("saved");
    setTimeout(()=>td.classList.remove("saved"),800);
  }catch(e){console.error(e);td.classList.remove("saving");notify("Erro ao guardar",true);}
}

function listenRealtime(){
  ["parte1","parte2"].forEach(part=>{
    const colRef=collection(db,`users/${userId}/games/${activeGameId}/entradasSaidas`);
    onSnapshot(colRef,snap=>{
      const parte1={},parte2={};
      snap.forEach(doc=>{
        if(doc.id==="parte1")Object.assign(parte1,doc.data());
        if(doc.id==="parte2")Object.assign(parte2,doc.data());
      });
      localCache.parte1=parte1;localCache.parte2=parte2;
      renderTable("tableParte1",parte1);
      renderTable("tableParte2",parte2);
    });
  });
}

async function loadPlayers(){
  const ps=await getFirebaseCollection(`users/${userId}/games/${activeGameId}/players`);
  const active=ps.filter(p=>p.estatisticas===true);
  fieldPlayers=active.filter(p=>!p.gr).sort((a,b)=>a.numero-b.numero);
  goalKeepers=active.filter(p=>p.gr).sort((a,b)=>a.numero-b.numero).slice(0,2);
  listenRealtime();
}

async function findActiveGame(){
  const q=query(collection(db,`users/${userId}/games`),where("active","==",true));
  const snap=await getDocs(q);
  if(!snap.empty){activeGameId=snap.docs[0].id;await loadPlayers();}
  else{alert("Nenhum jogo ativo encontrado.");window.location.href="configjogoequipa.html";}
}
document.addEventListener("DOMContentLoaded",()=>findActiveGame());

document.body.addEventListener("click",async e=>{
  if(e.target.tagName!=="TD"||!e.target.dataset.player)return;
  const td=e.target;
  const cur=td.textContent.trim();
  const next=cur===""?"E":cur==="E"?"S":"";
  td.textContent=next;
  td.classList.remove("e-cell","s-cell");
  if(next==="E")td.classList.add("e-cell");
  else if(next==="S")td.classList.add("s-cell");
  const part=td.dataset.part,player=td.dataset.player,time=td.dataset.time;
  await saveCell(part,player,time,next,td);
});

async function reset(part){
  try{
    if(part==="all"){
      await setFirebaseDoc(`users/${userId}/games/${activeGameId}/entradasSaidas/parte1`,{});
      await setFirebaseDoc(`users/${userId}/games/${activeGameId}/entradasSaidas/parte2`,{});
      localCache.parte1={};localCache.parte2={};
    }else{
      await setFirebaseDoc(`users/${userId}/games/${activeGameId}/entradasSaidas/${part}`,{});
      localCache[part]={};
    }
    notify("âœ… Reset concluÃ­do");
  }catch(e){console.error(e);notify("Erro ao resetar",true);}
}
document.getElementById("resetPart1Btn").onclick=()=>reset("parte1");
document.getElementById("resetPart2Btn").onclick=()=>reset("parte2");
document.getElementById("resetAllBtn").onclick=()=>reset("all");

document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    btn.classList.add("active");
    if(btn.dataset.tab)document.getElementById(btn.dataset.tab).classList.add("active");
  });
});
</script>
</body>
</html>
