<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Entradas / SaÃ­das</title>

<!-- Roboto font -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%;
  font-family: 'Roboto', sans-serif;
  background: linear-gradient(135deg, #1d2b64, #f8cdda);
  color: #222;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* HEADER / NAVBAR */
header {
  position: sticky;
  top: 0;
  width: 100%;
  background: linear-gradient(135deg, #1d2b64, #f8cdda);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  z-index: 1002;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.nav-left, .nav-right { display: flex; align-items: center; }
.hamburger { font-size: 1.8em; cursor: pointer; color: #fff; transition: transform 0.2s ease; }
.hamburger:hover { transform: scale(1.1); }
.header-logo { height: 40px; width: auto; display: block; margin: 0 auto; }
.home-icon { font-size: 1.8em; color: #fff; cursor: pointer; text-decoration: none; transition: transform 0.2s ease; }
.home-icon:hover { transform: scale(1.1); }

/* SIDE MENU */
.side-menu {
  position: fixed;
  top: 0;
  left: -260px;
  width: 260px;
  height: 100%;
  background: linear-gradient(135deg, rgba(29,43,100,0.95), rgba(248,205,218,0.95));
  box-shadow: 3px 0 15px rgba(0,0,0,0.4);
  transition: left 0.35s ease;
  z-index: 1003;
  padding-top: 80px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  padding-left: 25px;
}
.side-menu.open { left: 0; }
.side-menu a {
  color: #fff;
  text-decoration: none;
  font-weight: 600;
  margin: 14px 0;
  display: flex;
  align-items: center;
  font-size: 1.05em;
  transition: transform 0.2s ease, color 0.2s ease;
}
.side-menu a:hover { transform: translateX(5px); color: #f8cdda; }

/* OVERLAY */
.overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  opacity: 0; visibility: hidden;
  transition: opacity 0.35s ease;
  z-index: 1002;
}
.overlay.active { opacity: 1; visibility: visible; }

/* MAIN PAGE CONTENT */
h2 {
  text-align: center;
  margin: 20px 0 10px;
  color: #fff;
  text-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.tabs {
  display: flex;
  justify-content: center;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.tab-btn {
  padding: 10px 18px;
  border: none;
  border-radius: 6px;
  background: #888;
  color: #fff;
  cursor: pointer;
  font-weight: 500;
  transition: 0.25s;
}
.tab-btn.active { background: #28a745; }

.tab-content {
  display: none;
  margin: 0 50px 20px 50px; /* Add margin from the page edge */
}
.tab-content.active { display: block; }

.responsive { overflow-x: auto; }

table {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,.08);
  font-size: 13px;
}
th {
  padding: 0;
  text-align: center;
  border: 1px solid #ccc;
  width: 36px;
  height: 50px;
  cursor: pointer;
  background: #3399ff;
  font-weight: 700;
  color: #000;
  position: sticky;
  top: 0;
  z-index: 2;
  white-space: nowrap;
}
td {
  padding: 0;
  text-align: center;
  border: 1px solid #ccc;
  width: 36px;
  height: 40px;
  cursor: pointer;
}
th.time-col div {
  transform: rotate(-90deg);
  transform-origin: center center;
  display: inline-block;
  line-height: 36px;
  white-space: nowrap;
  font-weight: 700;
  color: #000;
}
th:first-child, td:first-child {
  position: sticky;
  left: 0;
  background: #fefefe;
  z-index: 3;
  font-weight: 600;
  min-width: 40px;
}
th:nth-child(2), td:nth-child(2) {
  position: sticky;
  left: 40px;
  background: #fefefe;
  z-index: 3;
  text-align: left;
  padding-left: 4px;
  min-width: 160px;
}
tr:nth-child(even) td { background: #e0e0e0; }
tr:nth-child(odd) td { background: #ffffff; }

td.e-cell { background: #28a745 !important; color: #000; font-weight: 600; }
td.s-cell { background: #e74c3c !important; color: #000; font-weight: 600; }
td.saving { background: #fff3cd !important; }
td.saved { background: #d4edda !important; transition: background .6s ease; }

.reset-buttons {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin: 10px 0 14px;
}
.reset-buttons button {
  padding: 10px 20px;
  border-radius: 6px;
  border: none;
  background: #e74c3c;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}
.reset-buttons button:hover { background: #b71c1c; }

#notification {
  display: none;
  position: fixed;
  top: 14px;
  right: 14px;
  background: #e8f1ff;
  color: #0047b3;
  padding: 10px 14px;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 999;
}

footer {
  text-align: center;
  padding: 14px;
  font-size: .85em;
  color: #fff;
  margin-top: 20px;
  text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

@media(max-width:768px){
  table { font-size: 11px; }
  th { height: 40px; }
  td { height: 32px; }
  .tab-content { margin: 0 20px 20px 20px; }
}
</style>
</head>

<body>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<!-- Side Menu -->
<div class="side-menu" id="sideMenu">
  <a href="index.html"><i class='bx bx-home'></i>&nbsp; Home</a>
  <a href="estatisticas.html"><i class='bx bx-bar-chart'></i>&nbsp; EstatÃ­sticas de Jogo</a>
  <a href="entradassaidas.html"><i class='bx bx-transfer'></i>&nbsp; Entradas / SaÃ­das</a>
  <a href="pse.html"><i class='bx bx-user'></i>&nbsp; PSE</a>
  <a href="relatorios.html"><i class='bx bx-file'></i>&nbsp; RelatÃ³rios</a>
  <a href="exportar.html"><i class='bx bx-export'></i>&nbsp; Exportar</a>
  <a href="confjogoequipa.html"><i class='bx bx-cog'></i>&nbsp; ConfiguraÃ§Ãµes</a>
</div>

<!-- Header -->
<header>
  <div class="nav-left">
    <i class='bx bx-menu hamburger' id="menuToggle"></i>
  </div>
  <img src="https://ricardopereira.com/firebase/LogoRP_White.png" alt="Logo" class="header-logo">
  <div class="nav-right">
    <a href="index.html"><i class='bx bx-home home-icon'></i></a>
  </div>
</header>

<h2>Entradas / SaÃ­das</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="part1">1Âª Parte</button>
  <button class="tab-btn" data-tab="part2">2Âª Parte</button>
  <button class="tab-btn" onclick="window.location.href='estatisticas.html'">ðŸ“Š EstatÃ­sticas</button>
</div>

<div id="notification"></div>

<div id="part1" class="tab-content active">
  <div class="responsive"><table id="tableParte1"><thead></thead><tbody></tbody></table></div>
</div>

<div id="part2" class="tab-content">
  <div class="responsive"><table id="tableParte2"><thead></thead><tbody></tbody></table></div>
</div>

<div class="reset-buttons">
  <button id="resetPart1Btn">Reset 1Âª Parte</button>
  <button id="resetPart2Btn">Reset 2Âª Parte</button>
  <button id="resetAllBtn">Reset Tudo</button>
</div>

<footer>Â© 2025 Team Pro Stats Â· Entradas / SaÃ­das</footer>

<script type="module">
import { db, getFirebaseCollection, setFirebaseDoc } from "./firebase-data.js";
import { collection, query, where, getDocs, deleteField, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

let userId="user1",activeGameId=null;
let fieldPlayers=[],goalKeepers=[];
const localCache={parte1:{},parte2:{}};

const times=[];
for(let sec=25*60;sec>=30;sec-=30){
  const m=Math.floor(sec/60),s=sec%60;
  times.push(`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`);
}

const notification=document.getElementById("notification");
function notify(msg,err=false){
  notification.textContent=msg;
  notification.style.background=err?"#ffe8e8":"#e8f1ff";
  notification.style.color=err?"#b71c1c":"#0047b3";
  notification.style.display="block";
  setTimeout(()=>notification.style.display="none",2000);
}

function createHeader(){
  const cols=["#","Nome",...times];
  return "<tr>"+cols.map(c=>{
    if(c==="#"||c==="Nome") return `<th>${c}</th>`;
    return `<th class='time-col'><div>${c}</div></th>`;
  }).join("")+"</tr>";
}

function renderTable(tableId,data){
  const table=document.getElementById(tableId);
  table.querySelector("thead").innerHTML=createHeader();
  const tb=table.querySelector("tbody");
  tb.innerHTML="";
  const combined=[...fieldPlayers,...goalKeepers];
  combined.forEach((p)=>{
    const row=document.createElement("tr");
    let cells=`<td>${p.numero}</td><td>${p.nome}${p.gr?" (GR)":""}</td>`;
    times.forEach(t=>{
      const val=data[p.numero]?.[t]||"";
      const cls=val==="E"?"e-cell":val==="S"?"s-cell":"";
      cells+=`<td class="${cls}" data-player="${p.numero}" data-time="${t}" data-part="${tableId.includes("1")?"parte1":"parte2"}">${val}</td>`;
    });
    row.innerHTML=cells;
    tb.appendChild(row);
  });
}

async function saveCell(part,player,time,val,td){
  try{
    td.classList.add("saving");
    localCache[part][player]=localCache[part][player]||{};
    if(val==="") delete localCache[part][player][time];
    else localCache[part][player][time]=val;
    const ref=doc(db,`users/${userId}/games/${activeGameId}/entradasSaidas/${part}`);
    await setDoc(ref,{[player]:{[time]:val===""?deleteField():val}},{merge:true});
    td.classList.remove("saving");
    td.classList.add("saved");
    setTimeout(()=>td.classList.remove("saved"),800);
  }catch(e){console.error(e);td.classList.remove("saving");notify("Erro ao guardar",true);}
}

function listenRealtime(){
  const colRef=collection(db,`users/${userId}/games/${activeGameId}/entradasSaidas`);
  onSnapshot(colRef,snap=>{
    const parte1={},parte2={};
    snap.forEach(doc=>{
      if(doc.id==="parte1")Object.assign(parte1,doc.data());
      if(doc.id==="parte2")Object.assign(parte2,doc.data());
    });
    localCache.parte1=parte1;localCache.parte2=parte2;
    renderTable("tableParte1",parte1);
    renderTable("tableParte2",parte2);
  });
}

async function loadPlayers(){
  const ps=await getFirebaseCollection(`users/${userId}/games/${activeGameId}/players`);
  const active=ps.filter(p=>p.estatisticas===true);
  fieldPlayers=active.filter(p=>!p.gr).sort((a,b)=>a.numero-b.numero);
  goalKeepers=active.filter(p=>p.gr).sort((a,b)=>a.numero-b.numero).slice(0,2);
  listenRealtime();
}

async function findActiveGame(){
  const q=query(collection(db,`users/${userId}/games`),where("active","==",true));
  const snap=await getDocs(q);
  if(!snap.empty){activeGameId=snap.docs[0].id;await loadPlayers();}
  else{alert("Nenhum jogo ativo encontrado.");window.location.href="configjogoequipa.html";}
}
document.addEventListener("DOMContentLoaded",()=>findActiveGame());

document.body.addEventListener("click",async e=>{
  if(e.target.tagName!=="TD"||!e.target.dataset.player)return;
  const td=e.target;
  const cur=td.textContent.trim();
  const next=cur===""?"E":cur==="E"?"S":"";
  td.textContent=next;
  td.classList.remove("e-cell","s-cell");
  if(next==="E")td.classList.add("e-cell");
  else if(next==="S")td.classList.add("s-cell");
  const part=td.dataset.part,player=td.dataset.player,time=td.dataset.time;
  await saveCell(part,player,time,next,td);
});

async function reset(part){
  try{
    if(part==="all"){
      await setDoc(doc(db,`users/${userId}/games/${activeGameId}/entradasSaidas/parte1`),{});
      await setDoc(doc(db,`users/${userId}/games/${activeGameId}/entradasSaidas/parte2`),{});
      localCache.parte1={};localCache.parte2={};
    }else{
      await setDoc(doc(db,`users/${userId}/games/${activeGameId}/entradasSaidas/${part}`),{});
      localCache[part]={};
    }
    notify("âœ… Reset concluÃ­do");
  }catch(e){console.error(e);notify("Erro ao resetar",true);}
}
document.getElementById("resetPart1Btn").onclick=()=>reset("parte1");
document.getElementById("resetPart2Btn").onclick=()=>reset("parte2");
document.getElementById("resetAllBtn").onclick=()=>reset("all");

document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    btn.classList.add("active");
    if(btn.dataset.tab)document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

/* NAV MENU TOGGLE */
const menuToggle=document.getElementById("menuToggle");
const sideMenu=document.getElementById("sideMenu");
const overlay=document.getElementById("overlay");
const menuLinks=sideMenu.querySelectorAll("a");
function openMenu(){ sideMenu.classList.add("open"); overlay.classList.add("active"); }
function closeMenu(){ sideMenu.classList.remove("open"); overlay.classList.remove("active"); }
menuToggle.addEventListener("click",()=>{ sideMenu.classList.contains("open")?closeMenu():openMenu(); });
overlay.addEventListener("click",closeMenu);
menuLinks.forEach(link=>link.addEventListener("click",closeMenu));
</script>

</body>
</html>
