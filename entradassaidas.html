<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entradas / Sa√≠das</title>
<link rel="stylesheet" href="estatisticas.css" />
<style>
  body { font-family: Arial, sans-serif; padding: 10px; background: #f7f7f7; }
  .responsive-inout { overflow-x: auto; -webkit-overflow-scrolling: touch; max-width: 100%; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; background: white; }
  table.part-table-inout { border-collapse: collapse; width: 100%; min-width: 600px; font-size: 14px; }
  table.part-table-inout thead tr { background-color: #3498db; color: white; }
  table.part-table-inout th, table.part-table-inout td { border: 1px solid #ddd; padding: 6px 8px; text-align: center; white-space: nowrap; cursor: pointer; }
  table.part-table-inout th:first-child, table.part-table-inout td:first-child { text-align: left; cursor: default; }
  .header-container { margin-bottom: 15px; }
  .title-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 10px; gap: 8px; }
  .controls-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .tabs { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .tab-btn, .nav-btn { height: 32px; display: flex; align-items: center; justify-content: center; padding: 0 14px; font-size: 14px; border-radius: 4px; cursor: pointer; border: none; user-select: none; }
  .tab-btn { background-color: #888; color: white; }
  .tab-btn.active { background-color: #2ecc71; }
  .nav-btn { background-color: #3498db; color: white; }
  .nav-btn:hover { background-color: #5dade2; }
  .tab-btn:hover { opacity: 0.9; }
  .notification { margin-top: 10px; font-size: 12px; color: #27ae60; transition: opacity 0.4s; }
</style>
</head>
<body>

<div class="header-container">
  <div class="title-row">
    <h2>Entradas / Sa√≠das</h2>
  </div>
  <div class="controls-row">
    <div class="tabs">
      <button class="tab-btn active" data-tab="inOutPart1" type="button">1¬™ Parte</button>
      <button class="tab-btn" data-tab="inOutPart2" type="button">2¬™ Parte</button>
      <button id="backStats" class="nav-btn" type="button">Estat√≠sticas</button>
    </div>
  </div>
</div>

<div id="inOutPart1" class="tab-content active">
  <div class="responsive-inout">
    <table id="tableInOut1" class="part-table-inout" aria-label="Tabela de Entradas e Sa√≠das 1¬™ Parte">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="inOutPart2" class="tab-content">
  <div class="responsive-inout">
    <table id="tableInOut2" class="part-table-inout" aria-label="Tabela de Entradas e Sa√≠das 2¬™ Parte">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="notification" class="notification"></div>
<footer>¬© 2025 Team Pro Stats ¬∑ Powered by RP Technology</footer>

<script type="module">
import { db, getFirebaseDoc, setFirebaseDoc, onFirebaseDocChange } from './firebase-data.js';
import { getDocs, collection } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const STORAGE_KEY = 'estatisticas_valores';
let inOutData = {};
let gameId = null;

// üîπ Intervalos por escal√£o
const defaultIntervals = ["25","24'30","24","23'30","23","22'30","22","21'30","21","20'30","20","19'30","19","18'30","18","17'30","17","16'30","16","15'30","15","14'30","14","13'30","13","12'30","12","11'30","11","10'30","10","9'30","9","8'30","8","7'30","7","6'30","6","5'30","5","4'30","4","3'30","3","2'30","2","1'30","1","30"];
const sub13Intervals = ["18","17'30","17","16'30","16","15'30","15","14'30","14","13'30","13","12'30","12","11'30","11","10'30","10","9'30","9","8'30","8","7'30","7","6'30","6","5'30","5","4'30","4","3'30","3","2'30","2","1'30","1","30"];
const sub15_17Intervals = ["20","19'30","19","18'30","18","17'30","17","16'30","16","15'30","15","14'30","14","13'30","13","12'30","12","11'30","11","10'30","10","9'30","9","8'30","8","7'30","7","6'30","6","5'30","5","4'30","4","3'30","3","2'30","2","1'30","1","30"];
const levelIntervalsMap = { sub13: sub13Intervals, sub15: sub15_17Intervals, sub17: sub15_17Intervals, sub19: defaultIntervals, sub23: defaultIntervals, seniores: defaultIntervals };

function getIntervalsForLevel(level){ return levelIntervalsMap[level] || defaultIntervals; }

// üîπ Notification
function showNotification(msg, color="#27ae60") {
  const n = document.getElementById("notification");
  n.textContent = msg;
  n.style.color = color;
  n.style.opacity = "1";
  setTimeout(() => { n.style.opacity = "0"; }, 2500);
}

// üîπ Get active game
async function getActiveGameId() {
  const active = await getFirebaseDoc("activeGame/active");
  return active?.id || null;
}

// üîπ Fetch players from Firebase
async function fetchPlayers() {
  if (!gameId) return [];
  const snap = await getDocs(collection(db, `games/${gameId}/players`));
  const all = [];
  snap.forEach(docSnap => {
    const p = docSnap.data();
    if (p.estatisticas) all.push(p);
  });
  return all;
}

// üîπ Render In/Out Table
async function renderInOut() {
  const savedDoc = await getFirebaseDoc(`games/${gameId}/inOutData`);
  inOutData = (savedDoc && savedDoc.inOut) ? savedDoc.inOut : {};

  const gameData = await getFirebaseDoc(`games/${gameId}`);
  const level = (gameData?.escalao || 'sub13').toLowerCase().replace(/\s/g, '');
  const players = await fetchPlayers();
  const intervals = getIntervalsForLevel(level);

  const t1 = document.getElementById("tableInOut1");
  const t2 = document.getElementById("tableInOut2");

  function buildHeader(table){
    const tr = table.querySelector("thead tr");
    tr.innerHTML = "<th>#</th><th>Nome</th>";
    intervals.forEach(iv => { tr.innerHTML += `<th>${iv}</th>`; });
  }

  function buildBody(table, part){
    const tbody = table.querySelector("tbody");
    tbody.innerHTML = "";
    players.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${p.numero || ''}</td><td>${p.nome || ''}</td>`;
      intervals.forEach(iv => {
        const td = document.createElement("td");
        const key = `tableInOut${part}_${p.numero}_${iv}`;
        const val = inOutData[key] || "";
        td.dataset.key = key;
        td.dataset.state = val;
        td.textContent = val;
        if(val==='E'){ td.style.background='green'; td.style.color='white'; }
        else if(val==='S'){ td.style.background='orange'; td.style.color='white'; }

        td.addEventListener("click", async () => {
          let state = td.dataset.state || "";
          if(state === "") state = "E"; else if(state === "E") state = "S"; else state = "";
          td.dataset.state = state;
          td.textContent = state;
          td.style.background = state==="E" ? "green" : state==="S" ? "orange" : "";
          td.style.color = state ? "white" : "";
          inOutData[key] = state;
          await setFirebaseDoc(`games/${gameId}/inOutData`, { inOut: inOutData });
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ inOut: inOutData }));
          showNotification("‚úîÔ∏è Guardado com sucesso");
        });

        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  buildHeader(t1); buildBody(t1, "1");
  buildHeader(t2); buildBody(t2, "2");
}

// üîπ Tabs
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// üîπ Back button
document.getElementById("backStats").addEventListener("click", () => {
  window.location.href = "estatisticas.html";
});

// üîπ Initialize
window.addEventListener("load", async () => {
  showNotification("üîÑ A carregar dados...");
  gameId = await getActiveGameId();
  if (!gameId) return showNotification("‚ùå Nenhum jogo ativo encontrado", "#e74c3c");

  await renderInOut();
  showNotification("‚úÖ Dados carregados");

  // Listen for real-time Firestore updates
  onFirebaseDocChange(`games/${gameId}/inOutData`, renderInOut);
});
</script>
</body>
</html>
