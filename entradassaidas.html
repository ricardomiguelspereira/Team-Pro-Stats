<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entradas / Saídas</title>
<link rel="stylesheet" href="estatisticas.css" />
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 20px;
  color: #222;
}
h2 {
  text-align: center;
  margin-bottom: 16px;
}
.tabs {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px;
}
.tab-btn, .nav-btn {
  padding: 10px 18px;
  border: none;
  border-radius: 6px;
  background: #888;
  color: white;
  cursor: pointer;
  font-weight: 500;
  transition: 0.25s;
}
.tab-btn.active {
  background: #28a745;
}
.nav-btn {
  background: #007bff;
}
.nav-btn:hover {
  background: #0056b3;
}
.responsive-inout {
  overflow-x: auto;
  margin-bottom: 20px;
}
table {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  font-size: 14px;
}
th, td {
  padding: 6px;
  text-align: center;
  border-bottom: 1px solid #e0e0e0;
  min-width: 35px;
  width: 35px;
  max-width: 35px;
  white-space: nowrap;
}
th:first-child, td:first-child {
  width: 40px;
}
th:nth-child(2), td:nth-child(2) {
  width: 140px;
  text-align: left;
  padding-left: 8px;
}
th {
  background: #f5f5f5;
  font-weight: 600;
}
tr:hover td {
  background: #f9f9f9;
}
td.clickable {
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
}
td.clickable:hover {
  background: #e6f7ff;
}
footer {
  text-align: center;
  padding: 12px;
  color: #555;
  font-size: 0.85em;
}
#notification {
  display: none;
  position: fixed;
  top: 15px;
  right: 15px;
  background: #e8f1ff;
  color: #0047b3;
  padding: 10px 14px;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}
</style>
</head>
<body>

<h2>Entradas / Saídas</h2>

<div class="tabs">
  <button class="tab-btn active" data-tab="part1">1ª Parte</button>
  <button class="tab-btn" data-tab="part2">2ª Parte</button>
  <button id="backStats" class="nav-btn">Estatísticas</button>
</div>

<div id="part1" class="tab-content active">
  <div class="responsive-inout">
    <table id="tableInOut1">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="part2" class="tab-content">
  <div class="responsive-inout">
    <table id="tableInOut2">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="notification"></div>

<footer>© 2025 Team Pro Stats · Powered by RP Technology</footer>

<script type="module">
import {
  FB_PATHS_GLOBAL,
  FB_PATHS_GAME,
  initializeFirebase,
  getFirebaseData,
  setFirebaseData,
  onFirebaseDataChange,
  getActiveGameId
} from './firebase-data.js';

let inOutData = {};
let playersCampo = [], playersGR = [];

// Intervals por escalão
const intervalsDefault = ["25","24'30","24","23'30","22","21'30","21","20'30","20","19'30","19","18'30","18","17'30","17","16'30","16","15'30","15","14'30","14","13'30","13","12'30","12","11'30","11","10'30","10","9'30","9","8'30","8","7'30","7","6'30","6","5'30","5","4'30","4","3'30","3","2'30","2","1'30","1","30"];
const intervalsSub13 = ["18","17'30","17","16'30","16","15'30","15","14'30","14","13'30","13","12'30","12","11'30","11","10'30","10","9'30","9","8'30","8","7'30","7","6'30","6","5'30","5","4'30","4","3'30","3","2'30","2","1'30","1","30"];
const intervalsSub15_17 = ["20","19'30","19","18'30","18","17'30","17","16'30","16","15'30","15","14'30","14","13'30","13","12'30","12","11'30","11","10'30","10","9'30","9","8'30","8","7'30","7","6'30","6","5'30","5","4'30","4","3'30","3","2'30","2","1'30","1","30"];
const levelIntervalsMap = {
  sub13: intervalsSub13,
  sub15: intervalsSub15_17,
  sub17: intervalsSub15_17,
  sub19: intervalsDefault,
  sub23: intervalsDefault,
  seniores: intervalsDefault
};

function normalizeText(text) {
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]/g, '');
}

async function getLevelFromConfig() {
  const jogoDataRaw = await getFirebaseData(FB_PATHS_GAME.jogoFormData);
  if (!jogoDataRaw) return 'sub13';
  try {
    let esc = normalizeText(jogoDataRaw.escalao || '');
    const map = {
      sub13: 'sub13', sub15: 'sub15', sub17: 'sub17',
      sub19: 'sub19', sub23: 'sub23', seniores: 'seniores', seniors: 'seniores'
    };
    return map[esc] || 'sub13';
  } catch { return 'sub13'; }
}

async function loadPlayers() {
  const fieldPlayersData = await getFirebaseData(FB_PATHS_GLOBAL.fieldPlayers);
  const goalKeepersData = await getFirebaseData(FB_PATHS_GLOBAL.goalKeepers);
  const fieldPlayers = fieldPlayersData ? fieldPlayersData.players : [];
  const goalKeepers = goalKeepersData ? goalKeepersData.players : [];
  playersCampo = fieldPlayers.filter(p => p.estatisticas);
  playersGR = goalKeepers.filter(p => p.estatisticas);
}

async function renderTables() {
  const activeGame = getActiveGameId();
  if (!activeGame) {
    alert('Nenhum jogo ativo. Vá a "Configurar Jogo".');
    window.location.href = 'configjogoequipa.html';
    return;
  }

  await loadPlayers();
  const saved = await getFirebaseData(FB_PATHS_GAME.estatisticasValores) || {};
  inOutData = saved.inOut || {};

  const allPlayers = [...playersCampo, ...playersGR];
  const level = await getLevelFromConfig();
  const intervals = levelIntervalsMap[level] || intervalsDefault;

  function buildHeader(table) {
    const tr = table.querySelector('thead tr');
    tr.innerHTML = '<th>#</th><th>Nome</th>';
    intervals.forEach(iv => tr.innerHTML += `<th>${iv}</th>`);
  }

  async function buildBody(table, part) {
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    allPlayers.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.numero}</td><td>${p.nome}</td>`;
      intervals.forEach(iv => {
        const td = document.createElement('td');
        const key = `tableInOut${part}_${p.numero}_${iv}`;
        const val = inOutData[key] || '';
        td.textContent = val;
        td.classList.add('clickable');
        updateCellStyle(td, val);
        td.addEventListener('click', async () => {
          let newVal = '';
          if (td.textContent === '') newVal = 'E';
          else if (td.textContent === 'E') newVal = 'S';
          else newVal = '';
          td.textContent = newVal;
          updateCellStyle(td, newVal);
          inOutData[key] = newVal;
          saved.inOut = inOutData;
          await setFirebaseData(FB_PATHS_GAME.estatisticasValores, saved);
        });
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  const t1 = document.getElementById('tableInOut1');
  const t2 = document.getElementById('tableInOut2');
  buildHeader(t1);
  await buildBody(t1, '1');
  buildHeader(t2);
  await buildBody(t2, '2');
}

function updateCellStyle(td, val) {
  td.style.fontWeight = 'bold';
  td.style.fontSize = '18px';
  if (val === 'E') {
    td.style.background = 'green';
    td.style.color = 'white';
  } else if (val === 'S') {
    td.style.background = 'orange';
    td.style.color = 'white';
  } else {
    td.style.background = '';
    td.style.color = '';
  }
}

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
    localStorage.setItem('activeInOutTab', btn.dataset.tab);
  });
});

// Back to Estatísticas
document.getElementById('backStats').addEventListener('click', () => {
  window.location.href = 'estatisticas.html';
});

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  await initializeFirebase();
  const activeGame = getActiveGameId();
  if (!activeGame) {
    alert('Nenhum jogo ativo. Vá a "Configurar Jogo".');
    window.location.href = 'configjogoequipa.html';
    return;
  }
  const savedTab = localStorage.getItem('activeInOutTab');
  if (savedTab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`.tab-btn[data-tab="${savedTab}"]`)?.classList.add('active');
    document.getElementById(savedTab)?.classList.add('active');
  }
  await renderTables();
});

// Live sync with Firebase
onFirebaseDataChange(FB_PATHS_GLOBAL.fieldPlayers, renderTables);
onFirebaseDataChange(FB_PATHS_GLOBAL.goalKeepers, renderTables);
onFirebaseDataChange(FB_PATHS_GAME.jogoFormData, renderTables);
onFirebaseDataChange(FB_PATHS_GAME.estatisticasValores, renderTables);
</script>

</body>
</html>
