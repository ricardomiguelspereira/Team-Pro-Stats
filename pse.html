<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Percepção Subjectiva do Esforço - Seleção Direta</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  /* ... (your existing styles) ... */
</style>
</head>
<body>

<div class="container">
  <h1>Percepção Subjectiva do Esforço</h1>
  <div class="notification" id="notification"></div>

  <div class="input-group">
    <select id="athleteSelect"><option value="">Selecionar atleta</option></select>
  </div>

  <table id="pseTable">
    <thead>
      <tr>
        <th>Emoji</th>
        <th>Nível</th>
        <th>Descrição</th>
      </tr>
    </thead>
    <tbody>
      <tr data-level="1" data-color="#6699FF" style="background:#6699FF; color:#000;">
        <td class="emoji">😴</td><td class="level">1</td><td class="desc"><strong>Actividade Muito Leve</strong><br>Quase nenhum esforço, mas mais do que dormir, ver TV, etc.</td>
      </tr>
      <tr data-level="2" data-color="#ADD8E6" style="background:#ADD8E6; color:#000;">
        <td class="emoji">🙂</td><td class="level">2-3</td><td class="desc"><strong>Actividade Leve</strong><br>Parece que podemos manter durante horas. Fácil de respirar e manter uma conversa.</td>
      </tr>
      <tr data-level="4" data-color="#4CAF50" style="background:#4CAF50; color:#000;">
        <td class="emoji">😐</td><td class="level">4-6</td><td class="desc"><strong>Actividade Moderada</strong><br>Respirar profundo, consigo manter uma conversa curta. Confortável mas desafiador.</td>
      </tr>
      <tr data-level="7" data-color="#FFD700" style="background:#FFD700; color:#000;">
        <td class="emoji">😅</td><td class="level">7-8</td><td class="desc"><strong>Actividade Vigorosa</strong><br>No limite do desconfortável. Falta de ar, consigo falar uma frase.</td>
      </tr>
      <tr data-level="9" data-color="#FFA500" style="background:#FFA500; color:#000;">
        <td class="emoji">😫</td><td class="level">9</td><td class="desc"><strong>Actividade Muito Difícil</strong><br>Muito difícil manter. Mal consigo respirar e só algumas palavras.</td>
      </tr>
      <tr data-level="10" data-color="#FF0000" style="background:#FF0000; color:#fff;">
        <td class="emoji">💀</td><td class="level">10</td><td class="desc"><strong>Actividade de Esforço Máximo</strong><br>Quase impossível continuar. Sem fôlego, incapaz de falar.</td>
      </tr>
    </tbody>
  </table>

  <div class="button-group">
    <button id="saveBtn">Enviar</button>
  </div>
</div>

<footer>© 2025 Team Pro Stats · Powered by RP Technology</footer>

<script type="module" src="firebase-data.js"></script>
<script>
// PASSWORD INIT (not directly related to Firebase data, but kept for context)
async function hashPassword(password){const e=new TextEncoder();const d=e.encode(password);const h=await crypto.subtle.digest("SHA-256",d);return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,"0")).join("");}
async function initPassword(){if(!localStorage.getItem("passwordHash")){localStorage.setItem("passwordHash",await hashPassword("1234"));}}

// NOTIFICATION
const notification = document.getElementById("notification");
function showNotification(msg, isError=false){notification.textContent=msg;notification.className="notification"+(isError?" error":"");notification.classList.add("show");setTimeout(()=>notification.classList.remove("show"),2500);}

// TABLE SELECTION
let selectedLevel = null;
const pseTable = document.getElementById("pseTable");

function selectRow(row){
  pseTable.querySelectorAll("tbody tr").forEach(r=>{
    r.querySelector(".emoji").classList.remove("bounce");
    r.classList.remove("selected");
  });

  row.querySelector(".emoji").classList.add("bounce");
  row.classList.add("selected");
  selectedLevel = parseInt(row.getAttribute("data-level"));
}

pseTable.querySelectorAll("tbody tr").forEach(row=>{
  row.addEventListener("click",()=>selectRow(row));
  row.addEventListener("touchstart",()=>selectRow(row));
});

// ATHLETES AND SAVE
let pseData = []; // Will be loaded from Firebase
const athleteSelect=document.getElementById("athleteSelect");

async function loadPSEAthletes(){
  const fieldPlayersData = await getFirebaseData(FB_PATHS.fieldPlayers);
  const goalKeepersData = await getFirebaseData(FB_PATHS.goalKeepers);

  const fieldPlayers = fieldPlayersData ? fieldPlayersData.players : [];
  const goalKeepers = goalKeepersData ? goalKeepersData.players : [];

  const pseFieldPlayers=fieldPlayers.filter(p=>p.pse).map(p=>({numero:p.numero,nome:p.nome}));
  const pseGoalKeepers=goalKeepers.filter(p=>p.pse).map(p=>({numero:p.numero,nome:p.nome}));
  let athletes=[...pseFieldPlayers,...pseGoalKeepers];
  athletes.sort((a,b)=>a.numero-b.numero||a.nome.localeCompare(b.nome));
  return athletes;
}

async function updateAthleteSelect(){
  const athletes=await loadPSEAthletes();
  athleteSelect.innerHTML='<option value="">Selecionar atleta</option>';
  if(athletes.length===0){const option=document.createElement("option");option.value="";option.textContent="Nenhum atleta com PSE ativado";option.disabled=true;athleteSelect.appendChild(option);return;}
  athletes.forEach(p=>{const o=document.createElement("option");o.value=p.nome;o.textContent=`Nº ${p.numero} - ${p.nome}`;athleteSelect.appendChild(o);});
}

function isSameDay(d1,d2){return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth()&&d1.getDate()===d2.getDate();}

document.getElementById("saveBtn").addEventListener("click",async ()=>{
  const selected=athleteSelect.value;
  if(!selected){showNotification("Selecionar Atleta",true);return;}
  if(!selectedLevel){showNotification("Selecionar Nível PSE",true);return;}
  
  // Load current pseData from Firebase before checking/saving
  const currentPseData = await getFirebaseData(FB_PATHS.pseData);
  pseData = currentPseData ? currentPseData.entries || [] : [];

  const now=new Date();
  const alreadyRecorded=pseData.some(item=>{
    const itemDate=new Date(item.datetime);
    return item.name===selected && isSameDay(itemDate,now);
  });
  if(alreadyRecorded){showNotification("Este atleta já registrou PSE hoje",true);return;}
  
  pseData.push({name:selected,pse:selectedLevel,datetime:now.toISOString()});
  await setFirebaseData(FB_PATHS.pseData, { entries: pseData }); // Save to Firebase
  showNotification(`PSE guardado: ${selected} - ${selectedLevel}`);
  
  // Reset selected level
  selectedLevel = null;
  
  // Remove row selection
  pseTable.querySelectorAll("tbody tr").forEach(r=>{
    r.querySelector(".emoji").classList.remove("bounce");
    r.classList.remove("selected");
  });
  
  // Reset dropdown to default
  athleteSelect.value = "";
});

initPassword();
updateAthleteSelect();

// Listen for changes to player config to update athlete select
onFirebaseDataChange(FB_PATHS.fieldPlayers, updateAthleteSelect);
onFirebaseDataChange(FB_PATHS.goalKeepers, updateAthleteSelect);
</script>
</body>
</html>