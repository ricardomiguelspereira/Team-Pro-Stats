<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Percep√ß√£o Subjectiva do Esfor√ßo - Sele√ß√£o Direta</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background: #f4f4f4; margin: 0; padding: 20px; color: #333; }
  .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
  h1 { font-size: 24px; font-weight: bold; margin-bottom: 25px; color: #2980b9; }
  .notification {
    margin-bottom: 20px; padding: 10px; border-radius: 5px; text-align: center;
    background: rgba(52, 152, 219, 0.1); color: #2980b9; display: none; opacity: 1; transition: opacity 0.3s ease;
  }
  .notification.error { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
  .notification.show { display: block; }
  .input-group { margin-bottom: 20px; }
  #athleteSelect { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
  #pseTable { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  #pseTable th, #pseTable td { padding: 10px; border: 1px solid #eee; text-align: left; }
  #pseTable th { background: #2980b9; color: #fff; font-size: 14px; }
  #pseTable td { font-size: 14px; }
  #pseTable tbody tr { cursor: pointer; transition: background 0.2s ease; }
  #pseTable tbody tr:hover { background: #e0f7fa; }
  #pseTable tbody tr.selected { border: 2px solid #2980b9; box-shadow: 0 0 8px rgba(41, 128, 185, 0.4); }
  #pseTable .emoji { font-size: 24px; text-align: center; width: 50px; }
  #pseTable .emoji.bounce { animation: bounce 0.5s; }
  @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
  .button-group { text-align: center; }
  #saveBtn { padding: 12px 25px; background: #27ae60; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; transition: background 0.3s ease; }
  #saveBtn:hover { background: #219150; }
  footer { text-align: center; padding: 15px 0; font-size: 0.8em; color: #666; margin-top: 30px; }
</style>
</head>
<body>

<div class="container">
  <h1>Percep√ß√£o Subjectiva do Esfor√ßo</h1>
  <div class="notification" id="notification"></div>

  <div class="input-group">
    <select id="athleteSelect"><option value="">Selecionar atleta</option></select>
  </div>

  <table id="pseTable">
    <thead>
      <tr>
        <th>Emoji</th>
        <th>N√≠vel</th>
        <th>Descri√ß√£o</th>
      </tr>
    </thead>
    <tbody>
      <tr data-level="1" data-color="#6699FF" style="background:#6699FF; color:#000;">
        <td class="emoji">üò¥</td><td class="level">1</td><td class="desc"><strong>Actividade Muito Leve</strong><br>Quase nenhum esfor√ßo, mas mais do que dormir, ver TV, etc.</td>
      </tr>
      <tr data-level="2" data-color="#ADD8E6" style="background:#ADD8E6; color:#000;">
        <td class="emoji">üôÇ</td><td class="level">2-3</td><td class="desc"><strong>Actividade Leve</strong><br>Parece que podemos manter durante horas. F√°cil de respirar e manter uma conversa.</td>
      </tr>
      <tr data-level="4" data-color="#4CAF50" style="background:#4CAF50; color:#000;">
        <td class="emoji">üòê</td><td class="level">4-6</td><td class="desc"><strong>Actividade Moderada</strong><br>Respirar profundo, consigo manter uma conversa curta. Confort√°vel mas desafiador.</td>
      </tr>
      <tr data-level="7" data-color="#FFD700" style="background:#FFD700; color:#000;">
        <td class="emoji">üòÖ</td><td class="level">7-8</td><td class="desc"><strong>Actividade Vigorosa</strong><br>No limite do desconfort√°vel. Falta de ar, consigo falar uma frase.</td>
      </tr>
      <tr data-level="9" data-color="#FFA500" style="background:#FFA500; color:#000;">
        <td class="emoji">üò´</td><td class="level">9</td><td class="desc"><strong>Actividade Muito Dif√≠cil</strong><br>Muito dif√≠cil manter. Mal consigo respirar e s√≥ algumas palavras.</td>
      </tr>
      <tr data-level="10" data-color="#FF0000" style="background:#FF0000; color:#fff;">
        <td class="emoji">üíÄ</td><td class="level">10</td><td class="desc"><strong>Actividade de Esfor√ßo M√°ximo</strong><br>Quase imposs√≠vel continuar. Sem f√¥lego, incapaz de falar.</td>
      </tr>
    </tbody>
  </table>

  <div class="button-group">
    <button id="saveBtn">Enviar</button>
  </div>
</div>

<footer>¬© 2025 Team Pro Stats ¬∑ Powered by RP Technology</footer>

<script type="module">
import {
  FB_PATHS_GLOBAL,
  FB_PATHS_GAME,
  initializeFirebase,
  setFirebaseData,
  getFirebaseData,
  onFirebaseDataChange,
  getActiveGameId,
  setActiveGameId
} from './firebase-data.js';

// NOTIFICATION
const notification = document.getElementById("notification");
function showNotification(msg, isError=false){
  notification.textContent=msg;
  notification.className="notification"+(isError?" error":"");
  notification.classList.add("show");
  setTimeout(()=>notification.classList.remove("show"),2500);
}

// TABLE SELECTION
let selectedLevel = null;
const pseTable = document.getElementById("pseTable");

function selectRow(row){
  pseTable.querySelectorAll("tbody tr").forEach(r=>{
    r.querySelector(".emoji").classList.remove("bounce");
    r.classList.remove("selected");
  });

  row.querySelector(".emoji").classList.add("bounce");
  row.classList.add("selected");
  selectedLevel = parseInt(row.getAttribute("data-level"));
}

pseTable.querySelectorAll("tbody tr").forEach(row=>{
  row.addEventListener("click",()=>selectRow(row));
  row.addEventListener("touchstart",()=>selectRow(row));
});

// ATHLETES AND SAVE
let pseData = []; // Will be loaded from Firebase
const athleteSelect=document.getElementById("athleteSelect");

async function loadPSEAthletes(){
  const fieldPlayersData = await getFirebaseData(FB_PATHS_GLOBAL.fieldPlayers);
  const goalKeepersData = await getFirebaseData(FB_PATHS_GLOBAL.goalKeepers);

  const fieldPlayers = fieldPlayersData ? fieldPlayersData.players : [];
  const goalKeepers = goalKeepersData ? goalKeepersData.players : [];

  const pseFieldPlayers=fieldPlayers.filter(p=>p.pse).map(p=>({numero:p.numero,nome:p.nome}));
  const pseGoalKeepers=goalKeepers.filter(p=>p.pse).map(p=>({numero:p.numero,nome:p.nome}));
  let athletes=[...pseFieldPlayers,...pseGoalKeepers];
  athletes.sort((a,b)=>a.numero-b.numero||a.nome.localeCompare(b.nome));
  return athletes;
}

async function updateAthleteSelect(){
  const athletes=await loadPSEAthletes();
  athleteSelect.innerHTML='<option value="">Selecionar atleta</option>';
  if(athletes.length===0){const option=document.createElement("option");option.value="";option.textContent="Nenhum atleta com PSE ativado";option.disabled=true;athleteSelect.appendChild(option);return;}
  athletes.forEach(p=>{const o=document.createElement("option");o.value=p.nome;o.textContent=`N¬∫ ${p.numero} - ${p.nome}`;athleteSelect.appendChild(o);});
}

function isSameDay(d1,d2){return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth()&&d1.getDate()===d2.getDate();}

document.getElementById("saveBtn").addEventListener("click",async ()=>{
  const activeGame = getActiveGameId();
  if (!activeGame) {
    showNotification('‚ùå Nenhum jogo ativo. Selecione ou crie um jogo.', true);
    return;
  }

  const selected=athleteSelect.value;
  if(!selected){showNotification("Selecionar Atleta",true);return;}
  if(!selectedLevel){showNotification("Selecionar N√≠vel PSE",true);return;}

  const currentPseData = await getFirebaseData(FB_PATHS_GAME.pseData);
  pseData = currentPseData ? currentPseData.entries || [] : [];

  const now=new Date();
  const alreadyRecorded=pseData.some(item=>{
    const itemDate=new Date(item.datetime);
    return item.name===selected && isSameDay(itemDate,now);
  });
  if(alreadyRecorded){showNotification("Este atleta j√° registrou PSE hoje",true);return;}

  pseData.push({name:selected,pse:selectedLevel,datetime:now.toISOString()});
  await setFirebaseData(FB_PATHS_GAME.pseData, { entries: pseData });
  showNotification(`PSE guardado: ${selected} - ${selectedLevel}`);

  selectedLevel = null;

  pseTable.querySelectorAll("tbody tr").forEach(r=>{
    r.querySelector(".emoji").classList.remove("bounce");
    r.classList.remove("selected");
  });

  athleteSelect.value = "";
});

// Initializer
document.addEventListener('DOMContentLoaded', async () => {
  await initializeFirebase(); // Ensures auth & migration

  const activeGame = getActiveGameId();
  if (!activeGame) {
    alert("Nenhum jogo ativo. Por favor, selecione ou crie um jogo em 'Configurar Jogo'.");
    window.location.href = 'configjogoequipa.html';
    return;
  }

  updateAthleteSelect();
});

// Listen for changes to player config to update athlete select
onFirebaseDataChange(FB_PATHS_GLOBAL.fieldPlayers, updateAthleteSelect);
onFirebaseDataChange(FB_PATHS_GLOBAL.goalKeepers, updateAthleteSelect);
</script>
</body>
</html>